import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import time

# 1. –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø
st.set_page_config(page_title="–¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")
st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")

# 2. –ü–ê–†–ê–ú–ï–¢–†–ò –£-–°–Ü–ù
ELEMENTS = ["–î–µ—Ä–µ–≤–æ", "–í–æ–≥–æ–Ω—å", "–ó–µ–º–ª—è", "–ú–µ—Ç–∞–ª", "–í–æ–¥–∞"]

def calculate_wuxing(day, month):
    base_idx = (day + month) % 5
    values = [1.2] * 5
    values[base_idx] = 2.0  # –î–æ–º—ñ–Ω–∞–Ω—Ç–∞ (—Å–∏–ª–∞)
    values[(base_idx + 1) % 5] = 1.6  # –ü—ñ–¥—Ç—Ä–∏–º–∫–∞
    return values

# 3. SIDEBAR (–ë–µ–∑ –≤—ñ–∫—É —Ç–∞ —Å–ø—ñ—Ä–∞–ª—ñ)
with st.sidebar:
    st.header("üìã –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ")
    eye_color = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", [1, 2, 3, 4], 
                             format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])
    G = st.radio("–°—Ç–∞—Ç—å", [1, -1], format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞" if x == 1 else "–ñ—ñ–Ω–æ—á–∞")
    
    st.markdown("---")
    d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 12)
    m = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 5)
    
    st.markdown("---")
    # –ü–ê–†–ê–ú–ï–¢–† –°–û–ù: –í–ø–ª–∏–≤–∞—î –Ω–∞ –≤—ñ–±—Ä–∞—Ü—ñ—é –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —è–¥—Ä–∞
    S = st.slider("–ü–∞—Ä–∞–º–µ—Ç—Ä –°–æ–Ω (–Ø–¥—Ä–æ)", 1, 10, 7)
    
    run_anim = st.checkbox("üåÄ –ñ–∏–≤–∞ –º–∞–Ω–¥–∞–ª–∞", value=True)

# 4. –ì–ï–ù–ï–†–ê–¢–û–† (–Ø–¥—Ä–æ + –ü'—è—Ç–∏–∫—É—Ç–Ω–∏–∫ + –•–≤–∏–ª—ñ)
def generate_mandala(phase=0):
    w_vals = calculate_wuxing(d, m)
    LW = 2.2 # –¢—Ä–æ—Ö–∏ —Ç–æ–≤—Å—Ç—ñ—à—ñ –ª—ñ–Ω—ñ—ó –¥–ª—è –≤–∏—Ä–∞–∑–Ω–æ—Å—Ç—ñ
    cmap = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}[eye_color]
    
    fig, ax = plt.subplots(subplot_kw={'projection': 'polar'}, figsize=(8, 8), facecolor='black')
    ax.set_facecolor('black')
    
    t = np.linspace(0, 2 * np.pi, 500)

    # --- 1. –í–ù–£–¢–†–Ü–®–ù–Ñ –Ø–î–†–û (–°–û–ù) ---
    # –ü—É–ª—å—Å—É—é—á–µ –∫—ñ–ª—å—Ü–µ –≤ —Å–∞–º–æ–º—É —Ü–µ–Ω—Ç—Ä—ñ
    r_sleep = 0.8 + 0.1 * np.sin(S * t + phase * 2.5)
    ax.plot(t, r_sleep, color='white', lw=1.5, ls='--', alpha=0.8)
    ax.fill(t, r_sleep, color=cmap(0.3), alpha=0.1)

    # --- 2. –ü'–Ø–¢–ò–ö–£–¢–ù–ò–ö –£-–°–Ü–ù (–ö–ê–†–ö–ê–°) ---
    # –ß—ñ—Ç–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ 5 —Å—Ç–∏—Ö—ñ–π
    angles = np.linspace(0, 2 * np.pi, 6)
    r_pent = w_vals + [w_vals[0]]
    ax.plot(angles, r_pent, color='white', lw=LW, marker='o', markersize=8)
    ax.fill(angles, r_pent, color=cmap(0.5), alpha=0.25)
    

    # --- 3. –•–í–ò–õ–Ü –ë–Ü–û–†–ò–¢–ú–Ü–í ---
    # –ì–∞—Ä–º–æ–Ω—ñ–π–Ω—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è –Ω–∞–≤–∫–æ–ª–æ —è–¥—Ä–∞
    for i in range(5):
        # –ß–∞—Å—Ç–æ—Ç–∞ –∫–æ–∂–Ω–æ—ó —Ö–≤–∏–ª—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–æ–º–µ—Ä—É —Å—Ç–∏—Ö—ñ—ó
        r_wave = 2.6 + 0.4 * np.sin((i+1)*t + phase)
        ax.plot(t, r_wave, color=cmap(i/5), lw=1.5, alpha=0.6)
    

    # --- 4. –ó–ê–•–ò–°–ù–ê –ú–ï–ñ–ê ---
    p = 0.6 if G == 1 else 1.4
    r_border = 4.2 + 0.4 * (np.abs(np.sin(10 * t)))**p
    ax.plot(t, r_border, color=cmap(0.95), lw=LW)

    ax.set_ylim(0, 5.2)
    ax.set_axis_off()
    return fig

# 5. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["‚ú® –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è", "üìê –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab1:
    placeholder = st.empty()
    if run_anim:
        for i in range(50):
            fig = generate_mandala(phase=i*0.1)
            placeholder.pyplot(fig)
            plt.close(fig)
            time.sleep(0.05)
    else:
        st.pyplot(generate_mandala())

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è")
    
    st.subheader("1. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ —è–¥—Ä–æ (–ü–∞—Ä–∞–º–µ—Ç—Ä –°–æ–Ω)")
    st.write("–°–∏–º–≤–æ–ª—ñ–∑—É—î –±–∞–∑–æ–≤–∏–π –∂–∏—Ç—Ç—î–≤–∏–π —Ä–∏—Ç–º. –ô–æ–≥–æ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å –ø—Ä—è–º–æ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —è–∫–æ—Å—Ç—ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è.")
    st.latex(r"r(\theta) = R_{core} + A \cdot \sin(S \cdot \theta + \phi)")

    st.subheader("2. –ü'—è—Ç–∏–∫—É—Ç–Ω–∏–∫ –£-–°–Ü–ù")
    st.write("–ì–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∏–π –∫–∞—Ä–∫–∞—Å –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ. –ö–æ–∂–Ω–∞ –≤–µ—Ä—à–∏–Ω–∞ ‚Äî —Ü–µ –≤–µ–∫—Ç–æ—Ä —Å–∏–ª–∏ –æ–¥–Ω—ñ—î—ó –∑ –ø'—è—Ç–∏ —Å—Ç–∏—Ö—ñ–π.")
    st.write("- **–î–µ—Ä–µ–≤–æ, –í–æ–≥–æ–Ω—å, –ó–µ–º–ª—è, –ú–µ—Ç–∞–ª, –í–æ–¥–∞** ‚Äî –∑'—î–¥–Ω–∞–Ω—ñ –ø—Ä—è–º–∏–º–∏ –ª—ñ–Ω—ñ—è–º–∏, —â–æ —É—Ç–≤–æ—Ä—é—é—Ç—å –∑–∞–º–∫–Ω–µ–Ω–∏–π —Ü–∏–∫–ª –µ–Ω–µ—Ä–≥—ñ—ó.")

    st.subheader("3. –•–≤–∏–ª—ñ –ë—ñ–æ—Ä–∏—Ç–º—ñ–≤")
    st.write("–°—É–ø–µ—Ä–ø–æ–∑–∏—Ü—ñ—è –ø'—è—Ç–∏ –≥–∞—Ä–º–æ–Ω—ñ–π–Ω–∏—Ö —Ö–≤–∏–ª—å. –í–æ–Ω–∏ –ø–æ–∫–∞–∑—É—é—Ç—å –¥–∏–Ω–∞–º—ñ—á–Ω—É –≤–∑–∞—î–º–æ–¥—ñ—é –≤–∞—à–∏—Ö –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö —Å—Ç–∞–Ω—ñ–≤.")
    st.latex(r"r_i = R_{wave} + A \cdot \sin(\omega_i t + \phi)")

    st.subheader("4. –ó–∞—Ö–∏—Å–Ω–∞ –º–µ–∂–∞")
    st.write("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ —Ñ–æ—Ä–º–∞ (–ï–ø—ñ—Ü–∏–∫–ª–æ—ó–¥–∞), —è–∫–∞ –∑–∞—Ö–∏—â–∞—î –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –ø—Ä–æ—Å—Ç—ñ—Ä –º–∞–Ω–¥–∞–ª–∏.")
    st.write(f"–î–ª—è –≤–∞—à–æ—ó —Å—Ç–∞—Ç—ñ –æ–±—Ä–∞–Ω–æ –ø–æ–∫–∞–∑–Ω–∏–∫ –∫—Ä–∏–≤–∏–∑–Ω–∏ $p = {0.6 if G==1 else 1.4}$.")
