import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")

st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö")
st.markdown("---")

# 2. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä", "üìú –ù–∞—É–∫–æ–≤–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –º–æ–¥–µ–ª—å")
    st.write("–ü—Ä–æ—Å—Ç—ñ—Ä –Ω–æ—Ä–º–æ–≤–∞–Ω–æ –¥–æ –æ–¥–∏–Ω–∏—á–Ω–æ–≥–æ —Ä–∞–¥—ñ—É—Å–∞ ($R \\approx 1.2$). –í—Å—ñ –º–∞–Ω–¥–∞–ª–∏ –º–∞—é—Ç—å –æ–¥–Ω–∞–∫–æ–≤–∏–π –≥–∞–±–∞—Ä–∏—Ç.")

    st.subheader("1. –¢–æ–ø–æ–ª–æ–≥—ñ—è –Ø–¥—Ä–∞ (–°–æ–Ω)")
    st.write("–¶–µ–Ω—Ç—Ä –º–∞–Ω–¥–∞–ª–∏ ‚Äî –∫—ñ–ª—å—Ü–µ. –ô–æ–≥–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ä–∞–¥—ñ—É—Å $r_{hole}$ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –¥–µ—Ñ—ñ—Ü–∏—Ç—É —Å–Ω—É:")
    st.latex(r"r_{hole} = R_{core} \cdot \left(1 - \frac{S}{12}\right)")
    st.write("–Ø–∫—â–æ —Å–Ω—É –¥–æ—Å—Ç–∞—Ç–Ω—å–æ ($S \ge 12$), $r_{hole} \to 0$ (—Å—É—Ü—ñ–ª—å–Ω–∏–π –¥–∏—Å–∫).")

    st.subheader("2. –ì–∞—Ä–º–æ–Ω—ñ—á–Ω–∏–π –∫–æ–Ω—Ç—É—Ä (–ó—Ä—ñ—Å—Ç - –ï–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∞)")
    st.write("–ó—Ä—ñ—Å—Ç ($H$) –≤–∏–∑–Ω–∞—á–∞—î —á–∞—Å—Ç–æ—Ç—É –≥–∞—Ä–º–æ–Ω—ñ—á–Ω–∏—Ö –∫–æ–ª–∏–≤–∞–Ω—å –ø—Ä–æ–º—ñ–∂–Ω–æ–≥–æ —à–∞—Ä—É (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω –∑—ñ—Ä–∫–∏). –¶–µ —Å—Ç–≤–æ—Ä—é—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π '–≤—ñ–¥–±–∏—Ç–æ–∫' –∫–∞—Ä–∫–∞—Å–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ.")
    st.latex(r"r_{epi}(\theta) = R_{mid} + 0.1 \cdot \cos\left( \frac{H}{10} \cdot \theta \right)")
    st.write("–í–∏—â—ñ –ª—é–¥–∏ –º–∞—é—Ç—å –±—ñ–ª—å—à –≤–∏—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–±—ñ–ª—å—à–µ –≤–µ—Ä—à–∏–Ω).")

    st.subheader("3. –°–ø—ñ—Ä–∞–ª—ñ —Ä–æ–∑–≤–∏—Ç–∫—É (–í—ñ–∫ —Ç–∞ –ï–Ω–µ—Ä–≥—ñ—è)")
    st.write("–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ä—ñ–≤–Ω—è–Ω–Ω—è –ê—Ä—Ö—ñ–º–µ–¥–æ–≤–æ—ó —Å–ø—ñ—Ä–∞–ª—ñ –∑ —Å–∏–º–µ—Ç—Ä—ñ—î—é –æ–±–µ—Ä—Ç–∞–Ω–Ω—è:")
    st.latex(r"r = a + b \cdot \theta")
    st.write("–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—É–∫–∞–≤—ñ–≤ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ **–í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ**, –¥–æ–≤–∂–∏–Ω–∞ —Ä—É–∫–∞–≤—ñ–≤ ‚Äî –≤—ñ–¥ **–í—ñ–∫—É**, –∫—É—Ç –∑–∞–∫—Ä—É—á—É–≤–∞–Ω–Ω—è ‚Äî –≤—ñ–¥ **–ï–Ω–µ—Ä–≥—ñ—ó**.")

with tab1:
    # –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø
    st.sidebar.header("üìã –í—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏")
    with st.sidebar:
        # –î–∞—Ç–∞
        n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 5)
        d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 15)
        
        # –û—Å–Ω–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
        H = st.slider("–ó—Ä—ñ—Å—Ç (—Å–º) -> –ï–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∞", 100, 220, 170, help="–ó–º—ñ–Ω—é—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω –∑—ñ—Ä–∫–∏.")
        S = st.slider("–ì–æ–¥–∏–Ω —Å–Ω—É -> –¶–µ–Ω—Ç—Ä", 0, 12, 8, help="–ó–º—ñ–Ω—é—î –¥—ñ—Ä–∫—É –≤ —Ü–µ–Ω—Ç—Ä—ñ.")
        A = st.slider("–í—ñ–∫ -> –î–æ–≤–∂–∏–Ω–∞ —Å–ø—ñ—Ä–∞–ª–µ–π", 10, 100, 30)
        
        st.markdown("---")
        # –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è
        E = st.slider("–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å", 1, 10, 6, help="–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—É–∫–∞–≤—ñ–≤ —Å–ø—ñ—Ä–∞–ª—ñ.")
        T = st.slider("–ï–Ω–µ—Ä–≥—ñ—è", 1, 10, 5, help="–°–∏–ª–∞ –∑–∞–∫—Ä—É—á—É–≤–∞–Ω–Ω—è.")
        
        st.markdown("---")
        # –°—Ç–∏–ª—å
        G = st.radio("–°—Ç–∞—Ç—å", [1, -1], format_func=lambda x: "–ß–æ–ª." if x==1 else "–ñ—ñ–Ω.")
        temp = st.selectbox("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç", ["–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫", "–•–æ–ª–µ—Ä–∏–∫", "–§–ª–µ–≥–º–∞—Ç–∏–∫", "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫"])
        eye_choice = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", [1, 2, 3, 4], 
                                  format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])

    # –ì–ï–ù–ï–†–ê–¶–Ü–Ø
    def generate_mandala():
        # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–∏–ª—é
        style_map = {
            "–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫": {"lw": 1.5, "alpha": 0.8},
            "–•–æ–ª–µ—Ä–∏–∫":   {"lw": 2.5, "alpha": 0.9},
            "–§–ª–µ–≥–º–∞—Ç–∏–∫": {"lw": 3.0, "alpha": 0.5},
            "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫": {"lw": 1.0, "alpha": 0.7}
        }
        s = style_map[temp]
        
        color_maps = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}
        selected_cmap = color_maps.get(eye_choice, cm.viridis)
        
        # –¢–æ—á–æ–∫ –ø–æ–±—ñ–ª—å—à–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ
        t = np.linspace(0, 20 * np.pi, 4000)
        
        fig = plt.figure(figsize=(6, 6), facecolor='black')
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        # === 1. –Ø–î–†–û (–°–û–ù) ===
        R_core_max = 0.3
        # –õ–æ–≥—ñ–∫–∞ –¥—ñ—Ä–∫–∏: S=12 -> hole=0. S=0 -> hole=R_core_max
        hole_r = R_core_max * (1 - (S / 12.0))
        hole_r = max(0.0, hole_r) # –ë–µ–∑ –≤—ñ–¥'—î–º–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å
        
        # –ú–∞–ª—é—î–º–æ –∫–æ–ª–æ
        t_circle = np.linspace(0, 2*np.pi, 500)
        ax.fill_between(t_circle, hole_r, R_core_max, color=selected_cmap(0.9), alpha=0.8)
        
        # === 2. –ï–ü–Ü–¢–†–û–•–û–á–î–ê (–ó–†–Ü–°–¢) ===
        # –¶–µ "–∑—ñ—Ä–∫–∞" –Ω–∞–≤–∫–æ–ª–æ —è–¥—Ä–∞.
        # –ß–∞—Å—Ç–æ—Ç–∞ k –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∑—Ä–æ—Å—Ç—É.
        k = int(H / 10) # –ù–∞–ø—Ä–∏–∫–ª–∞–¥, 170—Å–º -> 17 –≤–µ—Ä—à–∏–Ω
        R_epi_base = 0.5
        
        # –§–æ—Ä–º—É–ª–∞ –µ–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∏ (—Å–ø—Ä–æ—â–µ–Ω–∞ –¥–æ –∫–æ—Å–∏–Ω—É—Å–æ—ó–¥–∏ –¥–ª—è —á—ñ—Ç–∫–æ—Å—Ç—ñ "–∑—ñ—Ä–∫–∏")
        r_epi = R_epi_base + 0.1 * np.cos(k * t_circle)
        
        # –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é
        ax.plot(t_circle, r_epi, color=selected_cmap(0.5), linewidth=s["lw"], label='–ó—Ä—ñ—Å—Ç')
        # –õ–µ–≥–∫–∞ –∑–∞–ª–∏–≤–∫–∞
        ax.fill(t_circle, r_epi, color=selected_cmap(0.2), alpha=0.2)

        # === 3. –ü–ï–õ–Æ–°–¢–ö–ò (–ú–Ü–°–Ø–¶–¨ n) ===
        # –ú—ñ–∂ —è–¥—Ä–æ–º —Ç–∞ –µ–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–æ—é
        # –ü–æ–∫–∞–∑–Ω–∏–∫ —Å—Ç–µ–ø–µ–Ω—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –¥–Ω—è (—Ç—Ä–æ—Ö–∏ –≤–∞—Ä—ñ–∞—Ç–∏–≤–Ω–æ—Å—Ç—ñ)
        r_petal = R_core_max + (np.abs(np.cos(n/2 * t_circle))) * 0.25
        ax.plot(t_circle, r_petal, color='white', linewidth=0.5, alpha=0.5)

        # === 4. –°–ü–Ü–†–ê–õ–Ü (–í–Ü–ö A, –ï–ù–ï–†–ì–Ü–Ø T, –í–ü–ï–í–ù–ï–ù–Ü–°–¢–¨ E) ===
        # –°–∏–º–µ—Ç—Ä–∏—á–Ω—ñ —Ä—É–∫–∞–≤–∏!
        num_arms = max(3, int(E * 1.5)) # –í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å –¥–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—É–∫–∞–≤—ñ–≤
        
        max_spiral_r = 0.0 # –î–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º–µ–∂—ñ
        
        for i in range(num_arms):
            # –ö—É—Ç –∑—Å—É–≤—É —Ä—É–∫–∞–≤–∞
            angle_shift = (2 * np.pi / num_arms) * i
            
            # –î–æ–≤–∂–∏–Ω–∞ —Å–ø—ñ—Ä–∞–ª—ñ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –í–Ü–ö–£
            len_factor = A / 20.0 
            t_sp = np.linspace(0, len_factor * np.pi, 200)
            
            # –ó–∞–∫—Ä—É—á—É–≤–∞–Ω–Ω—è –≤—ñ–¥ –ï–Ω–µ—Ä–≥—ñ—ó
            twist = G * (T / 5.0) # G - –Ω–∞–ø—Ä—è–º–æ–∫
            
            # –†—ñ–≤–Ω—è–Ω–Ω—è: r —Ä–æ—Å—Ç–µ –≤—ñ–¥ –µ–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∏ –Ω–∞–∑–æ–≤–Ω—ñ
            # r = start + grow * theta
            r_sp = (R_epi_base + 0.1) + 0.15 * t_sp
            
            theta_sp = t_sp * twist + angle_shift
            
            ax.plot(theta_sp, r_sp, color=selected_cmap(0.7), linewidth=s["lw"]*0.7, alpha=0.7)
            
            # –ó–∞–ø–∞–º'—è—Ç–æ–≤—É—î–º–æ –º–∞–∫—Å —Ä–∞–¥—ñ—É—Å –¥–ª—è –º–µ–∂—ñ
            if len(r_sp) > 0:
                max_spiral_r = max(max_spiral_r, np.max(r_sp))

        # === 5. –ú–ï–ñ–ê (–ë–û–†–î–ï–†) ===
        # –í–æ–Ω–∞ –ø–æ–≤–∏–Ω–Ω–∞ –æ—Ö–æ–ø–ª—é–≤–∞—Ç–∏ —Å–ø—ñ—Ä–∞–ª—ñ.
        # –Ø–∫—â–æ —Å–ø—ñ—Ä–∞–ª—ñ –∫–æ—Ä–æ—Ç–∫—ñ (–º–æ–ª–æ–¥–∏–π –≤—ñ–∫), –º–µ–∂–∞ –≤—Å–µ –æ–¥–Ω–æ –º–∞—î –±—É—Ç–∏ –Ω–∞ –ø–µ–≤–Ω–æ–º—É —Ä—ñ–≤–Ω—ñ
        r_border_base = max(0.9, max_spiral_r + 0.1)
        
        # –ú–æ–¥—É–ª—è—Ü—ñ—è –º–µ–∂—ñ –¥–Ω–µ–º –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è
        mod_border = (np.abs(np.sin(d * t_circle)))**0.5 * 0.05
        r_border = r_border_base + mod_border
        
        ax.plot(t_circle, r_border, color=selected_cmap(1.0), linewidth=s["lw"]*1.5)
        
        # –§–Ü–ö–°–ê–¶–Ü–Ø
        ax.set_ylim(0, 1.35) # –¢—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ –∑–∞ 1.0, —â–æ–± –≤—Å–µ –≤–ª—ñ–∑–ª–æ
        ax.set_axis_off()
        
        return fig

    # –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø
    col1, col2 = st.columns([1, 2])
    with col2:
        fig = generate_mandala()
        st.pyplot(fig)
        
        buf = io.BytesIO()
        fig.savefig(buf, format="png", facecolor='black', dpi=300)
        st.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏", buf.getvalue(), "mandala.png", "image/png")
