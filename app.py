import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –û—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ 2.0", layout="wide")

st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ: Topology Edition")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –±—ñ–æ–º–µ—Ç—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö")
st.markdown("---")

# 2. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä", "üìú –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –ª–æ–≥—ñ–∫–∞"])

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è")
    st.write("""
    –£ —Ü—ñ–π –º–æ–¥–µ–ª—ñ –ø—Ä–æ—Å—Ç—ñ—Ä –Ω–æ—Ä–º–æ–≤–∞–Ω–æ –¥–æ –æ–¥–∏–Ω–∏—á–Ω–æ–≥–æ –∫–æ–ª–∞ $R \in [0, 1]$. 
    –¶–µ –¥–æ–∑–≤–æ–ª—è—î –ø–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç–µ–π –±–µ–∑ —Å–ø–æ—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Å—à—Ç–∞–±—É.
    """)
    
    st.subheader("1. –¢–æ–ø–æ–ª–æ–≥—ñ—è –°–Ω—É (Resource Core)")
    st.write("–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ —è–¥—Ä–æ –ø–æ–∫–∞–∑—É—î –Ω–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å –µ–Ω–µ—Ä–≥—ñ—î—é. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –ª–æ–≥—ñ–∫—É —ñ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–æ–≥–æ —Ä–∞–¥—ñ—É—Å–∞ –æ—Ç–≤–æ—Ä—É:")
    st.latex(r"R_{hole} = R_{core} \cdot \left(1 - \frac{Sleep}{Sleep_{max}}\right)")
    st.write("–Ø–∫—â–æ —Å–æ–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π ‚Äî –æ—Ç–≤—ñ—Ä –∑–Ω–∏–∫–∞—î (—Å—É—Ü—ñ–ª—å–Ω–µ –∫–æ–ª–æ). –Ø–∫—â–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π ‚Äî –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ª–∏—à–µ —Ç–æ–Ω–∫–∞ –æ–±–æ–ª–æ–Ω–∫–∞.")

    st.subheader("2. –ó—Ä—ñ—Å—Ç —è–∫ –ß–∞—Å—Ç–æ—Ç–∞ (Harmonic Background)")
    st.write("–ó—Ä—ñ—Å—Ç ($H$) –±—ñ–ª—å—à–µ –Ω–µ –∑–º—ñ–Ω—é—î —Ä–æ–∑–º—ñ—Ä, –∞ –≤–∏–∑–Ω–∞—á–∞—î —á–∞—Å—Ç–æ—Ç—É —Ñ–æ–Ω–æ–≤–∏—Ö –≥–∞—Ä–º–æ–Ω—ñ—á–Ω–∏—Ö –∫–æ–ª–∏–≤–∞–Ω—å (—Ö–≤–∏–ª—å –õ—ñ—Å—Å–∞–∂—É):")
    st.latex(r"r(\theta) = A \cdot \sin(k \cdot \theta), \quad \text{–¥–µ } k \propto H")
    st.write("–í–∏—â—ñ –ª—é–¥–∏ —Å—Ç–≤–æ—Ä—é—é—Ç—å –±—ñ–ª—å—à –≤–∏—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω–∏–π, —â—ñ–ª—å–Ω–∏–π –≤—ñ–∑–µ—Ä—É–Ω–æ–∫ ('—Å—Ç—Ä—É–Ω–∏' –Ω–∞—Ç—è–≥–Ω—É—Ç—ñ —Å–∏–ª—å–Ω—ñ—à–µ).")

with tab1:
    # --- –°–ê–ô–î–ë–ê–† ---
    st.sidebar.header("–í—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏")
    
    # 1. –°–æ–Ω (–¢–æ–ø–æ–ª–æ–≥—ñ—è —Ü–µ–Ω—Ç—Ä—É)
    S = st.sidebar.slider("üò¥ –ì–æ–¥–∏–Ω —Å–Ω—É (–ù–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å)", 0, 12, 7, help="–í–ø–ª–∏–≤–∞—î –Ω–∞ –¥—ñ—Ä–∫—É –≤ —Ü–µ–Ω—Ç—Ä—ñ. 12 –≥–æ–¥–∏–Ω = —Å—É—Ü—ñ–ª—å–Ω–µ –∫–æ–ª–æ.")
    
    # 2. –ó—Ä—ñ—Å—Ç (–ß–∞—Å—Ç–æ—Ç–∞ –ª—ñ–Ω—ñ–π)
    H = st.sidebar.slider("üìè –ó—Ä—ñ—Å—Ç (—Å–º) (–©—ñ–ª—å–Ω—ñ—Å—Ç—å –≤—ñ–∑–µ—Ä—É–Ω–∫—É)", 140, 210, 170, help="–í–∏–∑–Ω–∞—á–∞—î —á–∞—Å—Ç–æ—Ç—É –ª—ñ–Ω—ñ–π –Ω–∞ —Ñ–æ–Ω—ñ.")
    
    # 3. –î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–°–∏–º–µ—Ç—Ä—ñ—è)
    n = st.sidebar.number_input("üìÖ –ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–°–∏–º–µ—Ç—Ä—ñ—è)", 1, 12, 5)
    d = st.sidebar.number_input("üìÖ –î–µ–Ω—å (–§–∞–∑–æ–≤–∏–π –∑—Å—É–≤)", 1, 31, 15)
    
    # 4. –•–∞—Ä–∞–∫—Ç–µ—Ä
    E = st.sidebar.slider("üî• –ï–Ω–µ—Ä–≥—ñ—è/–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å", 1, 10, 6, help="–†–æ–±–∏—Ç—å –ª—ñ–Ω—ñ—ó –≥–æ—Å—Ç—Ä—ñ—à–∏–º–∏.")
    
    # 5. –í—ñ–∫ (–°–ø—ñ—Ä–∞–ª—ñ)
    A = st.sidebar.slider("‚è≥ –í—ñ–∫ (–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏—Ç–∫—ñ–≤)", 10, 80, 17)
    
    # 6. –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è
    palette_name = st.sidebar.selectbox("–ö–æ–ª—ñ—Ä–Ω–∞ —Å—Ö–µ–º–∞", ["magma", "viridis", "plasma", "inferno", "twilight", "ocean"])

    # --- –§–£–ù–ö–¶–Ü–Ø –ì–ï–ù–ï–†–ê–¶–Ü–á ---
    def generate_mandala_v2():
        # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–≥—É—Ä–∏
        fig = plt.figure(figsize=(8, 8), facecolor='#0e1117') # –¢–µ–º–Ω–∏–π —Ñ–æ–Ω –ø—ñ–¥ —Ç–µ–º—É Streamlit
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('#0e1117')
        
        # –û—Å–Ω–æ–≤–Ω–∏–π –≤–µ–∫—Ç–æ—Ä –∫—É—Ç—ñ–≤ (–≤–∏—Å–æ–∫–∞ —Ä–æ–∑–¥—ñ–ª—å–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å –¥–ª—è –≥–ª–∞–¥–∫–æ—Å—Ç—ñ)
        t = np.linspace(0, 20 * np.pi, 5000) 
        
        # –í–∏–±—ñ—Ä –ø–∞–ª—ñ—Ç—Ä–∏
        cmap = plt.get_cmap(palette_name)
        
        # ==========================================
        # –®–ê–† 1: –§–û–ù–û–í–ê –°–Ü–¢–ö–ê (–ó–†–Ü–°–¢ H)
        # ==========================================
        # –õ–æ–≥—ñ–∫–∞: –ó—Ä—ñ—Å—Ç –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –Ω–∞ "–ß–∞—Å—Ç–æ—Ç—É" (Frequency). 
        # –í–∏—Å–æ–∫–∞ –ª—é–¥–∏–Ω–∞ = –≤–∏—Å–æ–∫–∞ —á–∞—Å—Ç–æ—Ç–∞ = –±–∞–≥–∞—Ç–æ –ø–µ—Ä–µ—Ç–∏–Ω—ñ–≤ –ª—ñ–Ω—ñ–π.
        freq_h = H / 20.0  # –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç —á–∞—Å—Ç–æ—Ç–∏
        
        # –ö—Ä–∏–≤–∞ –õ—ñ—Å—Å–∞–∂—É –∞–±–æ –°–ø—ñ—Ä–æ–≥—Ä–∞—Ñ
        # r = 0.9 (–º–∞–∫—Å —Ä–∞–¥—ñ—É—Å) + –º–æ–¥—É–ª—è—Ü—ñ—è
        # –ú–∏ –º–∞–ª—é—î–º–æ –±–∞–≥–∞—Ç–æ —Ç–æ–Ω–∫–∏—Ö –ª—ñ–Ω—ñ–π, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ "—Ç–µ–∫—Å—Ç—É—Ä—É"
        r_background = 0.5 + 0.4 * np.sin(freq_h * t / 5) * np.cos((n/2)*t)
        
        ax.plot(t, r_background, color=cmap(0.1), alpha=0.15, linewidth=0.5)
        
        # ==========================================
        # –®–ê–† 2: –°–ü–Ü–†–ê–õ–Ü –ñ–ò–¢–¢–Ø (–í–Ü–ö A + –ï–ù–ï–†–ì–Ü–Ø E)
        # ==========================================
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ª–æ–≥–∞—Ä–∏—Ñ–º—ñ—á–Ω—É —Å–ø—ñ—Ä–∞–ª—å –∞–±–æ –ê—Ä—Ö—ñ–º–µ–¥–æ–≤—É
        # –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—É–∫–∞–≤—ñ–≤ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ E (–í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ)
        num_arms = max(3, int(E * 1.5))
        
        for i in range(num_arms):
            # –ó—Å—É–≤ —Ñ–∞–∑–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—É–∫–∞–≤–∞
            phase = (2 * np.pi / num_arms) * i
            
            # –†—ñ–≤–Ω—è–Ω–Ω—è —Å–ø—ñ—Ä–∞–ª—ñ: r = a + b * theta
            # –û–±–º–µ–∂—É—î–º–æ –¥–æ–≤–∂–∏–Ω—É —Å–ø—ñ—Ä–∞–ª—ñ –≤—ñ–∫–æ–º (A)
            t_spiral = np.linspace(0, A/3, 500) 
            
            # –§–æ—Ä–º—É–ª–∞, —â–æ –∑–∞–∫—Ä—É—á—É—î –ª—ñ–Ω—ñ—é
            r_spiral = 0.2 + 0.05 * t_spiral 
            
            # –î–æ–¥–∞—î–º–æ "—Ç—Ä–µ–º—Ç—ñ–Ω–Ω—è" –ª—ñ–Ω—ñ—ó –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –ï–Ω–µ—Ä–≥—ñ—ó (E) - –≥–æ—Å—Ç—Ä–æ—Ç–∞
            wobble = 0.02 * E * np.sin(10 * t_spiral)
            
            # –ú–∞–ª—é—î–º–æ
            ax.plot(t_spiral + phase, r_spiral + wobble, 
                    color=cmap(0.5 + i/num_arms/2), 
                    linewidth=1.5, alpha=0.7)

        # ==========================================
        # –®–ê–† 3: –Ø–î–†–û –°–ù–£ (SLEEP S) - –¢–û–ü–û–õ–û–ì–Ü–Ø
        # ==========================================
        # S_max = 12 –≥–æ–¥–∏–Ω.
        # –†–∞–¥—ñ—É—Å —è–¥—Ä–∞ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 0.25 –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ)
        R_core_outer = 0.25
        
        # –†–∞–¥—ñ—É—Å –¥—ñ—Ä–∫–∏. –Ø–∫—â–æ S=12, –¥—ñ—Ä–∫–∞=0. –Ø–∫—â–æ S=0, –¥—ñ—Ä–∫–∞=R_core_outer
        hole_ratio = 1 - (S / 12.0)
        # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤—ñ–¥'—î–º–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å
        hole_ratio = max(0.0, min(1.0, hole_ratio))
        
        R_hole = R_core_outer * hole_ratio
        
        # –ú–∞–ª—é—î–º–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ –∫—ñ–ª—å—Ü–µ (fill_between)
        # t_ring - –ø—Ä–æ—Å—Ç–æ –æ–¥–Ω–µ –∫–æ–ª–æ
        t_ring = np.linspace(0, 2*np.pi, 200)
        
        # –ì—Ä–∞–¥—ñ—î–Ω—Ç–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —è–¥—Ä–∞
        ax.fill_between(t_ring, R_hole, R_core_outer, 
                        color=cmap(0.9), alpha=0.8, label='–°–æ–Ω')
        
        # –Ø–∫—â–æ –¥—ñ—Ä–∫–∞ –≤–µ–ª–∏–∫–∞ (–º–∞–ª–æ —Å–Ω—É), –¥–æ–¥–∞–º–æ "–Ω–µ—Ä–≤–æ–≤–∏–π" –∫–æ–Ω—Ç—É—Ä –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ
        if R_hole > 0.05:
            ax.plot(t_ring, [R_hole]*len(t_ring), color='white', linestyle='--', linewidth=0.8, alpha=0.5)

        # ==========================================
        # –®–ê–† 4: –ó–û–í–ù–Ü–®–ù–Ø –ö–û–†–û–ù–ê (–î–ê–¢–ê n, d)
        # ==========================================
        # –¶–µ "—à–∫—ñ—Ä–∞" –º–∞–Ω–¥–∞–ª–∏. –í–æ–Ω–∞ –∑–∞–≤–∂–¥–∏ —Ç–æ—Ä–∫–∞—î—Ç—å—Å—è R=1.0 (–∞–±–æ –±–ª–∏–∑—å–∫–æ –¥–æ —Ç–æ–≥–æ)
        # –§–æ—Ä–º–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –º—ñ—Å—è—Ü—è –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (—Å–∏–º–µ—Ç—Ä—ñ—è)
        
        peaks = n # –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω = –º—ñ—Å—è—Ü—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Ç—Ä–∞–≤–µ–Ω—å = 5 –≤–µ—Ä—à–∏–Ω)
        
        # –§–æ—Ä–º—É–ª–∞ —Å—É–ø–µ—Ä-—Ñ–æ—Ä–º–∏ (Superformula simplified)
        r_border = 0.85 + 0.15 * np.cos(peaks * t_ring + d/10)
        
        ax.plot(t_ring, r_border, color=cmap(0.7), linewidth=2.5)
        
        # –ß–∏—Å—Ç–æ –≤—ñ–∑—É–∞–ª—å–Ω–∏–π –µ—Ñ–µ–∫—Ç - –∑'—î–¥–Ω–∞–Ω–Ω—è —Ü–µ–Ω—Ç—Ä—É —ñ –∫—Ä–∞—é –ø—Ä–æ–º–µ–Ω—è–º–∏
        for i in range(peaks):
            angle = (2 * np.pi / peaks) * i
            ax.plot([angle, angle], [R_core_outer, 0.85], 
                    color=cmap(0.3), linestyle=':', linewidth=1, alpha=0.4)

        # ==========================================
        # –§–Ü–ù–ê–õ–Ü–ó–ê–¶–Ü–Ø
        # ==========================================
        ax.set_ylim(0, 1.1) # –§—ñ–∫—Å—É—î–º–æ –º–µ–∂—ñ! –ú–∞—Å—à—Ç–∞–± –∑–∞–≤–∂–¥–∏ –æ–¥–Ω–∞–∫–æ–≤–∏–π.
        ax.set_axis_off() # –•–æ–≤–∞—î–º–æ —Ü–∏—Ñ—Ä–∏ —ñ —Å—ñ—Ç–∫—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        
        return fig

    # –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø
    col1, col2 = st.columns([3, 2])
    
    with col1:
        st.write("#### –†–µ–∑—É–ª—å—Ç–∞—Ç:")
        fig_out = generate_mandala_v2()
        st.pyplot(fig_out)
        
    with col2:
        st.info("""
        **–Ø–∫ —á–∏—Ç–∞—Ç–∏ –º–∞–Ω–¥–∞–ª—É?**
        
        1. **–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ –∫–æ–ª–æ:** –¢–≤—ñ–π —Ä–µ—Å—É—Ä—Å —Å–Ω—É. 
           * –°—É—Ü—ñ–ª—å–Ω–µ = –±–∞–≥–∞—Ç–æ —Å–∏–ª. 
           * –ö—ñ–ª—å—Ü–µ ("–±—É–±–ª–∏–∫") = –Ω–µ–¥–æ—Å–∏–ø.
           
        2. **–§–æ–Ω–æ–≤–∞ –ø–∞–≤—É—Ç–∏–Ω–∞:** –¢–≤—ñ–π –∑—Ä—ñ—Å—Ç.
           * –ì—É—Å—Ç–∞ —Å—ñ—Ç–∫–∞ = –≤–∏—Å–æ–∫–∏–π –∑—Ä—ñ—Å—Ç.
           * –†—ñ–¥–∫–∞ —Å—ñ—Ç–∫–∞ = –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π –∑—Ä—ñ—Å—Ç.
           
        3. **–°–ø—ñ—Ä–∞–ª—ñ:** –¢–≤—ñ–π –∂–∏—Ç—Ç—î–≤–∏–π —à–ª—è—Ö (–≤—ñ–∫).
        """)
        
        # –ö–Ω–æ–ø–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
        buf = io.BytesIO()
        fig_out.savefig(buf, format="png", dpi=300, facecolor='#0e1117', bbox_inches='tight')
        st.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HD Image", buf.getvalue(), "mandala_art.png", "image/png")
