import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io
import time

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò
st.set_page_config(page_title="–£-–°–Ü–ù –ú–∞–Ω–¥–∞–ª–∞", layout="wide")

st.title("üß¨ –°–∏—Å—Ç–µ–º–Ω–∞ –º–∞–Ω–¥–∞–ª–∞ –∑–¥–æ—Ä–æ–≤'—è (–£-–°–Ü–ù)")
st.write("### –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Å–∏—Ö–æ–º–∞—Ç—Ä–∏—Ü—ñ —Ç–∞ –±—ñ–æ—Ä–∏—Ç–º—ñ–≤ —á–µ—Ä–µ–∑ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω—ñ –º–æ–¥–µ–ª—ñ")
st.markdown("---")

# 2. –ú–ê–¢–ï–ú–ê–¢–ò–ß–ù–ò–ô –ë–õ–û–ö (–†–û–ó–†–ê–•–£–ù–û–ö –°–¢–ò–•–Ü–ô)
def calculate_wuxing(day, month, energy_val):
    # –°–ø—Ä–æ—â–µ–Ω–∞ –º–æ–¥–µ–ª—å: —Ä–æ–∑–±–∏–≤–∞—î–º–æ –µ–Ω–µ—Ä–≥—ñ—é –∑–∞ 5 –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏
    # –î–µ—Ä–µ–≤–æ, –í–æ–≥–æ–Ω—å, –ó–µ–º–ª—è, –ú–µ—Ç–∞–ª, –í–æ–¥–∞
    base = (day + month) % 5
    strengths = [1.0] * 5
    for i in range(5):
        # –ú–æ–¥—É–ª—é—î–º–æ —Å–∏–ª–∏ —Å—Ç–∏—Ö—ñ–π –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –≤–≤–µ–¥–µ–Ω–æ—ó "–ï–Ω–µ—Ä–≥—ñ—ó" (T) —Ç–∞ –¥–∞—Ç–∏
        strengths[(base + i) % 5] += (energy_val / 10.0) * np.sin(i)
    return strengths

# 3. –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø (SIDEBAR)
st.sidebar.header("üìã –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ")
with st.sidebar:
    d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 15)
    n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 6)
    year = st.number_input("–†—ñ–∫ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1950, 2026, 1990)
    
    st.markdown("---")
    A = st.slider("–í—ñ–∫", 1, 100, 25)
    T = st.slider("–ï–Ω–µ—Ä–≥—ñ—è (–ü—Å–∏—Ö–æ–º–∞—Ç—Ä–∏—Ü—è)", 1, 10, 5)
    E = st.slider("–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å (–ê–º–ø–ª—ñ—Ç—É–¥–∞)", 1, 10, 5)
    
    st.markdown("---")
    run_anim = st.checkbox("üåÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±—ñ–æ—Ä–∏—Ç–º–∏ (–î–∏–Ω–∞–º—ñ–∫–∞)")

# 4. –§–£–ù–ö–¶–Ü–Ø –ì–ï–ù–ï–†–ê–¶–Ü–á –°–ò–°–¢–ï–ú–ù–û–á –ú–ê–ù–î–ê–õ–ò
def generate_systemic_mandala(phase=0):
    # –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –£-–°–Ü–ù
    w_data = calculate_wuxing(d, n, T)
    
    fig = plt.figure(figsize=(10, 10), facecolor='black')
    ax = plt.subplot(111, projection='polar')
    ax.set_facecolor('black')
    
    t = np.linspace(0, 2 * np.pi, 1000)
    angles = np.linspace(0, 2 * np.pi, 6)
    
    # --- –ö–û–ù–¶–ï–ü–¶–Ü–Ø 1: –†–ê–î–ê–†-–ì–†–ê–§ (–ë–∞–ª–∞–Ω—Å 5 —Å—Ç–∏—Ö—ñ–π) ---
    # –ó–∞–º–∏–∫–∞—î–º–æ –ª—ñ–Ω—ñ—é —Ä–∞–¥–∞—Ä–∞
    values = w_data + [w_data[0]]
    ax.fill(angles, values, color='#FFD700', alpha=0.3, label='–ë–∞–ª–∞–Ω—Å –£-–°–Ü–ù')
    ax.plot(angles, values, color='#FFD700', lw=2, marker='o')

    # --- –ö–û–ù–¶–ï–ü–¶–Ü–Ø 2: –°–ò–ù–£–°–û–á–î–ò –ë–Ü–û–†–ò–¢–ú–Ü–í ---
    # –ö–æ–∂–Ω–∞ —Å—Ç–∏—Ö—ñ—è –º–∞—î —Å–≤–æ—é —Ö–≤–∏–ª—é y(t) = A*sin(wt + phi)
    for i, strength in enumerate(w_data):
        omega = (i + 1) * 0.5
        phi = phase + (i * np.pi / 2.5)
        # –ê–º–ø–ª—ñ—Ç—É–¥–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å–∏–ª–∏ —Å—Ç–∏—Ö—ñ—ó, —Ñ–∞–∑–∞ –≤—ñ–¥ –¥–∞—Ç–∏
        r_wave = 2.0 + (0.3 * np.sin(omega * t + phi) * (E / 5))
        ax.plot(t, np.full_like(t, r_wave), alpha=0.4, color=cm.spring(i/5), lw=1)

    # --- –ö–û–ù–¶–ï–ü–¶–Ü–Ø 3: –°–ü–Ü–†–ê–õ–¨ –§–Ü–ë–û–ù–ê–ß–ß–Ü (–í–µ–∫—Ç–æ—Ä —Ä–æ–∑–≤–∏—Ç–∫—É) ---
    phi_const = (1 + 5**0.5) / 2 # –ó–æ–ª–æ—Ç–∏–π –ø–µ—Ä–µ—Ç–∏–Ω
    # b –≤–∏–∑–Ω–∞—á–∞—î "–∫—Ä–æ–∫" —Å–ø—ñ—Ä–∞–ª—ñ
    b_growth = np.log(phi_const) / (np.pi / 2)
    
    # –ú–∞–ª—é—î–º–æ —Ç–æ—á–∫–∏ —Ä–æ–∑–≤–∏—Ç–∫—É (–≤—ñ–∫)
    indices = np.arange(1, A + 1)
    theta_fib = indices * 0.5 + phase * 0.1
    r_fib = 0.2 * np.exp(b_growth * theta_fib * 0.1)
    ax.scatter(theta_fib, r_fib, s=T*10, c=indices, cmap='winter', alpha=0.7)

    # --- –ö–û–ù–¶–ï–ü–¶–Ü–Ø 4: –§–†–ê–ö–¢–ê–õ–¨–ù–ê –ú–ï–ñ–ê ---
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–æ–¥—É–ª—è—Ü—ñ—é –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó —Å–∞–º–æ–ø–æ–¥—ñ–±–Ω–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä
    r_border = 4.0 + 0.2 * np.cos(10 * t) * np.sin(phase)
    ax.plot(t, r_border, color='white', lw=0.5, alpha=0.5)

    ax.set_ylim(0, 5)
    ax.set_axis_off()
    return fig

# 5. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –£-–°–Ü–ù", "üìú –¢–µ–æ—Ä—ñ—è —Å–∏—Å—Ç–µ–º–∏"])

with tab1:
    col1, col2 = st.columns([1, 2])
    with col1:
        st.write("#### –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å")
        w_vals = calculate_wuxing(d, n, T)
        st.info(f"–ù–∞–π—Å–∏–ª—å–Ω—ñ—à–∏–π –µ–ª–µ–º–µ–Ω—Ç: {['–î–µ—Ä–µ–≤–æ', '–í–æ–≥–æ–Ω—å', '–ó–µ–º–ª—è', '–ú–µ—Ç–∞–ª', '–í–æ–¥–∞'][np.argmax(w_vals)]}")
        
        # –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á—É–≤–∞–Ω–Ω—è
        fig_static = generate_systemic_mandala(phase=0)
        buf = io.BytesIO()
        fig_static.savefig(buf, format="png", facecolor='black', dpi=300)
        st.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ä—Ç—É –∑–¥–æ—Ä–æ–≤'—è", buf.getvalue(), "wuxing.png", "image/png")

    with col2:
        placeholder = st.empty()
        if run_anim:
            for i in range(200):
                fig = generate_systemic_mandala(phase=i * 0.1)
                placeholder.pyplot(fig)
                plt.close(fig)
                time.sleep(0.05)
        else:
            fig = generate_systemic_mandala(phase=0)
            placeholder.pyplot(fig)

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó")
    
    st.subheader("1. –†–∞–¥–∞—Ä-–≥—Ä–∞—Ñ (–ü–æ–ª—è—Ä–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏)")
    st.write("–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –ø'—è—Ç–∏–∫—É—Ç–Ω–∏–∫ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –±–∞–ª–∞–Ω—Å –µ–Ω–µ—Ä–≥—ñ–π. –°–∏–º–µ—Ç—Ä—ñ—è —Ñ—ñ–≥—É—Ä–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ –æ–∑–Ω–∞—á–∞—î —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Å–∏—Å—Ç–µ–º–∏.")
    
    st.subheader("2. –ë—ñ–æ—Ä–∏—Ç–º–∏ (–°—É–ø–µ—Ä–ø–æ–∑–∏—Ü—ñ—è —Ö–≤–∏–ª—å)")
    st.write("–ö–æ–∂–Ω–∞ —Å—Ç–∏—Ö—ñ—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≥–∞—Ä–º–æ–Ω—ñ—á–Ω–∏–º –∫–æ–ª–∏–≤–∞–Ω–Ω—è–º:")
    st.latex(r"y(t) = A \cdot \sin(\omega t + \phi)")
    st.write("–î–µ –∞–º–ø–ª—ñ—Ç—É–¥–∞ $A$ ‚Äî —Ü–µ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ü–∏—Ñ—Ä —É –º–∞—Ç—Ä–∏—Ü—ñ, –∞ —Ñ–∞–∑–∞ $\phi$ ‚Äî –º–æ–º–µ–Ω—Ç –≤–∞—à–æ–≥–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è.")

    st.subheader("3. –°–ø—ñ—Ä–∞–ª—å –§—ñ–±–æ–Ω–∞—á—á—ñ")
    st.write("–†–æ–∑–≤–∏—Ç–æ–∫ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ –º–æ–¥–µ–ª—é—î—Ç—å—Å—è –ª–æ–≥–∞—Ä–∏—Ñ–º—ñ—á–Ω–æ—é —Å–ø—ñ—Ä–∞–ª–ª—é –∑–æ–ª–æ—Ç–æ–≥–æ –ø–µ—Ä–µ—Ç–∏–Ω—É:")
    st.latex(r"r = a \cdot e^{b\theta}")
    
    st.subheader("4. –§—Ä–∞–∫—Ç–∞–ª—å–Ω—ñ—Å—Ç—å")
    st.write("–ó–æ–≤–Ω—ñ—à–Ω—è –º–µ–∂–∞ –∑–º—ñ–Ω—é—î —Å–≤–æ—é —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å, –ø–æ–∫–∞–∑—É—é—á–∏, —è–∫ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Å—Ç–∞–Ω (–º—ñ–∫—Ä–æ—Ä—ñ–≤–µ–Ω—å) –ø—Ä–æ–µ–∫—Ç—É—î—Ç—å—Å—è –Ω–∞ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π —Å–≤—ñ—Ç (–º–∞–∫—Ä–æ—Ä—ñ–≤–µ–Ω—å).")
