import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")

st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ-–º–∏—Å—Ç–µ—Ü—å–∫–∏–π –ø—Ä–æ—î–∫—Ç. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö")
st.markdown("---")

# 2. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω–¥–∞–ª–∏", "üìú –ù–∞—É–∫–æ–≤–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è –º–æ–¥–µ–ª—ñ (–û–Ω–æ–≤–ª–µ–Ω–∞)")
    st.write("""
    –ü—Ä–æ—î–∫—Ç –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –ø–æ–±—É–¥–æ–≤—ñ –±–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤–æ—ó –≥—Ä–∞—Ñ—ñ—á–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –≤ –ø–æ–ª—è—Ä–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö $(r, \\theta)$. 
    **–í–∞–∂–ª–∏–≤–æ:** –ü—Ä–æ—Å—Ç—ñ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ç–µ–ø–µ—Ä —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ. –ó—Ä—ñ—Å—Ç –Ω–µ –∑–º—ñ–Ω—é—î —Ä–æ–∑–º—ñ—Ä –º–∞–ª—é–Ω–∫–∞, –∞ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∫—Ä–∏–≤–∏—Ö.
    """)

    # --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ï –ö–Ü–õ–¨–¶–ï ---
    st.subheader("1. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ –∫—ñ–ª—å—Ü–µ (–†–µ—Å—É—Ä—Å –°–Ω—É)")
    st.write("–ë–∞–∑–æ–≤–∞ –æ–ø–æ—Ä–∞. –ó–æ–≤–Ω—ñ—à–Ω—ñ–π —Ä–∞–¥—ñ—É—Å —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π ($R_{fixed}=0.5$). –ü–æ–∫–∞–∑–Ω–∏–∫ —Å–Ω—É ($S$) –≤–∏–∑–Ω–∞—á–∞—î –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ä–∞–¥—ñ—É—Å –æ—Ç–≤–æ—Ä—É:")
    st.latex(r"r_{hole} = R_{fixed} \cdot \left(1 - \frac{S}{15}\right)")
    st.write("–ü—Ä–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —Å–Ω—ñ –æ—Ç–≤—ñ—Ä –∑–Ω–∏–∫–∞—î (—Å—É—Ü—ñ–ª—å–Ω–µ –∫–æ–ª–æ). –ü—Ä–∏ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–º—É ‚Äî –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ç–æ–Ω–∫–∞ –æ–±–æ–ª–æ–Ω–∫–∞.")

    # --- –ü–ï–õ–Æ–°–¢–ö–ò ---
    st.subheader("2. –®–∞—Ä –ø–µ–ª—é—Å—Ç–æ–∫ (–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å)")
    st.write("–§–æ—Ä–º–∞ –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –º—ñ—Å—è—Ü–µ–º ($n$), –∞ –≥–æ—Å—Ç—Ä–æ—Ç–∞ ‚Äî –í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—é ($E$):")
    st.latex(r"r_{petal} = r_{base} + \left| \cos\left(\frac{n}{2}\theta\right) \right|^p \cdot C")
    st.write("–ü–æ–∫–∞–∑–Ω–∏–∫ —Å—Ç–µ–ø–µ–Ω—è $p$ –∑–º–µ–Ω—à—É—î—Ç—å—Å—è –ø—Ä–∏ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—ñ –í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ, —Ä–æ–±–ª—è—á–∏ –ø–µ–ª—é—Å—Ç–∫–∏ –≥–æ—Å—Ç—Ä—ñ—à–∏–º–∏.")

    # --- –°–ü–Ü–†–ê–õ–Ü ---
    st.subheader("3. –ü–æ–ª–µ —Å–ø—ñ—Ä–∞–ª–µ–π (–í—ñ–∫, –ï–Ω–µ—Ä–≥—ñ—è, –ó—Ä—ñ—Å—Ç)")
    st.write("–ù–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à–∞ —á–∞—Å—Ç–∏–Ω–∞. –¶–µ –Ω–∞–±—ñ—Ä –ª—ñ–Ω—ñ–π, –∫—ñ–ª—å–∫—ñ—Å—Ç—å —è–∫–∏—Ö –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –í—ñ–∫—É ($A$).")
    st.write("**–í–ø–ª–∏–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –Ω–∞ —Ä—ñ–≤–Ω—è–Ω–Ω—è –ª—ñ–Ω—ñ—ó:**")
    st.latex(r"r_{spiral}(\theta) = R_{start} + \underbrace{k \cdot i}_{\text{–ü—Ä–æ–≥—Ä–µ—Å –≤—ñ–∫—É}} + \underbrace{H_{mod} \cdot \sin(d \cdot \theta)}_{\text{–ú–æ–¥—É–ª—è—Ü—ñ—è –ó—Ä–æ—Å—Ç–æ–º}}")
    st.write("""
    * **–ï–Ω–µ—Ä–≥—ñ—è ($T$):** –í–∏–∑–Ω–∞—á–∞—î –∫—É—Ç –∑–∞–∫—Ä—É—á—É–≤–∞–Ω–Ω—è ($\Phi_{rot}$) –∫–æ–∂–Ω–æ–≥–æ —à–∞—Ä—É.
    * **–ó—Ä—ñ—Å—Ç ($H$):** –í–∏–∑–Ω–∞—á–∞—î –∞–º–ø–ª—ñ—Ç—É–¥—É $H_{mod}$. –í–∏—Å–æ–∫—ñ –ª—é–¥–∏ –º–∞—é—Ç—å –±—ñ–ª—å—à "—Ö–≤–∏–ª—è—Å—Ç—ñ", —Ä–æ–∑–º–∞—à–∏—Å—Ç—ñ –ª—ñ–Ω—ñ—ó –∂–∏—Ç—Ç—î–≤–æ–≥–æ —à–ª—è—Ö—É.
    """)

    # --- –ö–û–†–û–ù–ê ---
    st.subheader("4. –ó–æ–≤–Ω—ñ—à–Ω—è –º–µ–∂–∞")
    st.write("–ó–∞–≤–µ—Ä—à—É—î –∫–æ–º–ø–æ–∑–∏—Ü—ñ—é, —Ñ–æ—Ä–º–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –°—Ç–∞—Ç—ñ —Ç–∞ –î–Ω—è –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è.")

with tab1:
    # –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø
    st.sidebar.header("üìã –¢–≤–æ—ó –¥–∞–Ω—ñ")
    with st.sidebar:
        n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 6)
        d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 15)
        # H - —Ç–µ–ø–µ—Ä –≤–ø–ª–∏–≤–∞—î –Ω–∞ —Ö–≤–∏–ª—è—Å—Ç—ñ—Å—Ç—å, –∞ –Ω–µ —Ä–æ–∑–º—ñ—Ä
        H = st.slider("–ó—Ä—ñ—Å—Ç (—Å–º)", 100, 220, 170, help="–í–ø–ª–∏–≤–∞—î –Ω–∞ –∞–º–ø–ª—ñ—Ç—É–¥—É (—Ä–æ–∑–º–∞—à–∏—Å—Ç—ñ—Å—Ç—å) –ª—ñ–Ω—ñ–π —Å–ø—ñ—Ä–∞–ª—ñ.")
        A = st.slider("–í—ñ–∫", 10, 100, 45)
        # S - 0-15 —à–∫–∞–ª–∞
        S = st.slider("–ì–æ–¥–∏–Ω —Å–Ω—É", 0, 15, 8, help="–í–ø–ª–∏–≤–∞—î –Ω–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å —Ü–µ–Ω—Ç—Ä—É.")
        
        st.markdown("---")
        E = st.slider("–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å", 0, 10, 5, help="–ó–º—ñ–Ω—é—î –ì–û–°–¢–†–û–¢–£ –ø–µ–ª—é—Å—Ç–æ–∫.")
        T = st.slider("–ï–Ω–µ—Ä–≥—ñ—è", 0, 10, 5, help="–ó–º—ñ–Ω—é—î –ó–ê–ö–†–£–ß–ï–ù–Ü–°–¢–¨ —Å–ø—ñ—Ä–∞–ª—ñ.")
        
        st.markdown("---")
        G = st.radio("–°—Ç–∞—Ç—å", options=[1, -1], format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞" if x == 1 else "–ñ—ñ–Ω–æ—á–∞")
        temp = st.selectbox("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç", options=["–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫", "–•–æ–ª–µ—Ä–∏–∫", "–§–ª–µ–≥–º–∞—Ç–∏–∫", "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫"])
        eye_choice = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", options=[1, 2, 3, 4], 
                                  format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])

    # –ì–†–ê–§–Ü–ß–ù–ê –õ–û–ì–Ü–ö–ê
    def generate_mandala():
        style_map = {
            "–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫": {"lw": 2.0, "alpha": 0.8, "ls": "-", "f_alpha": 0.4},
            "–•–æ–ª–µ—Ä–∏–∫":   {"lw": 4.0, "alpha": 1.0, "ls": "-", "f_alpha": 0.6},
            "–§–ª–µ–≥–º–∞—Ç–∏–∫": {"lw": 6.0, "alpha": 0.4, "ls": "-", "f_alpha": 0.2},
            "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫": {"lw": 0.8, "alpha": 0.8, "ls": "--", "f_alpha": 0.2}
        }
        s = style_map[temp]
        
        color_maps = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}
        selected_cmap = color_maps.get(eye_choice, cm.plasma)
        
        # –í–∏—Å–æ–∫–∞ —Ä–æ–∑–¥—ñ–ª—å–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å
        t = np.linspace(0, 4 * np.pi, 3000)
        
        fig = plt.figure(figsize=(6, 6), facecolor='black')
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        # === –§–Ü–ö–°–û–í–ê–ù–ò–ô –ú–ê–°–®–¢–ê–ë ===
        # –ú–∏ –ø—Ä–∏–±—Ä–∞–ª–∏ H –∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è.
        # –í—Å—ñ –º–∞–Ω–¥–∞–ª–∏ —Ç–µ–ø–µ—Ä –±—É–¥—É—Ç—å –≤–ø–∏—Å–∞–Ω—ñ –≤ —Ä–∞–¥—ñ—É—Å ~2.2
        FIXED_SCALE = 1.0

        # === 1. –¶–ï–ù–¢–†–ê–õ–¨–ù–ï –ö–Ü–õ–¨–¶–ï (–°–û–ù S) ===
        # –ó–æ–≤–Ω—ñ—à–Ω—ñ–π —Ä–∞–¥—ñ—É—Å —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π
        r_core_out = 0.5 * FIXED_SCALE
        
        # –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ä–∞–¥—ñ—É—Å –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å–Ω—É. S=15 -> hole=0. S=0 -> hole=max.
        hole_ratio = 1 - (S / 15.0)
        hole_ratio = max(0.01, min(0.95, hole_ratio)) # –ó–∞—Ö–∏—Å—Ç –º–µ–∂
        r_hole = r_core_out * hole_ratio
        
        # –ú–∞–ª—é—î–º–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ –∫—ñ–ª—å—Ü–µ
        ax.fill_between(t, r_hole, r_core_out, color=selected_cmap(0.9), alpha=(s["f_alpha"] + 0.3))
        # –ö–æ–Ω—Ç—É—Ä–∏
        ax.plot(t, np.full_like(t, r_hole), color='white', linewidth=0.5, alpha=0.5)
        ax.plot(t, np.full_like(t, r_core_out), color='white', linewidth=s["lw"]*0.5, alpha=s["alpha"])

        # === 2. –ü–ï–õ–Æ–°–¢–ö–ò (–í–ü–ï–í–ù–ï–ù–Ü–°–¢–¨ E, –ú–Ü–°–Ø–¶–¨ n) ===
        # –ü–æ–∫–∞–∑–Ω–∏–∫ —Å—Ç–µ–ø–µ–Ω—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ E (–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å). –ë—ñ–ª—å—à–µ E = –≥–æ—Å—Ç—Ä—ñ—à–µ.
        e_pow = (12 - E) / 2.5
        
        r_rose_base = r_core_out + 0.1
        # –§–æ—Ä–º—É–ª–∞ —Ç—Ä–æ—è–Ω–¥–∏
        r_rose = r_rose_base + (np.abs(np.cos(n/2 * t)))**e_pow * 0.8 * FIXED_SCALE
        
        ax.fill(t, r_rose, color=selected_cmap(0.3), alpha=s["f_alpha"])
        ax.plot(t, r_rose, color=selected_cmap(0.4), linewidth=s["lw"], linestyle=s["ls"])
        
        # === 3. –ü–û–õ–ï –°–ü–Ü–†–ê–õ–ï–ô (–í–Ü–ö A, –ï–ù–ï–†–ì–Ü–Ø T, –ó–†–Ü–°–¢ H) ===
        # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ª–æ–≥—ñ–∫–∏ –Ω–∞—à–∞—Ä—É–≤–∞–Ω–Ω—è –ª—ñ–Ω—ñ–π
        max_r_rose = r_rose.max()
        
        # –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –º–æ–¥—É–ª—è—Ü—ñ—ó –≤—ñ–¥ –ó–†–û–°–¢–£ (H).
        # –í–∏—Å–æ–∫–∏–π –∑—Ä—ñ—Å—Ç (220) –¥–∞—î –±—ñ–ª—å—à—É –∞–º–ø–ª—ñ—Ç—É–¥—É —Ö–≤–∏–ª—ñ.
        h_modulation = (H / 220.0) * 0.15 * FIXED_SCALE

        # –ö—Ä–æ–∫ –º–∞–ª—é–≤–∞–Ω–Ω—è –ª—ñ–Ω—ñ–π (–º–æ–∂–Ω–∞ –ø—Ä–æ—Ä—ñ–¥–∏—Ç–∏ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó, —è–∫—â–æ A –≤–µ–ª–∏–∫–µ)
        step = 1 if A < 60 else 2
        
        for i in range(1, A + 1, step):
            progress = i / A
            
            # 1. –ó–∞–∫—Ä—É—á—É–≤–∞–Ω–Ω—è (–ï–ù–ï–†–ì–Ü–Ø T, –°—Ç–∞—Ç—å G)
            # –ß–∏–º –±—ñ–ª—å—à–µ T, —Ç–∏–º —Å–∏–ª—å–Ω—ñ—à–µ –∑–∞–∫—Ä—É—á—É—î—Ç—å—Å—è —à–∞—Ä
            rotation = G * (i * (T / 8.0) * (np.pi / 3.0))
            
            # 2. –ë–∞–∑–æ–≤–∏–π —Ä–∞–¥—ñ—É—Å —Å–ø—ñ—Ä–∞–ª—ñ (—Ä–æ—Å—Ç–µ –∑ –≤—ñ–∫–æ–º)
            r_spiral_base = max_r_rose + progress * 1.2 * FIXED_SCALE
            
            # 3. –•–≤–∏–ª—è—Å—Ç—ñ—Å—Ç—å (–ó–†–Ü–°–¢ H —Ç–∞ –î–µ–Ω—å d)
            # –î–æ–¥–∞—î–º–æ —Å–∏–Ω—É—Å–æ—ó–¥—É –¥–æ —Ä–∞–¥—ñ—É—Å–∞. –ê–º–ø–ª—ñ—Ç—É–¥–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ H.
            wave = h_modulation * np.sin(d * t * 1.5)
            
            r_final_spiral = r_spiral_base + wave
            
            # –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—é –∑—ñ –∑–º—ñ—â–µ–Ω–Ω—è–º –∫—É—Ç–∞
            ax.plot(t + rotation, r_final_spiral, 
                    color=selected_cmap(progress), 
                    linewidth=s["lw"]*0.4, 
                    alpha=s["alpha"]*0.6 * (1-progress*0.5)) # –ó–æ–≤–Ω—ñ—à–Ω—ñ –ª—ñ–Ω—ñ—ó –ø—Ä–æ–∑–æ—Ä—ñ—à—ñ

        # === 4. –ó–û–í–ù–Ü–®–ù–Ø –ú–ï–ñ–ê (–°—Ç–∞—Ç—å G, –î–µ–Ω—å d) ===
        p_val = 0.5 if G == 1 else 1.8
        crown_mod = (np.abs(np.sin(d * t)))**p_val
        # –ú–µ–∂–∞ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –º–æ–∂–ª–∏–≤–æ–º—É —Ä–∞–¥—ñ—É—Å—ñ —Å–ø—ñ—Ä–∞–ª–µ–π
        r_border_base = max_r_rose + 1.2 * FIXED_SCALE + h_modulation
        r_border = r_border_base + (0.3 * FIXED_SCALE * crown_mod)
        
        ax.plot(t, r_border, color=selected_cmap(0.7), linewidth=s["lw"]*1.2, alpha=0.9)
        
        # --- –§–Ü–ö–°–ê–¶–Ü–Ø –ö–ê–ú–ï–†–ò ---
        # –§—ñ–∫—Å—É—î–º–æ –º–µ–∂—ñ, —â–æ–± —É—Å—ñ –º–∞–Ω–¥–∞–ª–∏ –±—É–ª–∏ –æ–¥–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É.
        ax.set_ylim(0, 2.4)
        ax.set_axis_off()
        
        return fig

    # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    col1, col2, col3 = st.columns([1, 2, 1]) 

    with col2:
        fig = generate_mandala()
        st.pyplot(fig)
        
        # –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        buf = io.BytesIO()
        fig.savefig(buf, format="png", facecolor='black', dpi=300)
        st.download_button(label="üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–Ω–¥–∞–ª—É (PNG)", data=buf.getvalue(), 
                           file_name=f"mandala.png", mime="image/png")
