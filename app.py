import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")

st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ-–º–∏—Å—Ç–µ—Ü—å–∫–∏–π –ø—Ä–æ—î–∫—Ç. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –±—ñ–æ–º–µ—Ç—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö")
st.markdown("---")

# 2. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω–¥–∞–ª–∏", "üìú –ù–∞—É–∫–æ–≤–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è –º–æ–¥–µ–ª—ñ")
    st.write("""
    –ü—Ä–æ—î–∫—Ç –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –ø–æ–±—É–¥–æ–≤—ñ –±–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤–æ—ó –≥—Ä–∞—Ñ—ñ—á–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –≤ –ø–æ–ª—è—Ä–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö $(r, \\theta)$. 
    –ö–æ–∂–µ–Ω —à–∞—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –ø–µ–≤–Ω–∏–π –∞—Å–ø–µ–∫—Ç –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ, –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—á–∏ —Å—É—Ö—ñ —Ü–∏—Ñ—Ä–∏ –Ω–∞ –≥–∞—Ä–º–æ–Ω—ñ–π–Ω—É –≤—ñ–∑—É–∞–ª—å–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
    """)

    # --- 1. –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –ü–†–û–°–¢–Ü–† ---
    st.subheader("1. –¢–æ–ø–æ–ª–æ–≥—ñ—è –ü—Ä–æ—Å—Ç–æ—Ä—É (–ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è)")
    st.write("–£—Å—ñ –º–∞–Ω–¥–∞–ª–∏ –≤–ø–∏—Å–∞–Ω—ñ –≤ —î–¥–∏–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å—É–º –∑ —Ä–∞–¥—ñ—É—Å–æ–º $R \\approx 1.45$. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≤—ñ–∑—É–∞–ª—å–Ω–æ –ø–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç–µ–π –±–µ–∑ —Å–ø–æ—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Å—à—Ç–∞–±—É.")

    # --- 2. –°–û–ù ---
    st.subheader("2. –Ø–¥—Ä–æ –†–µ—Å—É—Ä—Å—É (–°–æ–Ω)")
    st.write("–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ –∫–æ–ª–æ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –µ–Ω–µ—Ä–≥–µ—Ç–∏—á–Ω–∏–π –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª. –ô–æ–≥–æ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –ø–æ–∫–∞–∑–Ω–∏–∫–∞ —Å–Ω—É ($S$).")
    st.latex(r"r_{hole} = R_{core} \cdot \left(1 - \frac{S}{12}\right)")
    st.write("–ü—Ä–∏ –¥–µ—Ñ—ñ—Ü–∏—Ç—ñ —Å–Ω—É –≤ —Ü–µ–Ω—Ç—Ä—ñ —É—Ç–≤–æ—Ä—é—î—Ç—å—Å—è '–ø–æ—Ä–æ–∂–Ω–µ—á–∞' (–∫—ñ–ª—å—Ü–µ), –ø—Ä–∏ –Ω–æ—Ä–º—ñ ($12$ –≥–æ–¥) —è–¥—Ä–æ —Å—Ç–∞—î –º–æ–Ω–æ–ª—ñ—Ç–Ω–∏–º –¥–∏—Å–∫–æ–º.")

    # --- 3. –î–ï–ù–¨ –ù–ê–†–û–î–ñ–ï–ù–ù–Ø ---
    st.subheader("3. –ì–∞—Ä–º–æ–Ω—ñ—á–Ω–∏–π —Ä–µ–∑–æ–Ω–∞–Ω—Å (–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è)")
    st.write("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è ($d$) –≤–∏–∑–Ω–∞—á–∞—î —á–∞—Å—Ç–æ—Ç—É –≤—ñ–±—Ä–∞—Ü—ñ—ó –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —à–∞—Ä—É (–ï–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∏).")
    st.latex(r"r_{layer2} = R_{base} + A \cdot \cos( d \cdot \theta )")
    st.write("–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–µ–ª—é—Å—Ç–æ–∫ —É —Ü—å–æ–º—É —à–∞—Ä—ñ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ —Ç–æ—Ç–æ–∂–Ω–∞ —á–∏—Å–ª—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–≤—ñ–¥ 1 –¥–æ 31).")

    # --- 4. –ü–ï–õ–Æ–°–¢–ö–ò ---
    st.subheader("4. –ï–º–æ—Ü—ñ–π–Ω–∏–π –∫–æ–Ω—Ç—É—Ä (–ú—ñ—Å—è—Ü—å —Ç–∞ –í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å)")
    st.write("–ë–∞–∑–æ–≤–∞ —Ñ–æ—Ä–º–∞ –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –º—ñ—Å—è—Ü–µ–º –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è ($n$), –∞ –≥–æ—Å—Ç—Ä–æ—Ç–∞ –ª—ñ–Ω—ñ–π ‚Äî —Ä—ñ–≤–Ω–µ–º –í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ ($E$).")
    st.latex(r"r_{rose}(\theta) = R_{base} + |\cos(\frac{n}{2}\theta)|^p")
    st.write("–ü–æ–∫–∞–∑–Ω–∏–∫ —Å—Ç–µ–ø–µ–Ω—è $p$ –∑–º–µ–Ω—à—É—î—Ç—å—Å—è –ø—Ä–∏ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—ñ –í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ, –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—á–∏ –º'—è–∫—ñ –ª—ñ–Ω—ñ—ó –Ω–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ñ (–≥–æ—Å—Ç—Ä—ñ).")

    # --- 5. –°–ü–Ü–†–ê–õ–Ü ---
    st.subheader("5. –ü–æ–ª–µ –∂–∏—Ç—Ç—î–≤–æ–≥–æ —à–ª—è—Ö—É (–í—ñ–∫ —Ç–∞ –ï–Ω–µ—Ä–≥—ñ—è)")
    st.write("–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—ñ—Ä–∞–ª–µ–π –¥–æ—Ä—ñ–≤–Ω—é—î –≤—ñ–∫—É ($A$). –ï–Ω–µ—Ä–≥—ñ—è ($T$) –¥–æ–¥–∞—î –≤–∏—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—É –º–æ–¥—É–ª—è—Ü—ñ—é ('–Ω–µ—Ä–≤' –ª—ñ–Ω—ñ—ó).")
    st.latex(r"r_{spiral} = r_{base} + \underbrace{T \cdot \sin(25\theta)}_{\text{–í—ñ–±—Ä–∞—Ü—ñ—è}}")
    st.write("–í–∏—Å–æ–∫–∞ –µ–Ω–µ—Ä–≥—ñ—è —Å—Ç–≤–æ—Ä—é—î –µ—Ñ–µ–∫—Ç –Ω–∞–ø—Ä—É–≥–∏ —Ç–∞ –¥–∏–Ω–∞–º—ñ–∫–∏, –Ω–∏–∑—å–∫–∞ ‚Äî –ø–ª–∞–≤–Ω—ñ—Å—Ç—å —Ç–∞ —Å–ø–æ–∫—ñ–π.")

    # --- 6. –ó–†–Ü–°–¢ (–ú–ï–ñ–ê) ---
    st.subheader("6. –ó–∞—Ö–∏—Å–Ω–∏–π –ø–µ—Ä–∏–º–µ—Ç—Ä (–ó—Ä—ñ—Å—Ç)")
    st.write("–ó—Ä—ñ—Å—Ç ($H$) –≤–∏–∑–Ω–∞—á–∞—î **—á–∞—Å—Ç–æ—Ç—É** (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω) –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∫–æ–Ω—Ç—É—Ä—É.")
    st.latex(r"N_{peaks} = \frac{H}{10}")
    st.write("–õ—é–¥–∏–Ω–∞ –∑—Ä–æ—Å—Ç–æ–º 170 —Å–º –º–∞—Ç–∏–º–µ 17 –≤–µ—Ä—à–∏–Ω –Ω–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–º—É –∫–æ–ª—ñ, —â–æ —Å—Ç–≤–æ—Ä—é—î —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π —Ä–∏—Ç–º –∫–æ—Ä–¥–æ–Ω—É.")

    # --- 7. –°–¢–ê–¢–¨ (–ù–û–í–ï) ---
    st.subheader("7. –í–µ–∫—Ç–æ—Ä–Ω–∞ —Å–∏–º–µ—Ç—Ä—ñ—è (–°—Ç–∞—Ç—å)")
    st.write("–°—Ç–∞—Ç—å ($G$) –≤–ø–ª–∏–≤–∞—î –Ω–∞ –¥–≤–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏:")
    st.write("""
    1.  **–•—ñ—Ä–∞–ª—å–Ω—ñ—Å—Ç—å (–û–±–µ—Ä—Ç–∞–Ω–Ω—è):** –í–∏–∑–Ω–∞—á–∞—î –Ω–∞–ø—Ä—è–º–æ–∫ –∑–∞–∫—Ä—É—á—É–≤–∞–Ω–Ω—è —Å–ø—ñ—Ä–∞–ª–µ–π (–∑–∞ –≥–æ–¥–∏–Ω–Ω–∏–∫–æ–≤–æ—é —Å—Ç—Ä—ñ–ª–∫–æ—é –∞–±–æ –ø—Ä–æ—Ç–∏).
    2.  **–ì–µ–æ–º–µ—Ç—Ä—ñ—è –º–µ–∂—ñ:** * *–ß–æ–ª–æ–≤—ñ—á–∏–π –≤–µ–∫—Ç–æ—Ä ($p=0.5$):* –ñ–æ—Ä—Å—Ç–∫–∞, –∫—Ä–∏—Å—Ç–∞–ª—ñ—á–Ω–∞ —Ñ–æ—Ä–º–∞ –≤–µ—Ä—à–∏–Ω.
        * *–ñ—ñ–Ω–æ—á–∏–π –≤–µ–∫—Ç–æ—Ä ($p=1.5$):* –ú'—è–∫–∞, –±—ñ–æ–Ω—ñ—á–Ω–∞ —Ñ–æ—Ä–º–∞ –≤–µ—Ä—à–∏–Ω.
    """)

    # --- 8. –¢–ï–ú–ü–ï–†–ê–ú–ï–ù–¢ ---
    st.subheader("8. –ì—Ä–∞—Ñ—ñ—á–Ω–∞ —Ñ—ñ–∑–∏–∫–∞ (–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç)")
    st.write("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç –≤–∏–∑–Ω–∞—á–∞—î —Å—Ç–∏–ª—å –ª—ñ–Ω—ñ—ó (`linewidth`) —Ç–∞ —ó—ó –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å (`alpha`):")
    st.write("""
    * **üî¥ –•–æ–ª–µ—Ä–∏–∫:** –¢–æ–≤—Å—Ç–∞, –Ω–∞—Å–∏—á–µ–Ω–∞, –Ω–µ–ø—Ä–æ–∑–æ—Ä–∞ –ª—ñ–Ω—ñ—è (–°–∏–ª–∏, –Ü–º–ø—É–ª—å—Å).
    * **üü¢ –°–∞–Ω–≥–≤—ñ–Ω—ñ–∫:** –ó–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∞ –ª—ñ–Ω—ñ—è —Å–µ—Ä–µ–¥–Ω—å–æ—ó —Ç–æ–≤—â–∏–Ω–∏ (–ì–∞—Ä–º–æ–Ω—ñ—è, –°—Ç—ñ–π–∫—ñ—Å—Ç—å).
    * **üîµ –§–ª–µ–≥–º–∞—Ç–∏–∫:** –î—É–∂–µ —à–∏—Ä–æ–∫–∞, –∞–ª–µ –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∞ –ª—ñ–Ω—ñ—è (–ì–ª–∏–±–∏–Ω–∞, –Ü–Ω–µ—Ä—Ç–Ω—ñ—Å—Ç—å).
    * **üü£ –ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫:** –¢–æ–Ω–∫–∞, –¥–µ–ª—ñ–∫–∞—Ç–Ω–∞, —á–∞—Å—Ç–æ –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞ –ª—ñ–Ω—ñ—è (–ß—É—Ç–ª–∏–≤—ñ—Å—Ç—å, –¢–æ–Ω–∫—ñ—Å—Ç—å).
    """)

with tab1:
    # –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø
    st.sidebar.header("üìã –¢–≤–æ—ó –¥–∞–Ω—ñ")
    with st.sidebar:
        # 1. –î–∞—Ç–∞
        d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–í–Ω—É—Ç—Ä—ñ—à–Ω—è –∑—ñ—Ä–∫–∞)", 1, 31, 15)
        n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–§–æ—Ä–º–∞ –ø–µ–ª—é—Å—Ç–æ–∫)", 1, 12, 6)
        
        # 2. –§—ñ–∑–∏–∫–∞
        H = st.slider("–ó—Ä—ñ—Å—Ç (—Å–º) -> –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω –º–µ–∂—ñ", 100, 220, 170)
        A = st.slider("–í—ñ–∫ (–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—ñ—Ä–∞–ª–µ–π)", 10, 100, 45)
        S = st.slider("–ì–æ–¥–∏–Ω —Å–Ω—É (–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ü–µ–Ω—Ç—Ä—É)", 0, 12, 8)
        
        st.markdown("---")
        # 3. –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è
        E = st.slider("–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å (–ì–æ—Å—Ç—Ä–æ—Ç–∞ –ø–µ–ª—é—Å—Ç–æ–∫)", 0, 10, 5)
        T = st.slider("–ï–Ω–µ—Ä–≥—ñ—è (–í—ñ–±—Ä–∞—Ü—ñ—è —Å–ø—ñ—Ä–∞–ª–µ–π)", 0, 10, 5)
        
        st.markdown("---")
        # 4. –°—Ç–∏–ª—å
        G = st.radio("–°—Ç–∞—Ç—å", options=[1, -1], format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞" if x == 1 else "–ñ—ñ–Ω–æ—á–∞")
        temp = st.selectbox("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç", options=["–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫", "–•–æ–ª–µ—Ä–∏–∫", "–§–ª–µ–≥–º–∞—Ç–∏–∫", "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫"])
        eye_choice = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", options=[1, 2, 3, 4], 
                                  format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])

    # –ì–†–ê–§–Ü–ß–ù–ê –õ–û–ì–Ü–ö–ê
    def generate_mandala():
        # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤ —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç—É
        style_map = {
            "–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫": {"lw": 2.0, "alpha": 0.8, "ls": "-", "f_alpha": 0.4},
            "–•–æ–ª–µ—Ä–∏–∫":   {"lw": 4.0, "alpha": 1.0, "ls": "-", "f_alpha": 0.6},
            "–§–ª–µ–≥–º–∞—Ç–∏–∫": {"lw": 6.0, "alpha": 0.4, "ls": "-", "f_alpha": 0.2},
            "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫": {"lw": 0.8, "alpha": 0.8, "ls": "--", "f_alpha": 0.2}
        }
        s = style_map[temp]
        selected_cmap = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}.get(eye_choice, cm.plasma)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–æ—á–æ–∫ (–≤–∏—Å–æ–∫–∞ —Ä–æ–∑–¥—ñ–ª—å–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å)
        t = np.linspace(0, 2 * np.pi, 4000)
        
        fig = plt.figure(figsize=(6, 6), facecolor='black')
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        SCALE = 0.12 # –§—ñ–∫—Å–æ–≤–∞–Ω–∏–π –≥–ª–æ–±–∞–ª—å–Ω–∏–π –º–∞—Å—à—Ç–∞–±
        
        # === 1. –Ø–î–†–û (–°–û–ù S) ===
        R_core = 2.0 * SCALE
        # –õ–æ–≥—ñ–∫–∞ –¥—ñ—Ä–∫–∏: S=12 -> 0, S=0 -> –º–∞–∫—Å
        hole_ratio = max(0.0, 1 - (S / 12.0))
        r_hole = R_core * hole_ratio
        
        # –ú–∞–ª—é—î–º–æ —è–¥—Ä–æ
        ax.fill_between(t, r_hole, R_core, color=selected_cmap(0.9), alpha=s["f_alpha"] + 0.3)
        ax.plot(t, np.full_like(t, r_hole), color='white', linewidth=0.5, alpha=0.5)

        # === 2. –í–ù–£–¢–†–Ü–®–ù–Ø –ó–Ü–†–ö–ê (–î–ï–ù–¨ –ù–ê–†–û–î–ñ–ï–ù–ù–Ø d) ===
        R_layer2_base = R_core + 0.3 * SCALE
        # d = —á–∞—Å—Ç–æ—Ç–∞ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω)
        r_layer2 = R_layer2_base + 0.3 * SCALE * np.cos(d * t)
        
        ax.plot(t, r_layer2, color=selected_cmap(0.7), linewidth=s["lw"]*0.8, alpha=0.8)
        ax.fill_between(t, R_core, r_layer2, color=selected_cmap(0.5), alpha=0.2)

        # === 3. –û–°–ù–û–í–ù–Ü –ü–ï–õ–Æ–°–¢–ö–ò (–ú–Ü–°–Ø–¶–¨ n, –í–ü–ï–í–ù–ï–ù–Ü–°–¢–¨ E) ===
        R_rose_base = R_layer2_base + 0.5 * SCALE
        e_val = (11 - E) / 2 # –ß–∏–º –±—ñ–ª—å—à–µ E, —Ç–∏–º –º–µ–Ω—à–µ —Å—Ç–µ–ø—ñ–Ω—å -> –≥–æ—Å—Ç—Ä—ñ—à–µ
        r_rose = R_rose_base + (np.abs(np.cos(n/2 * t)))**e_val * 2.5 * SCALE
        
        ax.fill(t, r_rose, color=selected_cmap(0.3), alpha=s["f_alpha"])
        ax.plot(t, r_rose, color=selected_cmap(0.2), linewidth=s["lw"], linestyle=s["ls"])

        # === 4. –°–ü–Ü–†–ê–õ–Ü (–í–Ü–ö A, –ï–ù–ï–†–ì–Ü–Ø T, –°–¢–ê–¢–¨ G) ===
        max_r_rose = r_rose.max()
        # –ï–Ω–µ—Ä–≥—ñ—è —Å—Ç–≤–æ—Ä—é—î "—Ç—Ä–µ–º—Ç—ñ–Ω–Ω—è" (–≤—ñ–±—Ä–∞—Ü—ñ—é)
        energy_vibro = (T / 10.0) * 0.15 * SCALE 
        
        for i in range(1, A + 1):
            s_step = i / A
            # G –≤–ø–ª–∏–≤–∞—î –Ω–∞ –Ω–∞–ø—Ä—è–º–æ–∫ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è (+ –∞–±–æ -)
            rotation = G * i * 0.1
            
            r_base = max_r_rose + s_step * 3.0 * SCALE
            
            # –î–æ–¥–∞—î–º–æ –≤—ñ–±—Ä–∞—Ü—ñ—é (—Å–∏–Ω—É—Å–æ—ó–¥–∞ –≤–∏—Å–æ–∫–æ—ó —á–∞—Å—Ç–æ—Ç–∏)
            r_spiral = r_base + energy_vibro * np.sin(25 * t)
            
            ax.plot(t + rotation, r_spiral, 
                    color=selected_cmap(s_step), linewidth=s["lw"]*0.4, alpha=s["alpha"]*0.6)

        # === 5. –ó–û–í–ù–Ü–®–ù–Ø –ú–ï–ñ–ê (–ó–†–Ü–°–¢ H, –°–¢–ê–¢–¨ G) ===
        # –ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–µ—Ä—à–∏–Ω = –ó—Ä—ñ—Å—Ç / 10 (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 17)
        border_freq = int(H / 10) 
        
        r_border_base = max_r_rose + 3.5 * SCALE
        
        # –§–æ—Ä–º–∞ —à–∏–ø—ñ–≤ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –°–¢–ê–¢–Ü (G)
        # –ß–æ–ª–æ–≤—ñ–∫–∏ (1) = 0.5 (–≥–æ—Å—Ç—Ä—ñ), –ñ—ñ–Ω–∫–∏ (-1) = 1.5 (–æ–∫—Ä—É–≥–ª—ñ)
        p_val = 0.5 if G == 1 else 1.5 
        
        crown_shape = (np.abs(np.sin(border_freq * t)))**p_val 
        r_border = r_border_base + (1.0 * SCALE * crown_shape)
        
        ax.plot(t, r_border, color=selected_cmap(0.8), linewidth=s["lw"]*1.5, alpha=0.9)

        # –§—ñ–∫—Å–∞—Ü—ñ—è (–∑–∞–≤–∂–¥–∏ –æ–¥–Ω–∞–∫–æ–≤–∏–π –º–∞—Å—à—Ç–∞–±)
        ax.set_ylim(0, 1.45) 
        ax.set_axis_off()
        return fig

    # –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø
    col1, col2, col3 = st.columns([1, 2, 1]) 
    with col2:
        fig = generate_mandala()
        st.pyplot(fig)
        
        buf = io.BytesIO()
        fig.savefig(buf, format="png", facecolor='black', dpi=300)
        st.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG", buf.getvalue(), "mandala.png", "image/png")
