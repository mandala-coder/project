import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")

# –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ-–º–∏—Å—Ç–µ—Ü—å–∫–∏–π –ø—Ä–æ—î–∫—Ç —É—á–µ–Ω–∏—Ü—ñ 9 –∫–ª–∞—Å—É")
st.markdown("---")

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω–¥–∞–ª–∏", "üìú –ù–∞—É–∫–æ–≤–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∏–π –∞–ø–∞—Ä–∞—Ç –ø—Ä–æ—î–∫—Ç—É")
    st.write("""
    –¶—è —Ä–æ–±–æ—Ç–∞ –¥–æ—Å–ª—ñ–¥–∂—É—î –ø–µ—Ä–µ—Ç–∏–Ω –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–æ—ó –≥–µ–æ–º–µ—Ç—Ä—ñ—ó —Ç–∞ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –º–∏—Å—Ç–µ—Ü—Ç–≤–∞. 
    –ú–∞–Ω–¥–∞–ª–∞ –±—É–¥—É—î—Ç—å—Å—è –≤ **–ø–æ–ª—è—Ä–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**, –¥–µ –∫–æ–∂–Ω–∞ —Ç–æ—á–∫–∞ –æ–ø–∏—Å—É—î—Ç—å—Å—è —Ä–∞–¥—ñ—É—Å–æ–º ($r$) —Ç–∞ –∫—É—Ç–æ–º ($\theta$).
    """)
    
    st.subheader("–§–æ—Ä–º—É–ª–∏ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω—å")
    st.latex(r"R(\theta) = R_{base} + \left| \cos\left(\frac{n}{2}\theta\right) \right|^{\frac{E}{2}}")
    st.write("**–î–µ:** n ‚Äî –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–µ–ª—é—Å—Ç–æ–∫ (–º—ñ—Å—è—Ü—å), E ‚Äî –µ–Ω–µ—Ä–≥—ñ—è (–≥–æ—Å—Ç—Ä–æ—Ç–∞).")
    
    st.latex(r"R_{crown} = R_{max} + G \cdot \left( \frac{K}{10} \cdot 1.5 \cdot \sin(d \cdot \theta) \right)")
    st.write("**–î–µ:** G ‚Äî –≥–µ–Ω–¥–µ—Ä–Ω–∏–π –≤–µ–∫—Ç–æ—Ä (1 –∞–±–æ -1), K ‚Äî –¥–æ–ø–∏—Ç–ª–∏–≤—ñ—Å—Ç—å, d ‚Äî –¥–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è.")
    
    st.info("""
    **–ß–æ–º—É —Ü–µ –Ω–µ GeoGebra?** Python –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ—Ç–µ—Ä–∞—Ü—ñ–π–Ω—ñ —Ü–∏–∫–ª–∏ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–æ—Ç–µ–Ω—å –Ω–∞–∫–ª–∞–¥–µ–Ω–∏—Ö —à–∞—Ä—ñ–≤ –∑ –¥–∏–Ω–∞–º—ñ—á–Ω–æ—é –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—é (alpha-channel) 
    —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–∞–ª—ñ—Ç—Ä–∏ –∫–æ–ª—å–æ—Ä—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –±–∞–∑ –¥–∞–Ω–∏—Ö (Colormaps), —â–æ —Ç–µ—Ö–Ω—ñ—á–Ω–æ –æ–±–º–µ–∂–µ–Ω–æ —É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö –≥—Ä–∞—Ñ—ñ—á–Ω–∏—Ö –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞—Ö.
    """)

with tab1:
    # –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è (Sidebar)
    st.sidebar.header("üìã –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ")
    with st.sidebar:
        n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 5)
        d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 20)
        H = st.slider("–ó—Ä—ñ—Å—Ç (—Å–º)", 100, 220, 170)
        A = st.slider("–í—ñ–∫ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –ª—ñ–Ω—ñ–π)", 10, 100, 45)
        S = st.slider("–ì–æ–¥–∏–Ω —Å–Ω—É", 0, 15, 8)
        E = st.slider("–ï–Ω–µ—Ä–≥—ñ—è (0-10)", 0, 10, 5)
        K = st.slider("–†—ñ–≤–µ–Ω—å –¥–æ–ø–∏—Ç–ª–∏–≤–æ—Å—Ç—ñ (0-10)", 0, 10, 7)
        T = st.slider("–¢–æ–Ω—É—Å (0-10)", 0, 10, 6)
        G = st.radio("–°—Ç–∞—Ç—å (–≤–µ–∫—Ç–æ—Ä –µ–Ω–µ—Ä–≥—ñ—ó)", options=[1, -1], 
                     format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞ (–ï–∫—Å–ø–∞–Ω—Å—ñ—è –Ω–∞–∑–æ–≤–Ω—ñ)" if x == 1 else "–ñ—ñ–Ω–æ—á–∞ (–Ü–Ω—Ç—Ä–æ—Å–ø–µ–∫—Ü—ñ—è –≤—Å–µ—Ä–µ–¥–∏–Ω—É)")
        eye_choice = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", options=[1, 2, 3, 4], 
                                    format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])

    # –§—É–Ω–∫—Ü—ñ—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
    def generate_mandala():
        # –í–∏–±—ñ—Ä –ø–∞–ª—ñ—Ç—Ä–∏
        color_maps = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}
        selected_cmap = color_maps.get(eye_choice, cm.plasma)
        
        t = np.linspace(0, 2 * np.pi, 2000)
        fig = plt.figure(figsize=(10, 10), facecolor='black')
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        # –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è
        global_scale = 1 / (H/100 + S/5 + 6)
        
        # 1. –ü–µ–ª—é—Å—Ç–∫–∏ (Rose)
        e_norm = E / 2 if E > 0 else 0.1
        r_rose_base = (S / 4 + 1.2) * global_scale
        r_rose = r_rose_base + (np.abs(np.cos(n/2 * t)))**e_norm * 2.5 * global_scale
        ax.fill(t, r_rose, color=selected_cmap(0.3), alpha=0.5)
        ax.plot(t, r_rose, color=selected_cmap(0.2), linewidth=2.5)
        
        # 2. –Ø–¥—Ä–æ (Seed)
        r_seed = (S / 4 + 0.3) * (1 + 0.15 * np.sin(10 * t)) * global_scale
        ax.fill(t, r_seed, color=selected_cmap(0.9), alpha=0.8)
        ax.plot(t, r_seed, color='white', linewidth=1, alpha=0.6)
        
        # 3. –ü–æ–ª–µ —Å–ø—ñ—Ä–∞–ª–µ–π (The Field)
        max_r_rose = r_rose.max()
        for i in range(1, A + 1):
            s_step = i / A
            rotation = i * (T / 10) * (np.pi / 2.5)
            r_spiral = max_r_rose + s_step * 3.5 * global_scale
            ax.plot(t + rotation, r_spiral * (1 + 0.03 * np.sin(d * t)), 
                    color=selected_cmap(s_step), linewidth=0.8, alpha=0.4)
        
        # 4. –ó–æ–≤–Ω—ñ—à–Ω—è –∫–æ—Ä–æ–Ω–∞ (The Crown) - –í–ø–ª–∏–≤ –°–¢–ê–¢–Ü (G)
        # G=1 —Ä–æ–±–∏—Ç—å –∑—É–±—Ü—ñ –Ω–∞–∑–æ–≤–Ω—ñ, G=-1 —Ä–æ–±–∏—Ç—å –∑—É–±—Ü—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—É
        r_crown = (r_spiral.max() + 0.5 * global_scale) + (G * (K/10) * 1.5 * global_scale * np.sin(d * t))
        ax.fill(t, r_crown, color=selected_cmap(0.1), alpha=0.2)
        ax.plot(t, r_crown, color=selected_cmap(0.5), linewidth=4, alpha=0.9)
        
        ax.set_ylim(0, max(r_crown.max(), r_rose.max()) * 1.1)
        ax.set_axis_off()
        return fig

    # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
    col_img, col_info = st.columns([2, 1])
    
    with col_img:
        with st.spinner('–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –º–∞–ª—é—î –≤–∞—à—É –º–∞–Ω–¥–∞–ª—É...'):
            fig = generate_mandala()
            st.pyplot(fig)
    
    with col_info:
        st.subheader("üìä –ê–Ω–∞–ª—ñ–∑ –≥–µ–æ–º–µ—Ç—Ä–∏—á–Ω–æ–≥–æ –æ–±—Ä–∞–∑—É")
        if G == 1:
            st.success("**–í–µ–∫—Ç–æ—Ä –µ–Ω–µ—Ä–≥—ñ—ó:** –ï–∫—Å–ø–∞–Ω—Å–∏–≤–Ω–∏–π (–¶–µ–Ω—Ç—Ä–æ–±—ñ–∂–Ω–∏–π). –í–∞—à–∞ –∫–æ—Ä–æ–Ω–∞ —Å–ø—Ä—è–º–æ–≤–∞–Ω–∞ –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É –Ω–∞–∑–æ–≤–Ω—ñ, —â–æ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –∞–∫—Ç–∏–≤–Ω—É –≤–∑–∞—î–º–æ–¥—ñ—é –∑ –æ—Ç–æ—á–µ–Ω–Ω—è–º —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ—Ä—É.")
        else:
            st.warning("**–í–µ–∫—Ç–æ—Ä –µ–Ω–µ—Ä–≥—ñ—ó:** –ê–∫—É–º—É–ª—è—Ç–∏–≤–Ω–∏–π (–¶–µ–Ω—Ç—Ä–æ—Å—Ç—Ä—ñ–º–Ω–∏–π). –í–∞—à–∞ –∫–æ—Ä–æ–Ω–∞ —Å–ø—Ä—è–º–æ–≤–∞–Ω–∞ –¥–æ —Ü–µ–Ω—Ç—Ä—É, —â–æ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –≥–∞—Ä–º–æ–Ω—ñ–∑–∞—Ü—ñ—é –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —Å–≤—ñ—Ç—É —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ.")
            
        if E > 7:
            st.info("‚ö° **–í–∏—Å–æ–∫–∞ –µ–Ω–µ—Ä–≥—ñ—è:** –ì–æ—Å—Ç—Ä—ñ —Ñ–æ—Ä–º–∏ –ø–µ–ª—é—Å—Ç–æ–∫ –≤–∫–∞–∑—É—é—Ç—å –Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π —Å–∫–ª–∞–¥ —Ä–æ–∑—É–º—É —Ç–∞ —Ä—ñ—à—É—á—ñ—Å—Ç—å.")
        else:
            st.info("üçÉ **–ì–∞—Ä–º–æ–Ω—ñ—è:** –û–∫—Ä—É–≥–ª—ñ —Ñ–æ—Ä–º–∏ —Å–≤—ñ–¥—á–∞—Ç—å –ø—Ä–æ –≥–Ω—É—á–∫—ñ—Å—Ç—å —Ç–∞ –µ–º–æ—Ü—ñ–π–Ω—É —Å—Ç—ñ–π–∫—ñ—Å—Ç—å.")

        # –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        buf = io.BytesIO()
        fig.savefig(buf, format="png", facecolor='black', dpi=300)
        st.download_button(
            label="üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–Ω–¥–∞–ª—É (PNG)",
            data=buf.getvalue(),
            file_name=f"personality_mandala_{n}_{d}.png",
            mime="image/png"
        )