import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")

st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ-–º–∏—Å—Ç–µ—Ü—å–∫–∏–π –ø—Ä–æ—î–∫—Ç. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö")
st.markdown("---")

# 2. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω–¥–∞–ª–∏", "üìú –ù–∞—É–∫–æ–≤–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è –º–æ–¥–µ–ª—ñ")
    st.write("""
    –ü—Ä–æ—î–∫—Ç –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –ø–æ–±—É–¥–æ–≤—ñ –±–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤–æ—ó –≥—Ä–∞—Ñ—ñ—á–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –≤ –ø–æ–ª—è—Ä–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö $(r, \\theta)$. 
    –ü—Ä–æ—Å—Ç—ñ—Ä –Ω–æ—Ä–º–æ–≤–∞–Ω–æ –¥–æ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏—Ö –º–µ–∂, —Ç–æ–º—É –≤—Å—ñ –º–∞–Ω–¥–∞–ª–∏ –º–∞—é—Ç—å –æ–¥–Ω–∞–∫–æ–≤–æ –≤–µ–ª–∏–∫–∏–π –º–∞—Å—à—Ç–∞–±, –∑–º—ñ–Ω—é—î—Ç—å—Å—è –ª–∏—à–µ —ó—Ö –Ω–∞–ø–æ–≤–Ω–µ–Ω–Ω—è.
    """)

    # --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ï –ö–Ü–õ–¨–¶–ï (–ù–û–í–ï) ---
    st.subheader("1. –¢–æ–ø–æ–ª–æ–≥—ñ—è –Ø–¥—Ä–∞ (–†–µ—Å—É—Ä—Å –°–Ω—É)")
    st.write("–¶–µ–Ω—Ç—Ä –º–∞–Ω–¥–∞–ª–∏ ‚Äî —Ü–µ –µ–Ω–µ—Ä–≥–µ—Ç–∏—á–Ω–µ —è–¥—Ä–æ. –ô–æ–≥–æ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –≥–æ–¥–∏–Ω —Å–Ω—É ($S$).")
    st.latex(r"r_{hole} = R_{core} \cdot \left(1 - \frac{S}{12}\right)")
    st.write("""
    * **12+ –≥–æ–¥–∏–Ω:** $r_{hole} = 0$. –Ø–¥—Ä–æ —Å—É—Ü—ñ–ª—å–Ω–µ, —Ä–µ—Å—É—Ä—Å –ø–æ–≤–Ω–∏–π.
    * **–ú–µ–Ω—à–µ —Å–Ω—É:** –ó'—è–≤–ª—è—î—Ç—å—Å—è –æ—Ç–≤—ñ—Ä, —è–∫–∏–π —Ä–æ—Å—Ç–µ –ø—Ä–∏ –¥–µ—Ñ—ñ—Ü–∏—Ç—ñ —Å–Ω—É.
    """)

    # --- –ï–ü–Ü–¢–†–û–•–û–á–î–ê (–ó–†–Ü–°–¢ - –ü–û–í–ï–†–ù–£–õ–ò) ---
    st.subheader("2. –ì–∞—Ä–º–æ–Ω—ñ—á–Ω–∏–π –∫–æ–Ω—Ç—É—Ä (–ó—Ä—ñ—Å—Ç)")
    st.write("–ó—Ä—ñ—Å—Ç ($H$) –≤–∏–∑–Ω–∞—á–∞—î **—á–∞—Å—Ç–æ—Ç—É** –≥–∞—Ä–º–æ–Ω—ñ—á–Ω–æ—ó —Ñ—ñ–≥—É—Ä–∏ (–ï–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∏), —â–æ –æ—Ç–æ—á—É—î —è–¥—Ä–æ. –¶–µ –∫–∞—Ä–∫–∞—Å –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ.")
    st.latex(r"r_{epi}(\theta) = R_{base} + A \cdot \cos\left( \frac{H}{10} \cdot \theta \right)")
    st.write("–í–∏—â—ñ –ª—é–¥–∏ —Å—Ç–≤–æ—Ä—é—é—Ç—å –±—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω—É –±–∞–≥–∞—Ç–æ–≥—Ä–∞–Ω–Ω—É –∑—ñ—Ä–∫—É (–±—ñ–ª—å—à–µ –≤–µ—Ä—à–∏–Ω), –∫–æ–º–ø–∞–∫—Ç–Ω–∏–π –∑—Ä—ñ—Å—Ç —Ñ–æ—Ä–º—É—î —Å—Ç—ñ–π–∫—ñ —Ñ—ñ–≥—É—Ä–∏ (—Ç—Ä–∏–∫—É—Ç–Ω–∏–∫/–∫–≤–∞–¥—Ä–∞—Ç).")

    # --- –ü–ï–õ–Æ–°–¢–ö–ò ---
    st.subheader("3. –®–∞—Ä –ø–µ–ª—é—Å—Ç–æ–∫")
    st.write("–§–æ—Ä–º–∞ –ø–µ–ª—é—Å—Ç–æ–∫ –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –º—ñ—Å—è—Ü–µ–º –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è ($n$) —Ç–∞ —Ä—ñ–≤–Ω–µ–º –í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ ($E$):")
    st.latex(r"r(\theta) = R_{start} + \left| \cos\left(\frac{n}{2}\theta\right) \right|^p \cdot C")
    st.write("–î–µ –ø–æ–∫–∞–∑–Ω–∏–∫ —Å—Ç–µ–ø–µ–Ω—è $p = (11 - E) / 2$. –í–∏—Å–æ–∫–∞ –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å —Ä–æ–±–∏—Ç—å —Ñ–æ—Ä–º—É –≥–æ—Å—Ç—Ä—ñ—à–æ—é.")

    # --- –°–ü–Ü–†–ê–õ–Ü ---
    st.subheader("4. –ü–æ–ª–µ —Å–ø—ñ—Ä–∞–ª–µ–π")
    st.write("–í—ñ–∫ ($A$) –≤–∏–∑–Ω–∞—á–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —à–∞—Ä—ñ–≤. –ö–æ–∂–Ω–∞ –ª—ñ–Ω—ñ—è –æ–±–µ—Ä—Ç–∞—î—Ç—å—Å—è –Ω–∞ –∫—É—Ç $\Phi$, —â–æ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –ï–Ω–µ—Ä–≥—ñ—ó ($T$) —Ç–∞ –°—Ç–∞—Ç—ñ ($G$):")
    st.latex(r"\Phi_{rot} = G \cdot \left( i \cdot \frac{T}{10} \cdot \pi \right)")
    
    # --- –ö–û–†–û–ù–ê ---
    st.subheader("5. –ó–æ–≤–Ω—ñ—à–Ω—è –º–µ–∂–∞")
    st.write("–ú–æ–¥—É–ª—è—Ü—ñ—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –∫–æ–Ω—Ç—É—Ä—É –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –¥–∞—Ç–∏ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è —Ç–∞ —Å—Ç–∞—Ç—ñ, —Å—Ç–≤–æ—Ä—é—é—á–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π '–≤—ñ–¥–±–∏—Ç–æ–∫ –ø–∞–ª—å—Ü—è'.")

    # --- –¢–ï–ú–ü–ï–†–ê–ú–ï–ù–¢ ---
    st.subheader("6. –¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç")
    st.write("–í–∏–∑–Ω–∞—á–∞—î —Ç–æ–≤—â–∏–Ω—É –ª—ñ–Ω—ñ–π (`linewidth`) —Ç–∞ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å (`alpha`), –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—á–∏ —Å–∏–ª—É –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏.")

with tab1:
    # –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø
    st.sidebar.header("üìã –¢–≤–æ—ó –¥–∞–Ω—ñ")
    with st.sidebar:
        n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 6)
        d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 15)
        
        # –ó—Ä—ñ—Å—Ç –≤–ø–ª–∏–≤–∞—î –Ω–∞ –ï–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥—É
        H = st.slider("–ó—Ä—ñ—Å—Ç (—Å–º) -> –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫—É—Ç—ñ–≤", 100, 220, 170)
        A = st.slider("–í—ñ–∫", 10, 100, 45)
        # –°–æ–Ω –≤–ø–ª–∏–≤–∞—î –Ω–∞ –¥—ñ—Ä–∫—É
        S = st.slider("–ì–æ–¥–∏–Ω —Å–Ω—É -> –©—ñ–ª—å–Ω—ñ—Å—Ç—å —Ü–µ–Ω—Ç—Ä—É", 0, 12, 8)
        
        st.markdown("---")
        E = st.slider("–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å", 0, 10, 5, help="–ó–º—ñ–Ω—é—î –ì–û–°–¢–†–û–¢–£ –ø–µ–ª—é—Å—Ç–æ–∫.")
        T = st.slider("–ï–Ω–µ—Ä–≥—ñ—è", 0, 10, 5, help="–ó–º—ñ–Ω—é—î –ó–ê–ö–†–£–ß–ï–ù–Ü–°–¢–¨ —Å–ø—ñ—Ä–∞–ª—ñ.")
        
        st.markdown("---")
        G = st.radio("–°—Ç–∞—Ç—å", options=[1, -1], format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞" if x == 1 else "–ñ—ñ–Ω–æ—á–∞")
        temp = st.selectbox("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç", options=["–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫", "–•–æ–ª–µ—Ä–∏–∫", "–§–ª–µ–≥–º–∞—Ç–∏–∫", "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫"])
        eye_choice = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", options=[1, 2, 3, 4], 
                                  format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])

    # –ì–†–ê–§–Ü–ß–ù–ê –õ–û–ì–Ü–ö–ê
    def generate_mandala():
        style_map = {
            "–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫": {"lw": 2.0, "alpha": 0.8, "ls": "-", "f_alpha": 0.4},
            "–•–æ–ª–µ—Ä–∏–∫":   {"lw": 4.0, "alpha": 1.0, "ls": "-", "f_alpha": 0.6},
            "–§–ª–µ–≥–º–∞—Ç–∏–∫": {"lw": 6.0, "alpha": 0.4, "ls": "-", "f_alpha": 0.2},
            "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫": {"lw": 0.8, "alpha": 0.8, "ls": "--", "f_alpha": 0.2}
        }
        s = style_map[temp]
        
        color_maps = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}
        selected_cmap = color_maps.get(eye_choice, cm.plasma)
        
        t = np.linspace(0, 2 * np.pi, 2500)
        fig = plt.figure(figsize=(6, 6), facecolor='black')
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        # === 1. –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –ú–ê–°–®–¢–ê–ë (–§–Ü–ö–°–û–í–ê–ù–ò–ô) ===
        # –©–æ–± –º–∞–Ω–¥–∞–ª–∏ –±—É–ª–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ –≤–µ–ª–∏–∫—ñ, —Ñ—ñ–∫—Å—É—î–º–æ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç.
        # –†–∞–Ω—ñ—à–µ –≤—ñ–Ω –±—É–≤ ~0.11 (–ø—Ä–∏ —Å–µ—Ä–µ–¥–Ω—ñ—Ö –¥–∞–Ω–∏—Ö).
        FIXED_SCALE = 0.12 

        # === 2. –¶–ï–ù–¢–†–ê–õ–¨–ù–ï –Ø–î–†–û (–°–û–ù S - –ù–û–í–ê –õ–û–ì–Ü–ö–ê) ===
        # –ó–æ–≤–Ω—ñ—à–Ω—ñ–π —Ä–∞–¥—ñ—É—Å —è–¥—Ä–∞ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π
        R_core_max = 2.0 * FIXED_SCALE 
        
        # –†–∞–¥—ñ—É—Å –¥—ñ—Ä–∫–∏ (hole). 
        # –Ø–∫—â–æ S=12 -> –¥—ñ—Ä–∫–∞ = 0. –Ø–∫—â–æ S=0 -> –¥—ñ—Ä–∫–∞ –º–∞–π–∂–µ –ø–æ–≤–Ω–∞.
        hole_ratio = 1 - (S / 12.0)
        hole_ratio = max(0.0, min(0.9, hole_ratio))
        r_hole = R_core_max * hole_ratio

        # –ú–∞–ª—é—î–º–æ —è–¥—Ä–æ (fill_between)
        ax.fill_between(t, r_hole, R_core_max, color=selected_cmap(0.9), alpha=s["f_alpha"] + 0.3)
        # –ö–æ–Ω—Ç—É—Ä–∏
        ax.plot(t, np.full_like(t, r_hole), color='white', linewidth=0.5, alpha=0.5) # –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –∫—Ä–∞–π
        
        # === 3. –ï–ü–Ü–¢–†–û–•–û–á–î–ê (–ó–†–Ü–°–¢ H - –ü–û–í–ï–†–ù–£–õ–ò) ===
        # –¶–µ –ø—Ä–æ–º—ñ–∂–Ω–∏–π —à–∞—Ä –º—ñ–∂ —è–¥—Ä–æ–º —ñ –ø–µ–ª—é—Å—Ç–∫–∞–º–∏
        # –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫—É—Ç—ñ–≤ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∑—Ä–æ—Å—Ç—É
        k_epi = int(H / 10) # 170 —Å–º -> 17 –≤–µ—Ä—à–∏–Ω
        
        # –í–æ–Ω–∞ —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–∞ –∑–∞ —è–¥—Ä–æ
        r_epi_base = R_core_max + 0.2 * FIXED_SCALE
        r_epi = r_epi_base + 0.3 * FIXED_SCALE * np.cos(k_epi * t)
        
        ax.plot(t, r_epi, color=selected_cmap(0.6), linewidth=s["lw"]*0.8, alpha=0.7)
        
        # === 4. –ü–ï–õ–Æ–°–¢–ö–ò (–†–ï–®–¢–ê –ë–ï–ó –ó–ú–Ü–ù) ===
        # –ü–æ—á–∏–Ω–∞—î–º–æ –º–∞–ª—é–≤–∞—Ç–∏ –ø–µ–ª—é—Å—Ç–∫–∏ –≤—ñ–¥—Ä–∞–∑—É –∑–∞ –µ–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–æ—é
        # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞–∫—Å. —Ä–∞–¥—ñ—É—Å –µ–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∏, —â–æ–± –Ω–µ –Ω–∞–∫–ª–∞–¥–∞–ª–æ—Å—è
        r_start_petals = r_epi_base + 0.4 * FIXED_SCALE
        
        e_val = (11 - E) / 2
        # –§–æ—Ä–º—É–ª–∞ –∑ —Ç–≤–æ–≥–æ –∫–æ–¥—É, –∞–ª–µ –∑ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–º –º–∞—Å—à—Ç–∞–±–æ–º
        r_rose = r_start_petals + (np.abs(np.cos(n/2 * t)))**e_val * 2.5 * FIXED_SCALE
        
        ax.fill(t, r_rose, color=selected_cmap(0.3), alpha=s["f_alpha"])
        ax.plot(t, r_rose, color=selected_cmap(0.2), linewidth=s["lw"], linestyle=s["ls"])
        
        # === 5. –ü–û–õ–ï –°–ü–Ü–†–ê–õ–ï–ô (–†–ï–®–¢–ê –ë–ï–ó –ó–ú–Ü–ù) ===
        max_r_rose = r_rose.max()
        for i in range(1, A + 1):
            s_step = i / A
            rotation = G * i * (T / 10) * (np.pi / 2.5)
            # –¢–≤—ñ–π –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–¥ —Å–ø—ñ—Ä–∞–ª–µ–π
            r_spiral = max_r_rose + s_step * 3.5 * FIXED_SCALE
            ax.plot(t + rotation, r_spiral * (1 + 0.03 * np.sin(d * t)), 
                    color=selected_cmap(s_step), linewidth=s["lw"]*0.4, alpha=s["alpha"]*0.5)
        
        # === 6. –ó–û–í–ù–Ü–®–ù–Ø –ú–ï–ñ–ê (–†–ï–®–¢–ê –ë–ï–ó –ó–ú–Ü–ù) ===
        p_val = 0.4 if G == 1 else 1.5
        crown_mod = (np.abs(np.sin(d * t)))**p_val
        
        # –¢–≤—ñ–π –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–¥ –º–µ–∂—ñ
        r_border = (r_spiral.max() + 0.6 * FIXED_SCALE) + (0.5 * FIXED_SCALE * crown_mod)
        
        ax.plot(t, r_border, color=selected_cmap(0.6), linewidth=s["lw"]*1.5, alpha=0.9)
        
        # –§—ñ–∫—Å—É—î–º–æ –∫–∞–º–µ—Ä—É (—â–æ–± –≤—Å—ñ –º–∞–Ω–¥–∞–ª–∏ –±—É–ª–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ –≤–µ–ª–∏–∫—ñ)
        ax.set_ylim(0, 1.3) # –ü—ñ–¥—ñ–±—Ä–∞–Ω–æ –ø—ñ–¥ FIXED_SCALE = 0.12
        ax.set_axis_off()
        return fig

    # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    col1, col2, col3 = st.columns([1, 2, 1]) 

    with col2:
        fig = generate_mandala()
        st.pyplot(fig)
        
        # –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        buf = io.BytesIO()
        fig.savefig(buf, format="png", facecolor='black', dpi=300)
        st.download_button(label="üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–Ω–¥–∞–ª—É (PNG)", data=buf.getvalue(), 
                           file_name=f"mandala.png", mime="image/png")
