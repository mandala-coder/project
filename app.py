import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")

st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ-–º–∏—Å—Ç–µ—Ü—å–∫–∏–π –ø—Ä–æ—î–∫—Ç. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö")
st.markdown("---")

# 2. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω–¥–∞–ª–∏", "üìú –ù–∞—É–∫–æ–≤–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è –º–æ–¥–µ–ª—ñ")
    st.write("""
    –ü—Ä–æ—î–∫—Ç –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –ø–æ–±—É–¥–æ–≤—ñ –±–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤–æ—ó –≥—Ä–∞—Ñ—ñ—á–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –≤ –ø–æ–ª—è—Ä–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö $(r, \\theta)$. 
    –ü—Ä–æ—Å—Ç—ñ—Ä –Ω–æ—Ä–º–æ–≤–∞–Ω–æ –¥–æ –æ–¥–∏–Ω–∏—á–Ω–æ–≥–æ –∫–æ–ª–∞ $R_{max} \\approx 1.0$.
    """)

    # --- –ó–†–Ü–°–¢ (–í–ò–ü–†–ê–í–õ–ï–ù–û) ---
    st.subheader("1. –§–æ–Ω–æ–≤–∞ –≥–∞—Ä–º–æ–Ω—ñ–∫–∞ (–ó—Ä—ñ—Å—Ç)")
    st.write("–ó—Ä—ñ—Å—Ç ($H$) –≤–∏–∑–Ω–∞—á–∞—î —á–∞—Å—Ç–æ—Ç—É –∫—É—Ç–æ–≤–∏—Ö –∫–æ–ª–∏–≤–∞–Ω—å ($k$) –¥–ª—è —Ñ–æ–Ω–æ–≤–æ—ó —Ñ—ñ–≥—É—Ä–∏ (–ì—ñ–ø–æ—Ç—Ä–æ—Ö–æ—ó–¥–∏). –¶–µ —Å—Ç–≤–æ—Ä—é—î –∫–∞—Ä–∫–∞—Å –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ.")
    st.latex(r"r_{bg} = 0.5 + 0.4 \cdot \cos\left( \frac{H}{10} \cdot \theta \right)")
    st.write("""
    * **–í–∏—Å–æ–∫–∏–π –∑—Ä—ñ—Å—Ç:** –í–∏—Å–æ–∫–∞ —á–∞—Å—Ç–æ—Ç–∞ –∫–æ–ª–∏–≤–∞–Ω—å $\to$ —Å–∫–ª–∞–¥–Ω–∞, –±–∞–≥–∞—Ç–æ–≥—Ä–∞–Ω–Ω–∞ –∑—ñ—Ä–∫–∞ –Ω–∞ —Ñ–æ–Ω—ñ.
    * **–ö–æ–º–ø–∞–∫—Ç–Ω–∏–π –∑—Ä—ñ—Å—Ç:** –ù–∏–∑—å–∫–∞ —á–∞—Å—Ç–æ—Ç–∞ $\to$ –ª–∞–∫–æ–Ω—ñ—á–Ω–∞, —Å—Ç—ñ–π–∫–∞ —Ñ—ñ–≥—É—Ä–∞ (—Ç—Ä–∏–∫—É—Ç–Ω–∏–∫/–∫–≤–∞–¥—Ä–∞—Ç).
    """)

    # --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ï –ö–Ü–õ–¨–¶–ï ---
    st.subheader("2. –¢–æ–ø–æ–ª–æ–≥—ñ—è –Ø–¥—Ä–∞ (–°–æ–Ω)")
    st.write("–ö—ñ–ª—å—Ü–µ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –µ–Ω–µ—Ä–≥–µ—Ç–∏—á–Ω–∏–π —Ä–µ—Å—É—Ä—Å. –ô–æ–≥–æ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å–Ω—É ($S$). –†–∞–¥—ñ—É—Å –æ—Ç–≤–æ—Ä—É ($r_{hole}$):")
    st.latex(r"r_{hole} = R_{core} \cdot \left(1 - \frac{S}{12}\right)")
    st.write("–ü—Ä–∏ $S=12$ –æ—Ç–≤—ñ—Ä –∑–Ω–∏–∫–∞—î (—Å—É—Ü—ñ–ª—å–Ω–∏–π –¥–∏—Å–∫). –ü—Ä–∏ $S=0$ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ª–∏—à–µ –æ–±–æ–ª–æ–Ω–∫–∞.")

    # --- –°–ü–Ü–†–ê–õ–Ü (–í–ò–ü–†–ê–í–õ–ï–ù–û) ---
    st.subheader("3. –°–∏–º–µ—Ç—Ä–∏—á–Ω—ñ —Å–ø—ñ—Ä–∞–ª—ñ —Ä–æ–∑–≤–∏—Ç–∫—É (–í—ñ–∫ —Ç–∞ –ï–Ω–µ—Ä–≥—ñ—è)")
    st.write("–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ä—ñ–≤–Ω—è–Ω–Ω—è **–ê—Ä—Ö—ñ–º–µ–¥–æ–≤–æ—ó —Å–ø—ñ—Ä–∞–ª—ñ** –∑ —Å–∏–º–µ—Ç—Ä—ñ—î—é –æ–±–µ—Ä—Ç–∞–Ω–Ω—è:")
    st.latex(r"r = a + b \cdot \theta")
    st.write("""
    * **–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—É–∫–∞–≤—ñ–≤** —Å–ø—ñ—Ä–∞–ª—ñ ($N$) –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è —Ä—ñ–≤–Ω–µ–º –ï–Ω–µ—Ä–≥—ñ—ó/–í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ.
    * **–î–æ–≤–∂–∏–Ω–∞ —Ä—É–∫–∞–≤–∞** –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –í—ñ–∫–æ–º ($A$).
    """)

    # --- –ü–ï–õ–Æ–°–¢–ö–ò ---
    st.subheader("4. –®–∞—Ä –ø–µ–ª—é—Å—Ç–æ–∫ (–•–∞—Ä–∞–∫—Ç–µ—Ä)")
    st.write("–§–æ—Ä–º–∞ –ø–µ–ª—é—Å—Ç–æ–∫ –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –º—ñ—Å—è—Ü–µ–º –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è ($n$) —Ç–∞ –º–æ–¥—É–ª—é—î—Ç—å—Å—è —Å—Ç–µ–ø–µ–Ω–µ–≤–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é:")
    st.latex(r"r(\theta) = R_{base} + \left| \cos\left(\frac{n}{2}\theta\right) \right|^p")
    st.write("–î–µ –ø–æ–∫–∞–∑–Ω–∏–∫ —Å—Ç–µ–ø–µ–Ω—è $p$ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç—É —Ç–∞ —Å—Ç–∞—Ç—ñ.")

with tab1:
    # –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø
    st.sidebar.header("üìã –¢–≤–æ—ó –¥–∞–Ω—ñ")
    with st.sidebar:
        n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 6)
        d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 15)
        
        # –ó—Ä—ñ—Å—Ç —Ç–µ–ø–µ—Ä "–ß–∞—Å—Ç–æ—Ç–∞"
        H = st.slider("–ó—Ä—ñ—Å—Ç (—Å–º)", 100, 220, 170, help="–í–∏–∑–Ω–∞—á–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫—É—Ç—ñ–≤ —Ñ–æ–Ω–æ–≤–æ—ó –∑—ñ—Ä–∫–∏.")
        A = st.slider("–í—ñ–∫", 10, 100, 45)
        
        # –°–æ–Ω - –ª–æ–≥—ñ–∫–∞ "–¥—ñ—Ä–∫–∏"
        S = st.slider("–ì–æ–¥–∏–Ω —Å–Ω—É", 0, 12, 8, help="–í–ø–ª–∏–≤–∞—î –Ω–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ—Å—Ç—å —Ü–µ–Ω—Ç—Ä—É.")
        
        st.markdown("---")
        E = st.slider("–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å", 1, 10, 5, help="–í–ø–ª–∏–≤–∞—î –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—ñ—Ä–∞–ª–µ–π.")
        T = st.slider("–ï–Ω–µ—Ä–≥—ñ—è", 1, 10, 5, help="–í–ø–ª–∏–≤–∞—î –Ω–∞ –¥–æ–≤–∂–∏–Ω—É —Å–ø—ñ—Ä–∞–ª–µ–π.")
        
        st.markdown("---")
        G = st.radio("–°—Ç–∞—Ç—å", options=[1, -1], format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞" if x == 1 else "–ñ—ñ–Ω–æ—á–∞")
        temp = st.selectbox("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç", options=["–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫", "–•–æ–ª–µ—Ä–∏–∫", "–§–ª–µ–≥–º–∞—Ç–∏–∫", "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫"])
        eye_choice = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", options=[1, 2, 3, 4], 
                                  format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])

    # –ì–†–ê–§–Ü–ß–ù–ê –õ–û–ì–Ü–ö–ê
    def generate_mandala():
        style_map = {
            "–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫": {"lw": 2.0, "alpha": 0.8, "ls": "-", "f_alpha": 0.4},
            "–•–æ–ª–µ—Ä–∏–∫":   {"lw": 4.0, "alpha": 1.0, "ls": "-", "f_alpha": 0.6},
            "–§–ª–µ–≥–º–∞—Ç–∏–∫": {"lw": 6.0, "alpha": 0.4, "ls": "-", "f_alpha": 0.2},
            "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫": {"lw": 0.8, "alpha": 0.8, "ls": "--", "f_alpha": 0.2}
        }
        s = style_map[temp]
        
        color_maps = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}
        selected_cmap = color_maps.get(eye_choice, cm.plasma)
        
        # –í–∏—Å–æ–∫–∞ —Ä–æ–∑–¥—ñ–ª—å–Ω–∞ –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å
        t = np.linspace(0, 20 * np.pi, 5000)
        
        fig = plt.figure(figsize=(6, 6), facecolor='black')
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        # === 1. –§–û–ù –í–Ü–î –ó–†–û–°–¢–£ (–ì—ñ–ø–æ—Ç—Ä–æ—Ö–æ—ó–¥–∞ / –ó—ñ—Ä–∫–∞) ===
        # H –¥—ñ–ª–∏–º–æ –Ω–∞ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ü—ñ–ª–µ —á–∏—Å–ª–æ "–ø–µ–ª—é—Å—Ç–æ–∫" —Ñ–æ–Ω—É
        # –ù–∞–ø—Ä–∏–∫–ª–∞–¥: 150 —Å–º -> 15 –≤–µ—Ä—à–∏–Ω, 200 —Å–º -> 20 –≤–µ—Ä—à–∏–Ω.
        freq_h = int(H / 10) 
        
        # –†—ñ–≤–Ω—è–Ω–Ω—è: r = A + B * cos(k * theta)
        r_bg = 0.8 + 0.1 * np.cos(freq_h * t)
        
        # –ú–∞–ª—é—î–º–æ —Ñ–æ–Ω —Ç–æ–Ω–∫–æ—é –ª—ñ–Ω—ñ—î—é
        ax.plot(t, r_bg, color=selected_cmap(0.2), linewidth=0.8, alpha=0.5)
        # –î–æ–¥–∞—î–º–æ –∑–∞–ª–∏–≤–∫—É —Ñ–æ–Ω—É
        ax.fill(t, r_bg, color=selected_cmap(0.05), alpha=0.1)

        # === 2. –¶–ï–ù–¢–†–ê–õ–¨–ù–ï –ö–Ü–õ–¨–¶–ï (–°–û–ù) ===
        # –§—ñ–∫—Å–æ–≤–∞–Ω–∏–π –∑–æ–≤–Ω—ñ—à–Ω—ñ–π —Ä–∞–¥—ñ—É—Å —è–¥—Ä–∞
        R_core = 0.25
        
        # –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ä–∞–¥—ñ—É—Å (–¥—ñ—Ä–∫–∞)
        hole_ratio = 1 - (S / 12.0)
        hole_ratio = max(0.0, min(0.90, hole_ratio)) # –û–±–º–µ–∂—É—î–º–æ
        r_hole = R_core * hole_ratio
        
        t_circle = np.linspace(0, 2*np.pi, 500)
        ax.fill_between(t_circle, r_hole, R_core, color=selected_cmap(0.9), alpha=s["f_alpha"] + 0.3)
        ax.plot(t_circle, [R_core]*len(t_circle), color='white', linewidth=s["lw"]*0.5, alpha=0.6)
        
        # === 3. –ü–ï–õ–Æ–°–¢–ö–ò (–ú–Ü–°–Ø–¶–¨ n) ===
        e_val = (11 - E) / 2 # –ì–æ—Å—Ç—Ä–æ—Ç–∞
        # –ü–µ–ª—é—Å—Ç–∫–∏ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –≤—ñ–¥ —è–¥—Ä–∞
        r_rose = R_core + (np.abs(np.cos(n/2 * t_circle)))**e_val * 0.3
        
        ax.fill(t_circle, r_rose, color=selected_cmap(0.3), alpha=s["f_alpha"])
        ax.plot(t_circle, r_rose, color=selected_cmap(0.4), linewidth=s["lw"], linestyle=s["ls"])
        
        # === 4. –°–ò–ú–ï–¢–†–ò–ß–ù–Ü –°–ü–Ü–†–ê–õ–Ü (–í–Ü–ö + –ï–ù–ï–†–ì–Ü–Ø) ===
        # –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä—É–∫–∞–≤—ñ–≤ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ E (–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å/–ï–Ω–µ—Ä–≥—ñ—è)
        num_arms = max(3, int(E * 1.5)) 
        
        for i in range(num_arms):
            # –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∫—É—Ç –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—É–∫–∞–≤–∞ (—Å–∏–º–µ—Ç—Ä—ñ—è)
            angle_offset = (2 * np.pi / num_arms) * i
            
            # –î–æ–≤–∂–∏–Ω–∞ —Å–ø—ñ—Ä–∞–ª—ñ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –≤—ñ–∫—É A
            # –ß–∏–º —Å—Ç–∞—Ä—à–∏–π, —Ç–∏–º –¥–æ–≤—à–∏–π "—à–ª—è—Ö"
            spiral_len = A / 15.0 
            t_spiral = np.linspace(0, spiral_len, 200)
            
            # –†—ñ–≤–Ω—è–Ω–Ω—è —Å–ø—ñ—Ä–∞–ª—ñ: r —Ä–æ—Å—Ç–µ –≤—ñ–¥ –∫—Ä–∞—é –ø–µ–ª—é—Å—Ç–æ–∫ –¥–æ –º–µ–∂—ñ
            # –î–æ–¥–∞—î–º–æ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è
            r_start = r_rose.max() # –ü–æ—á–∏–Ω–∞—î–º–æ –≤—ñ–¥ –∫—Ä–∞—é –ø–µ–ª—é—Å—Ç–∫–∏
            r_spiral_line = r_start + t_spiral * 0.15 # –®–≤–∏–¥–∫—ñ—Å—Ç—å —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è
            
            # –ú–æ–¥—É–ª—è—Ü—ñ—è –ª—ñ–Ω—ñ—ó (—Ç—Ä–µ–º—Ç—ñ–Ω–Ω—è –≤—ñ–¥ –¥–Ω—è –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è)
            wobble = 0.01 * np.sin(d * t_spiral * 5)
            
            # –ù–∞–ø—Ä—è–º–æ–∫ –∑–∞–∫—Ä—É—á—É–≤–∞–Ω–Ω—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Å—Ç–∞—Ç—ñ G
            theta_final = t_spiral * G + angle_offset
            
            ax.plot(theta_final, r_spiral_line + wobble, 
                    color=selected_cmap(0.6 + i/num_arms/3), 
                    linewidth=s["lw"]*0.6, alpha=0.8)

        # === 5. –ó–û–í–ù–Ü–®–ù–Ø –ú–ï–ñ–ê ===
        p_val = 0.4 if G == 1 else 1.5
        crown_mod = (np.abs(np.sin(d * t_circle)))**p_val
        r_border = 1.05 + 0.05 * crown_mod
        
        ax.plot(t_circle, r_border, color=selected_cmap(0.8), linewidth=s["lw"], alpha=0.9)
        
        # --- –§–Ü–ö–°–ê–¶–Ü–Ø –ö–ê–ú–ï–†–ò ---
        ax.set_ylim(0, 1.2)
        ax.set_axis_off()
        
        return fig

    # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    col1, col2, col3 = st.columns([1, 2, 1]) 

    with col2:
        fig = generate_mandala()
        st.pyplot(fig)
        
        # –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        buf = io.BytesIO()
        fig.savefig(buf, format="png", facecolor='black', dpi=300)
        st.download_button(label="üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–Ω–¥–∞–ª—É (PNG)", data=buf.getvalue(), 
                           file_name=f"mandala.png", mime="image/png")


