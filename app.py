import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")

st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ-–º–∏—Å—Ç–µ—Ü—å–∫–∏–π –ø—Ä–æ—î–∫—Ç. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö")
st.markdown("---")

# 2. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω–¥–∞–ª–∏", "üìú –ù–∞—É–∫–æ–≤–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü—ñ—è –º–æ–¥–µ–ª—ñ")
    st.write("""
    –ü—Ä–æ—î–∫—Ç –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –ø–æ–±—É–¥–æ–≤—ñ –±–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤–æ—ó –≥—Ä–∞—Ñ—ñ—á–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –≤ –ø–æ–ª—è—Ä–Ω–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö $(r, \\theta)$. 
    –ö–æ–∂–Ω–∞ –ª—ñ–Ω—ñ—è —î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –æ–±—á–∏—Å–ª–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó, –¥–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –≤–∏—Å—Ç—É–ø–∞—é—Ç—å –≤—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
    """)

    # --- –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –ú–ê–°–®–¢–ê–ë ---
    st.subheader("1. –ì–ª–æ–±–∞–ª—å–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è")
    st.write("–©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –≤–∏—Ö–æ–¥—É –∑–∞ –º–µ–∂—ñ –∫–∞–¥—Ä—É, –ø—Ä–æ—Å—Ç—ñ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–ª–∏–≤–æ–≥–æ –∑—Ä–æ—Å—Ç—É ($H_{max}=220$). –ó—Ä—ñ—Å—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤–∏–∑–Ω–∞—á–∞—î –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É:")
    st.latex(r"S_{global} = \frac{H}{160} \cdot \frac{1}{\frac{S}{5} + 6}")
    st.write("–í–∏—Å–æ–∫–∞ –ª—é–¥–∏–Ω–∞ —Å—Ç–≤–æ—Ä—é—î –µ–∫—Å–ø–∞–Ω—Å–∏–≤–Ω—É –º–∞–Ω–¥–∞–ª—É, —â–æ –ø—Ä–∞–≥–Ω–µ –¥–æ –º–µ–∂ –∫–∞–¥—Ä—É, —Ç–æ–¥—ñ —è–∫ –Ω–µ–≤–∏—Å–æ–∫–∏–π –∑—Ä—ñ—Å—Ç —Ñ–æ—Ä–º—É—î –∫–æ–º–ø–∞–∫—Ç–Ω—É, —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É.")

    # --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ï –ö–Ü–õ–¨–¶–ï ---
    st.subheader("2. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ –∫—ñ–ª—å—Ü–µ")
    st.write("–ö—ñ–ª—å—Ü–µ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –±–∞–∑–æ–≤—É –æ–ø–æ—Ä—É –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ. –ô–æ–≥–æ —Ä–∞–¥—ñ—É—Å —Ç–∞ —à–∏—Ä–∏–Ω–∞ –∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ –ø–æ–∫–∞–∑–Ω–∏–∫–∞ —Å–Ω—É ($S$):")
    st.latex(r"r_{in} = \frac{S}{5} \cdot S_{global}")
    st.latex(r"r_{out} = r_{in} + (0.05 + 0.08 \cdot S) \cdot S_{global}")
    st.write("–ü–æ–∫–∞–∑–Ω–∏–∫ —Å–Ω—É ($S$) –∫–µ—Ä—É—î –¥–≤–æ–º–∞ –≤–µ–∫—Ç–æ—Ä–∞–º–∏: –∑–º—ñ—â–µ–Ω–Ω—è–º –∫—ñ–ª—å—Ü—è –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É —Ç–∞ –π–æ–≥–æ —Ñ—ñ–∑–∏—á–Ω–æ—é —Ç–æ–≤—â–∏–Ω–æ—é (—â—ñ–ª—å–Ω—ñ—Å—Ç—é —Ä–µ—Å—É—Ä—Å—É).")

    # --- –ü–ï–õ–Æ–°–¢–ö–ò ---
    st.subheader("3. –®–∞—Ä –ø–µ–ª—é—Å—Ç–æ–∫")
    st.write("–§–æ—Ä–º–∞ –ø–µ–ª—é—Å—Ç–æ–∫ –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –º—ñ—Å—è—Ü–µ–º –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è ($n$) —Ç–∞ —Ä—ñ–≤–Ω–µ–º –í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ ($E$):")
    st.latex(r"r(\theta) = r_{out} + 0.4 \cdot S_{global} + \left| \cos\left(\frac{n}{2}\theta\right) \right|^p \cdot 2.5 \cdot S_{global}")
    st.write("–î–µ –ø–æ–∫–∞–∑–Ω–∏–∫ —Å—Ç–µ–ø–µ–Ω—è $p = (11 - E) / 2$. –ü—Ä–∏ –∑–±—ñ–ª—å—à–µ–Ω–Ω—ñ $E$ (–í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ) —Ñ–æ—Ä–º–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—î—Ç—å—Å—è –≤—ñ–¥ –º'—è–∫–æ—ó –¥–æ –≤–µ–∫—Ç–æ—Ä–æ–ø–æ–¥—ñ–±–Ω–æ—ó (–≥–æ—Å—Ç—Ä–æ—ó).")

    # --- –°–ü–Ü–†–ê–õ–Ü ---
    st.subheader("4. –ü–æ–ª–µ —Å–ø—ñ—Ä–∞–ª–µ–π")
    st.write("–í—ñ–∫ ($A$) –≤–∏–∑–Ω–∞—á–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —à–∞—Ä—ñ–≤. –ö–æ–∂–Ω–∞ –ª—ñ–Ω—ñ—è –æ–±–µ—Ä—Ç–∞—î—Ç—å—Å—è –Ω–∞ –∫—É—Ç $\Phi$, —â–æ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –ï–Ω–µ—Ä–≥—ñ—ó ($T$) —Ç–∞ –°—Ç–∞—Ç—ñ ($G$):")
    st.latex(r"\Phi_{rot} = G \cdot \left( i \cdot \frac{T}{10} \cdot \pi \right)")
    st.write("–ü–∞—Ä–∞–º–µ—Ç—Ä $G$ –¥—ñ—î —è–∫ —ñ–Ω–≤–µ—Ä—Ç–æ—Ä –∑–Ω–∞–∫—É, –∑–º—ñ–Ω—é—é—á–∏ –Ω–∞–ø—Ä—è–º–æ–∫ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –≤—Å—ñ—î—ó —Å–∏—Å—Ç–µ–º–∏ (–¥–∑–µ—Ä–∫–∞–ª—å–Ω–∞ —Å–∏–º–µ—Ç—Ä—ñ—è).")

    # --- –ö–û–†–û–ù–ê ---
    st.subheader("5. –ó–æ–≤–Ω—ñ—à–Ω—è –º–µ–∂–∞")
    st.write("–©–æ–± –ø—ñ–¥–∫—Ä–µ—Å–ª–∏—Ç–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –≤–µ–∫—Ç–æ—Ä–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ —Å—Ç–µ–ø–µ–Ω–µ–≤—É –º–æ–¥—É–ª—è—Ü—ñ—é:")
    st.latex(r"R_{border} = R_{max} + 0.5 \cdot S_{global} \cdot |\sin(d \cdot \theta)|^p")
    st.write("""
    * **–ß–æ–ª–æ–≤—ñ—á–∏–π –≤–µ–∫—Ç–æ—Ä ($p=0.4$):** —Å—Ç–≤–æ—Ä—é—î —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ñ—Å—Ç—å.
    * **–ñ—ñ–Ω–æ—á–∏–π –≤–µ–∫—Ç–æ—Ä ($p=1.5$):** —Å—Ç–≤–æ—Ä—é—î –æ—Ä–≥–∞–Ω—ñ—á–Ω—ñ—Å—Ç—å.
    """)

    # --- –¢–ï–ú–ü–ï–†–ê–ú–ï–ù–¢ ---
    st.subheader("6. –ì—Ä–∞—Ñ—ñ—á–Ω–∞ —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—è —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç—É")
    st.write("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç –≤–∏–∑–Ω–∞—á–∞—î –≤—ñ–∑—É–∞–ª—å–Ω—É —â—ñ–ª—å–Ω—ñ—Å—Ç—å —Ç–∞ '—Ñ—ñ–∑–∏–∫—É' –ª—ñ–Ω—ñ—ó:")
    st.write("""
   * **–•–æ–ª–µ—Ä–∏–∫:** –¢–æ–≤—Å—Ç–∞ —ñ –Ω–∞—Å–∏—á–µ–Ω–∞ –ª—ñ–Ω—ñ—è. –°–∏–º–≤–æ–ª –µ–Ω–µ—Ä–≥—ñ—ó —Ç–∞ —Å–∏–ª–∏.
    * **–§–ª–µ–≥–º–∞—Ç–∏–∫:** –®–∏—Ä–æ–∫–∞, –∞–ª–µ –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∞ —Å–º—É–≥–∞. –°–∏–º–≤–æ–ª —Å–ø–æ–∫–æ—é —Ç–∞ –≤—Ä—ñ–≤–Ω–æ–≤–∞–∂–µ–Ω–æ—Å—Ç—ñ.
    * **–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫:** –ß—ñ—Ç–∫–∞ –ª—ñ–Ω—ñ—è —Å–µ—Ä–µ–¥–Ω—å–æ—ó —Ç–æ–≤—â–∏–Ω–∏. –°–∏–º–≤–æ–ª –±–∞–ª–∞–Ω—Å—É —Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.
    * **–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫:** –¢–æ–Ω–µ–Ω—å–∫–∏–π –ø—É–Ω–∫—Ç–∏—Ä. –°–∏–º–≤–æ–ª —á—É—Ç–ª–∏–≤–æ—Å—Ç—ñ —Ç–∞ –Ω—ñ–∂–Ω–æ—Å—Ç—ñ.
    """)
    
with tab1:
    # –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø
    st.sidebar.header("üìã –¢–≤–æ—ó –¥–∞–Ω—ñ")
    with st.sidebar:
        n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 6)
        d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 15)
        # –ó—Ä—ñ—Å—Ç —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ
        H = st.slider("–ó—Ä—ñ—Å—Ç (—Å–º)", 100, 220, 170)
        A = st.slider("–í—ñ–∫", 10, 100, 45)
        S = st.slider("–ì–æ–¥–∏–Ω —Å–Ω—É", 0, 15, 8)
        
        st.markdown("---")
        E = st.slider("–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å", 0, 10, 5, help="–ó–º—ñ–Ω—é—î –ì–û–°–¢–†–û–¢–£ –ø–µ–ª—é—Å—Ç–æ–∫.")
        T = st.slider("–ï–Ω–µ—Ä–≥—ñ—è", 0, 10, 5, help="–ó–º—ñ–Ω—é—î –ó–ê–ö–†–£–ß–ï–ù–Ü–°–¢–¨ —Å–ø—ñ—Ä–∞–ª—ñ.")
        
        st.markdown("---")
        G = st.radio("–°—Ç–∞—Ç—å", options=[1, -1], format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞" if x == 1 else "–ñ—ñ–Ω–æ—á–∞")
        temp = st.selectbox("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç", options=["–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫", "–•–æ–ª–µ—Ä–∏–∫", "–§–ª–µ–≥–º–∞—Ç–∏–∫", "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫"])
        eye_choice = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", options=[1, 2, 3, 4], 
                                    format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])

    # –ì–†–ê–§–Ü–ß–ù–ê –õ–û–ì–Ü–ö–ê
    def generate_mandala():
        style_map = {
            "–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫": {"lw": 2.0, "alpha": 0.8, "ls": "-", "f_alpha": 0.4},
            "–•–æ–ª–µ—Ä–∏–∫":   {"lw": 4.0, "alpha": 1.0, "ls": "-", "f_alpha": 0.6},
            "–§–ª–µ–≥–º–∞—Ç–∏–∫": {"lw": 6.0, "alpha": 0.4, "ls": "-", "f_alpha": 0.2},
            "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫": {"lw": 0.8, "alpha": 0.8, "ls": "--", "f_alpha": 0.2}
        }
        s = style_map[temp]
        
        color_maps = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}
        selected_cmap = color_maps.get(eye_choice, cm.plasma)
        
        t = np.linspace(0, 2 * np.pi, 2500)
        
        fig = plt.figure(figsize=(6, 6), facecolor='black')
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        # --- –õ–û–ì–Ü–ö–ê –ú–ê–°–®–¢–ê–ë–£–í–ê–ù–ù–Ø (–ó–†–Ü–°–¢ H) ---
        base_scale = 1 / (S/5 + 6)
        
        # H / 160 –¥–∞—î –∫—Ä–∞—â–∏–π –±–∞–ª–∞–Ω—Å. 
        # –ü—Ä–∏ 160 —Å–º = –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç 1.0. –ü—Ä–∏ 220 —Å–º = 1.375.
        height_multiplier = H / 160 
        
        global_scale = base_scale * height_multiplier
        
        # 1. –¶–ï–ù–¢–†–ê–õ–¨–ù–ï –ö–Ü–õ–¨–¶–ï
        r_in = (S / 5) * global_scale
        r_thickness = (0.05 + S * 0.08) * global_scale 
        r_out = r_in + r_thickness
        
        ax.fill_between(t, r_in, r_out, color=selected_cmap(0.9), alpha=(s["f_alpha"] + 0.3))
        ax.plot(t, np.full_like(t, r_in), color='white', linewidth=0.3, alpha=0.3)
        ax.plot(t, np.full_like(t, r_out), color='white', linewidth=s["lw"]*0.5, alpha=s["alpha"])

        # 2. –ü–ï–õ–Æ–°–¢–ö–ò
        e_val = (11 - E) / 2
        r_rose_base = r_out + 0.4 * global_scale
        r_rose = r_rose_base + (np.abs(np.cos(n/2 * t)))**e_val * 2.5 * global_scale
        ax.fill(t, r_rose, color=selected_cmap(0.3), alpha=s["f_alpha"])
        ax.plot(t, r_rose, color=selected_cmap(0.2), linewidth=s["lw"], linestyle=s["ls"])
        
        # 3. –ü–û–õ–ï –°–ü–Ü–†–ê–õ–ï–ô
        max_r_rose = r_rose.max()
        for i in range(1, A + 1):
            s_step = i / A
            rotation = G * i * (T / 10) * (np.pi / 2.5)
            r_spiral = max_r_rose + s_step * 3.5 * global_scale
            ax.plot(t + rotation, r_spiral * (1 + 0.03 * np.sin(d * t)), 
                    color=selected_cmap(s_step), linewidth=s["lw"]*0.4, alpha=s["alpha"]*0.5)
        
        # 4. –ó–û–í–ù–Ü–®–ù–Ø –ú–ï–ñ–ê
        p_val = 0.4 if G == 1 else 1.5
        crown_mod = (np.abs(np.sin(d * t)))**p_val
        r_border = (r_spiral.max() + 0.6 * global_scale) + (0.5 * global_scale * crown_mod)
        ax.plot(t, r_border, color=selected_cmap(0.6), linewidth=s["lw"]*1.5, alpha=0.9)
        
        # --- –§–Ü–ö–°–ê–¶–Ü–Ø –ö–ê–ú–ï–†–ò –ù–ê –ú–ê–ö–°–ò–ú–£–ú ---
        # –ú–∏ —Å—Ç–∞–≤–∏–º–æ –ª—ñ–º—ñ—Ç 2.2.
        # –ù–∞–≤—ñ—Ç—å –ø—Ä–∏ –∑—Ä—ñ—Å—Ç—ñ 220 —Å–º —Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —Å–Ω—ñ —Ä–∞–¥—ñ—É—Å –º–∞–Ω–¥–∞–ª–∏ –Ω–µ –ø–µ—Ä–µ–≤–∏—â–∏—Ç—å ~2.0.
        # –¢–æ–º—É –ø—Ä–∏ 220 —Å–º –≤–æ–Ω–∞ –±—É–¥–µ –≤–∏–≥–ª—è–¥–∞—Ç–∏ –≤–µ–ª–∏–∫–æ—é, –∞–ª–µ –Ω–µ –æ–±—Ä—ñ–∂–µ—Ç—å—Å—è.
        ax.set_ylim(0, 2.2)
        ax.set_axis_off()
        
        return fig

    # –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    col1, col2, col3 = st.columns([1, 2, 1]) 

    with col2:
        fig = generate_mandala()
        st.pyplot(fig)
        
        # –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        buf = io.BytesIO()
        fig.savefig(buf, format="png", facecolor='black', dpi=300)
        st.download_button(label="üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–Ω–¥–∞–ª—É (PNG)", data=buf.getvalue(), 
                           file_name=f"mandala.png", mime="image/png")

