import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io
import time  # <--- Ð”ÐžÐ”ÐÐÐž Ð”Ð›Ð¯ ÐÐÐ†ÐœÐÐ¦Ð†Ð‡

# 1. ÐÐÐ›ÐÐ¨Ð¢Ð£Ð’ÐÐÐÐ¯ Ð¡Ð¢ÐžÐ Ð†ÐÐšÐ˜
st.set_page_config(page_title="ÐœÐ°Ð½Ð´Ð°Ð»Ð° Ð¾ÑÐ¾Ð±Ð¸ÑÑ‚Ð¾ÑÑ‚Ñ–", layout="wide")

st.title("ðŸŽ¨ Ð¦Ð¸Ñ„Ñ€Ð¾Ð²Ð° Ð¼Ð°Ð½Ð´Ð°Ð»Ð° Ð¾ÑÐ¾Ð±Ð¸ÑÑ‚Ð¾ÑÑ‚Ñ–")
st.write("### ÐœÐ°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾-Ð¼Ð¸ÑÑ‚ÐµÑ†ÑŒÐºÐ¸Ð¹ Ð¿Ñ€Ð¾Ñ”ÐºÑ‚. Ð’Ñ–Ð·ÑƒÐ°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ð¸Ñ… Ð´Ð°Ð½Ð¸Ñ…")
st.markdown("---")

# 2. Ð’ÐšÐ›ÐÐ”ÐšÐ˜
tab1, tab2 = st.tabs(["ðŸš€ Ð“ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð¼Ð°Ð½Ð´Ð°Ð»Ð¸", "ðŸ“œ ÐÐ°ÑƒÐºÐ¾Ð²Ðµ Ð¾Ð±Ò‘Ñ€ÑƒÐ½Ñ‚ÑƒÐ²Ð°Ð½Ð½Ñ"])

with tab2:
    st.header("ÐœÐ°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð° Ð´ÐµÐºÐ¾Ð¼Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ Ð¼Ð¾Ð´ÐµÐ»Ñ–")
    st.write("""
    ÐŸÑ€Ð¾Ñ”ÐºÑ‚ Ð±Ð°Ð·ÑƒÑ”Ñ‚ÑŒÑÑ Ð½Ð° Ð¿Ð¾Ð±ÑƒÐ´Ð¾Ð²Ñ– Ð±Ð°Ð³Ð°Ñ‚Ð¾ÑˆÐ°Ñ€Ð¾Ð²Ð¾Ñ— Ð³Ñ€Ð°Ñ„Ñ–Ñ‡Ð½Ð¾Ñ— ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸ Ð² Ð¿Ð¾Ð»ÑÑ€Ð½Ð¸Ñ… ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ð°Ñ… $(r, \\theta)$. 
    ÐšÐ¾Ð¶Ð½Ð° Ð»Ñ–Ð½Ñ–Ñ Ñ” Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð¼ Ð¾Ð±Ñ‡Ð¸ÑÐ»ÐµÐ½Ð½Ñ Ñ„ÑƒÐ½ÐºÑ†Ñ–Ñ—, Ð´Ðµ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð²Ð¸ÑÑ‚ÑƒÐ¿Ð°ÑŽÑ‚ÑŒ Ð²Ñ…Ñ–Ð´Ð½Ñ– Ð´Ð°Ð½Ñ– ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°.
    """)

    # --- Ð“Ð›ÐžÐ‘ÐÐ›Ð¬ÐÐ˜Ð™ ÐœÐÐ¡Ð¨Ð¢ÐÐ‘ ---
    st.subheader("1. Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ðµ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±ÑƒÐ²Ð°Ð½Ð½Ñ")
    st.write("Ð”Ð»Ñ Ð¿Ñ€Ð¸Ð²ÐµÐ´ÐµÐ½Ð½Ñ Ñ„Ñ–Ð·Ð¸Ñ‡Ð½Ð¸Ñ… Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð½ Ð´Ð¾ Ð¾Ð´Ð¸Ð½Ð¸Ñ†ÑŒ Ð³Ñ€Ð°Ñ„Ñ–Ñ‡Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ð¾Ñ‚Ð½Ð° Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ñ‚ÑŒÑÑ ÐºÐ¾ÐµÑ„Ñ–Ñ†Ñ–Ñ”Ð½Ñ‚ Ð½Ð¾Ñ€Ð¼Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ—:")
    st.latex(r"S_{global} = \frac{1}{\frac{H}{100} + \frac{S}{5} + 6}")
    st.write("Ð¦Ðµ Ð³Ð°Ñ€Ð°Ð½Ñ‚ÑƒÑ” ÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ñ–ÑÑ‚ÑŒ ÐºÐ¾Ð¼Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ— Ð½ÐµÐ·Ð°Ð»ÐµÐ¶Ð½Ð¾ Ð²Ñ–Ð´ Ð²Ñ…Ñ–Ð´Ð½Ð¸Ñ… Ð´Ð°Ð½Ð¸Ñ….")

    # --- Ð¦Ð•ÐÐ¢Ð ÐÐ›Ð¬ÐÐ• ÐšÐ†Ð›Ð¬Ð¦Ð• ---
    st.subheader("2. Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ðµ ÐºÑ–Ð»ÑŒÑ†Ðµ")
    st.write("ÐšÑ–Ð»ÑŒÑ†Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ–Ð·ÑƒÑ” Ð±Ð°Ð·Ð¾Ð²Ñƒ Ð¾Ð¿Ð¾Ñ€Ñƒ Ð¾ÑÐ¾Ð±Ð¸ÑÑ‚Ð¾ÑÑ‚Ñ–. Ð™Ð¾Ð³Ð¾ Ñ€Ð°Ð´Ñ–ÑƒÑ Ñ‚Ð° ÑˆÐ¸Ñ€Ð¸Ð½Ð° Ð·Ð°Ð»ÐµÐ¶Ð°Ñ‚ÑŒ Ð²Ñ–Ð´ Ð¿Ð¾ÐºÐ°Ð·Ð½Ð¸ÐºÐ° ÑÐ½Ñƒ ($S$):")
    st.latex(r"r_{in} = \frac{S}{5} \cdot S_{global}")
    st.latex(r"r_{out} = r_{in} + (0.05 + 0.08 \cdot S) \cdot S_{global}")
    st.write("ÐŸÐ¾ÐºÐ°Ð·Ð½Ð¸Ðº ÑÐ½Ñƒ ($S$) ÐºÐµÑ€ÑƒÑ” Ð´Ð²Ð¾Ð¼Ð° Ð²ÐµÐºÑ‚Ð¾Ñ€Ð°Ð¼Ð¸: Ð·Ð¼Ñ–Ñ‰ÐµÐ½Ð½ÑÐ¼ ÐºÑ–Ð»ÑŒÑ†Ñ Ð²Ñ–Ð´ Ñ†ÐµÐ½Ñ‚Ñ€Ñƒ Ñ‚Ð° Ð¹Ð¾Ð³Ð¾ Ñ„Ñ–Ð·Ð¸Ñ‡Ð½Ð¾ÑŽ Ñ‚Ð¾Ð²Ñ‰Ð¸Ð½Ð¾ÑŽ (Ñ‰Ñ–Ð»ÑŒÐ½Ñ–ÑÑ‚ÑŽ Ñ€ÐµÑÑƒÑ€ÑÑƒ).")

    # --- ÐŸÐ•Ð›Ð®Ð¡Ð¢ÐšÐ˜ ---
    st.subheader("3. Ð¨Ð°Ñ€ Ð¿ÐµÐ»ÑŽÑÑ‚Ð¾Ðº")
    st.write("Ð¤Ð¾Ñ€Ð¼Ð° Ð¿ÐµÐ»ÑŽÑÑ‚Ð¾Ðº Ð²Ð¸Ð·Ð½Ð°Ñ‡Ð°Ñ”Ñ‚ÑŒÑÑ Ð¼Ñ–ÑÑÑ†ÐµÐ¼ Ð½Ð°Ñ€Ð¾Ð´Ð¶ÐµÐ½Ð½Ñ ($n$) Ñ‚Ð° Ñ€Ñ–Ð²Ð½ÐµÐ¼ Ð’Ð¿ÐµÐ²Ð½ÐµÐ½Ð¾ÑÑ‚Ñ– ($E$):")
    st.latex(r"r(\theta) = r_{out} + 0.4 + \left| \cos\left(\frac{n}{2}\theta\right) \right|^p \cdot 2.5 \cdot S_{global}")
    st.write("Ð”Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð½Ð¸Ðº ÑÑ‚ÐµÐ¿ÐµÐ½Ñ $p = (11 - E) / 2$. ÐŸÑ€Ð¸ Ð·Ð±Ñ–Ð»ÑŒÑˆÐµÐ½Ð½Ñ– $E$ (Ð’Ð¿ÐµÐ²Ð½ÐµÐ½Ð¾ÑÑ‚Ñ–) Ñ„Ð¾Ñ€Ð¼Ð° Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼ÑƒÑ”Ñ‚ÑŒÑÑ Ð²Ñ–Ð´ Ð¼'ÑÐºÐ¾Ñ— Ð´Ð¾ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð¾Ð¿Ð¾Ð´Ñ–Ð±Ð½Ð¾Ñ— (Ð³Ð¾ÑÑ‚Ñ€Ð¾Ñ—).")

    # --- Ð¡ÐŸÐ†Ð ÐÐ›Ð† ---
    st.subheader("4. ÐŸÐ¾Ð»Ðµ ÑÐ¿Ñ–Ñ€Ð°Ð»ÐµÐ¹")
    st.write("Ð’Ñ–Ðº ($A$) Ð²Ð¸Ð·Ð½Ð°Ñ‡Ð°Ñ” ÐºÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ ÑˆÐ°Ñ€Ñ–Ð². ÐšÐ¾Ð¶Ð½Ð° Ð»Ñ–Ð½Ñ–Ñ Ð¾Ð±ÐµÑ€Ñ‚Ð°Ñ”Ñ‚ÑŒÑÑ Ð½Ð° ÐºÑƒÑ‚ $\Phi$, Ñ‰Ð¾ Ð·Ð°Ð»ÐµÐ¶Ð¸Ñ‚ÑŒ Ð²Ñ–Ð´ Ð•Ð½ÐµÑ€Ð³Ñ–Ñ— ($T$) Ñ‚Ð° Ð¡Ñ‚Ð°Ñ‚Ñ– ($G$):")
    st.latex(r"\Phi_{rot} = G \cdot \left( i \cdot \frac{T}{10} \cdot \pi \right)")
    st.write("ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ $G$ Ð´Ñ–Ñ” ÑÐº Ñ–Ð½Ð²ÐµÑ€Ñ‚Ð¾Ñ€ Ð·Ð½Ð°ÐºÑƒ, Ð·Ð¼Ñ–Ð½ÑŽÑŽÑ‡Ð¸ Ð½Ð°Ð¿Ñ€ÑÐ¼Ð¾Ðº Ð¾Ð±ÐµÑ€Ñ‚Ð°Ð½Ð½Ñ Ð²ÑÑ–Ñ”Ñ— ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸ (Ð´Ð·ÐµÑ€ÐºÐ°Ð»ÑŒÐ½Ð° ÑÐ¸Ð¼ÐµÑ‚Ñ€Ñ–Ñ).")

    # --- ÐšÐžÐ ÐžÐÐ ---
    st.subheader("5. Ð—Ð¾Ð²Ð½Ñ–ÑˆÐ½Ñ Ð¼ÐµÐ¶Ð°")
    st.write("Ð©Ð¾Ð± Ð¿Ñ–Ð´ÐºÑ€ÐµÑÐ»Ð¸Ñ‚Ð¸ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€ Ð²ÐµÐºÑ‚Ð¾Ñ€Ð°, Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð½Ð¾ ÑÑ‚ÐµÐ¿ÐµÐ½ÐµÐ²Ñƒ Ð¼Ð¾Ð´ÑƒÐ»ÑÑ†Ñ–ÑŽ:")
    st.latex(r"R_{border} = R_{max} + 0.5 \cdot S_{global} \cdot |\sin(d \cdot \theta)|^p")
    st.write("""
    * **Ð§Ð¾Ð»Ð¾Ð²Ñ–Ñ‡Ð¸Ð¹ Ð²ÐµÐºÑ‚Ð¾Ñ€ ($p=0.4$):** ÑÑ‚Ð²Ð¾Ñ€ÑŽÑ” ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð½Ñ–ÑÑ‚ÑŒ.
    * **Ð–Ñ–Ð½Ð¾Ñ‡Ð¸Ð¹ Ð²ÐµÐºÑ‚Ð¾Ñ€ ($p=1.5$):** ÑÑ‚Ð²Ð¾Ñ€ÑŽÑ” Ð¾Ñ€Ð³Ð°Ð½Ñ–Ñ‡Ð½Ñ–ÑÑ‚ÑŒ.
    """)

    # --- Ð¢Ð•ÐœÐŸÐ•Ð ÐÐœÐ•ÐÐ¢ ---
    st.subheader("6. Ð“Ñ€Ð°Ñ„Ñ–Ñ‡Ð½Ð° Ñ–Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð°Ñ†Ñ–Ñ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ð¼ÐµÐ½Ñ‚Ñƒ")
    st.write("Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ð¼ÐµÐ½Ñ‚ Ð²Ð¸Ð·Ð½Ð°Ñ‡Ð°Ñ” Ð²Ñ–Ð·ÑƒÐ°Ð»ÑŒÐ½Ñƒ Ñ‰Ñ–Ð»ÑŒÐ½Ñ–ÑÑ‚ÑŒ Ñ‚Ð° 'Ñ„Ñ–Ð·Ð¸ÐºÑƒ' Ð»Ñ–Ð½Ñ–Ñ—:")
    st.write("""
    * **Ð¥Ð¾Ð»ÐµÑ€Ð¸Ðº:** Ð¯ÑÐºÑ€Ð°Ð²Ð°, Ð½ÐµÐ¿Ñ€Ð¾Ð·Ð¾Ñ€Ð° Ð»Ñ–Ð½Ñ–Ñ (Ñ–Ð¼Ð¿ÑƒÐ»ÑŒÑÐ¸Ð²Ð½Ñ–ÑÑ‚ÑŒ).
    * **Ð¤Ð»ÐµÐ³Ð¼Ð°Ñ‚Ð¸Ðº:** ÐœÐ°ÑÐ¸Ð²Ð½Ð°, ÑˆÐ¸Ñ€Ð¾ÐºÐ°, Ð°Ð»Ðµ Ð½Ð°Ð¿Ñ–Ð²Ð¿Ñ€Ð¾Ð·Ð¾Ð²Ð° Ð»Ñ–Ð½Ñ–Ñ (Ñ–Ð½ÐµÑ€Ñ‚Ð½Ñ–ÑÑ‚ÑŒ Ñ‚Ð° Ð¾Ð±'Ñ”Ð¼).
    * **Ð¡Ð°Ð½Ð³Ð²Ñ–Ð½Ñ–Ðº:** Ð—Ð±Ð°Ð»Ð°Ð½ÑÐ¾Ð²Ð°Ð½Ð° Ñ‡Ñ–Ñ‚ÐºÐ° Ð»Ñ–Ð½Ñ–Ñ ÑÐµÑ€ÐµÐ´Ð½ÑŒÐ¾Ñ— Ñ‚Ð¾Ð²Ñ‰Ð¸Ð½Ð¸ (ÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ñ–ÑÑ‚ÑŒ).
    * **ÐœÐµÐ»Ð°Ð½Ñ…Ð¾Ð»Ñ–Ðº:** Ð¢Ð¾Ð½ÐºÐ° Ð¿ÑƒÐ½ÐºÑ‚Ð¸Ñ€Ð½Ð° Ð»Ñ–Ð½Ñ–Ñ (Ð²Ð¸ÑÐ¾ÐºÐ° ÑÐµÐ½Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ–ÑÑ‚ÑŒ).
    """)
    
with tab1:
    # ÐŸÐÐÐ•Ð›Ð¬ ÐšÐ•Ð Ð£Ð’ÐÐÐÐ¯
    st.sidebar.header("ðŸ“‹ Ð¢Ð²Ð¾Ñ— Ð´Ð°Ð½Ñ–")
    with st.sidebar:
        n = st.number_input("ÐœÑ–ÑÑÑ†ÑŒ Ð½Ð°Ñ€Ð¾Ð´Ð¶ÐµÐ½Ð½Ñ", 1, 12, 6)
        d = st.number_input("Ð”ÐµÐ½ÑŒ Ð½Ð°Ñ€Ð¾Ð´Ð¶ÐµÐ½Ð½Ñ", 1, 31, 15)
        H = st.slider("Ð—Ñ€Ñ–ÑÑ‚ (ÑÐ¼)", 100, 220, 170)
        A = st.slider("Ð’Ñ–Ðº", 10, 100, 45)
        S = st.slider("Ð“Ð¾Ð´Ð¸Ð½ ÑÐ½Ñƒ", 0, 15, 8)
        
        st.markdown("---")
        E = st.slider("Ð’Ð¿ÐµÐ²Ð½ÐµÐ½Ñ–ÑÑ‚ÑŒ", 0, 10, 5, help="Ð—Ð¼Ñ–Ð½ÑŽÑ” Ð“ÐžÐ¡Ð¢Ð ÐžÐ¢Ð£ Ð¿ÐµÐ»ÑŽÑÑ‚Ð¾Ðº.")
        T = st.slider("Ð•Ð½ÐµÑ€Ð³Ñ–Ñ", 0, 10, 5, help="Ð—Ð¼Ñ–Ð½ÑŽÑ” Ð—ÐÐšÐ Ð£Ð§Ð•ÐÐ†Ð¡Ð¢Ð¬ ÑÐ¿Ñ–Ñ€Ð°Ð»Ñ–.")
        
        st.markdown("---")
        G = st.radio("Ð¡Ñ‚Ð°Ñ‚ÑŒ", options=[1, -1], format_func=lambda x: "Ð§Ð¾Ð»Ð¾Ð²Ñ–Ñ‡Ð°" if x == 1 else "Ð–Ñ–Ð½Ð¾Ñ‡Ð°")
        temp = st.selectbox("Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ð¼ÐµÐ½Ñ‚", options=["Ð¡Ð°Ð½Ð³Ð²Ñ–Ð½Ñ–Ðº", "Ð¥Ð¾Ð»ÐµÑ€Ð¸Ðº", "Ð¤Ð»ÐµÐ³Ð¼Ð°Ñ‚Ð¸Ðº", "ÐœÐµÐ»Ð°Ð½Ñ…Ð¾Ð»Ñ–Ðº"])
        eye_choice = st.selectbox("ÐšÐ¾Ð»Ñ–Ñ€ Ð¾Ñ‡ÐµÐ¹", options=[1, 2, 3, 4], 
                                    format_func=lambda x: {1:"Ð‘Ð»Ð°ÐºÐ¸Ñ‚Ð½Ñ–", 2:"Ð—ÐµÐ»ÐµÐ½Ñ–", 3:"ÐšÐ°Ñ€Ñ–", 4:"Ð¯Ð½Ñ‚Ð°Ñ€Ð½Ñ–"}[x])

    # Ð“Ð ÐÐ¤Ð†Ð§ÐÐ Ð›ÐžÐ“Ð†ÐšÐ
    # Ð”Ð¾Ð´Ð°Ð»Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ phase Ð´Ð»Ñ Ð°Ð½Ñ–Ð¼Ð°Ñ†Ñ–Ñ—
    def generate_mandala(phase=0):
        # Ð”Ð¸Ñ„ÐµÑ€ÐµÐ½Ñ†Ñ–Ð°Ñ†Ñ–Ñ ÑÑ‚Ð¸Ð»Ñ–Ð² Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ð¼ÐµÐ½Ñ‚Ñƒ
        style_map = {
            "Ð¡Ð°Ð½Ð³Ð²Ñ–Ð½Ñ–Ðº": {"lw": 2.0, "alpha": 0.8, "ls": "-", "f_alpha": 0.4},
            "Ð¥Ð¾Ð»ÐµÑ€Ð¸Ðº":   {"lw": 4.0, "alpha": 1.0, "ls": "-", "f_alpha": 0.6},
            "Ð¤Ð»ÐµÐ³Ð¼Ð°Ñ‚Ð¸Ðº": {"lw": 6.0, "alpha": 0.4, "ls": "-", "f_alpha": 0.2},
            "ÐœÐµÐ»Ð°Ð½Ñ…Ð¾Ð»Ñ–Ðº": {"lw": 0.8, "alpha": 0.8, "ls": "--", "f_alpha": 0.2}
        }
        s = style_map[temp]
        
        color_maps = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}
        selected_cmap = color_maps.get(eye_choice, cm.plasma)
        
        t = np.linspace(0, 2 * np.pi, 2000)
        fig = plt.figure(figsize=(6, 6), facecolor='black')
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        global_scale = 1 / (H/100 + S/5 + 6)
        
        # 1. Ð¦Ð•ÐÐ¢Ð ÐÐ›Ð¬ÐÐ• ÐšÐ†Ð›Ð¬Ð¦Ð• (Ð¡Ð¾Ð½ S)
        r_in = (S / 5) * global_scale
        r_thickness = (0.05 + S * 0.08) * global_scale 
        r_out = r_in + r_thickness
        
        # Ð’Ð°Ð¶Ð»Ð¸Ð²Ð¾: fill_between Ð¼Ð°Ð»ÑŽÑ” ÑÐ°Ð¼Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ñ–Ñ€ ÐœÐ†Ð– r_in Ñ‚Ð° r_out
        ax.fill_between(t, r_in, r_out, color=selected_cmap(0.9), alpha=s["f_alpha"] + 0.3)
        
        # ÐšÐ¾Ð½Ñ‚ÑƒÑ€Ð½Ñ– Ð»Ñ–Ð½Ñ–Ñ— ÐºÑ–Ð»ÑŒÑ†Ñ
        ax.plot(t, np.full_like(t, r_in), color='white', linewidth=0.3, alpha=0.3)
        ax.plot(t, np.full_like(t, r_out), color='white', linewidth=s["lw"]*0.5, alpha=s["alpha"])

        # 2. ÐŸÐ•Ð›Ð®Ð¡Ð¢ÐšÐ˜ (Ð’Ð¿ÐµÐ²Ð½ÐµÐ½Ñ–ÑÑ‚ÑŒ E)
        e_val = (11 - E) / 2
        r_rose_base = r_out + 0.4 * global_scale
        r_rose = r_rose_base + (np.abs(np.cos(n/2 * t)))**e_val * 2.5 * global_scale
        ax.fill(t, r_rose, color=selected_cmap(0.3), alpha=s["f_alpha"])
        ax.plot(t, r_rose, color=selected_cmap(0.2), linewidth=s["lw"], linestyle=s["ls"])
        
        # 3. ÐŸÐžÐ›Ð• Ð¡ÐŸÐ†Ð ÐÐ›Ð•Ð™ (Ð•Ð½ÐµÐ³Ñ€Ñ–Ñ T + Ð¡Ñ‚Ð°Ñ‚ÑŒ G)
        max_r_rose = r_rose.max()
        for i in range(1, A + 1):
            s_step = i / A
            # Ð”ÐžÐ”ÐÐ›Ð˜ PHASE Ð”Ð›Ð¯ Ð Ð£Ð¥Ð£
            rotation = G * i * (T / 10) * (np.pi / 2.5) + phase
            r_spiral = max_r_rose + s_step * 3.5 * global_scale
            ax.plot(t + rotation, r_spiral * (1 + 0.03 * np.sin(d * t)), 
                    color=selected_cmap(s_step), linewidth=s["lw"]*0.4, alpha=s["alpha"]*0.5)
        
        # 4. Ð—ÐžÐ’ÐÐ†Ð¨ÐÐ¯ ÐœÐ•Ð–Ð (Ð£Ð´Ð¾ÑÐºÐ¾Ð½Ð°Ð»ÐµÐ½Ð° Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ñ–Ñ ÐºÐ¾Ð½Ñ‚ÑƒÑ€Ñƒ)
        p_val = 0.4 if G == 1 else 1.5
        crown_mod = (np.abs(np.sin(d * t)))**p_val
        
        r_border = (r_spiral.max() + 0.6 * global_scale) + (0.5 * global_scale * crown_mod)
        
        ax.plot(t, r_border, color=selected_cmap(0.6), linewidth=s["lw"]*1.5, alpha=0.9)
        
        ax.set_ylim(0, r_border.max() * 1.1)
        ax.set_axis_off()
        return fig

    # Ð’Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ
    # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ñ‚Ñ€Ð¸ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸. 
    # Ð§Ð¸ÑÐ»Ð° [1, 2, 1] Ð¾Ð·Ð½Ð°Ñ‡Ð°ÑŽÑ‚ÑŒ, Ñ‰Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð° ÐºÐ¾Ð»Ð¾Ð½ÐºÐ° Ð²Ð´Ð²Ñ–Ñ‡Ñ– ÑˆÐ¸Ñ€ÑˆÐ° Ð·Ð° Ð±Ð¾ÐºÐ¾Ð²Ñ–.
    col1, col2, col3 = st.columns([1, 2, 1]) 

    with col2: # ÐœÐ°Ð»ÑŽÑ”Ð¼Ð¾ Ð²ÑÐµ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð² Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ–Ð¹ ÐºÐ¾Ð»Ð¾Ð½Ñ†Ñ–
        # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ð¿ÐµÑ€ÐµÐ¼Ð¸ÐºÐ°Ñ‡ Ð´Ð»Ñ Ð°Ð½Ñ–Ð¼Ð°Ñ†Ñ–Ñ—
        animate = st.checkbox("âœ¨ ÐÐºÑ‚Ð¸Ð²ÑƒÐ²Ð°Ñ‚Ð¸ Ñ€ÑƒÑ…")
        
        # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð¼Ñ–ÑÑ†Ðµ Ð´Ð»Ñ Ð¼Ð°Ð»ÑŽÐ½ÐºÐ°
        plot_placeholder = st.empty()
        
        if animate:
            # Ð¦Ð¸ÐºÐ» Ð°Ð½Ñ–Ð¼Ð°Ñ†Ñ–Ñ—
            phase = 0
            while animate:
                fig = generate_mandala(phase=phase)
                plot_placeholder.pyplot(fig)
                phase += 0.1  # Ð¨Ð²Ð¸Ð´ÐºÑ–ÑÑ‚ÑŒ Ð¾Ð±ÐµÑ€Ñ‚Ð°Ð½Ð½Ñ
                time.sleep(0.05) # ÐŸÐ°ÑƒÐ·Ð° Ð¼Ñ–Ð¶ ÐºÐ°Ð´Ñ€Ð°Ð¼Ð¸
                plt.close(fig) # ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ Ð¿Ð°Ð¼'ÑÑ‚Ñ–
        else:
            # Ð¡Ñ‚Ð°Ñ‚Ð¸Ñ‡Ð½Ðµ Ð²Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ
            fig = generate_mandala(phase=0)
            plot_placeholder.pyplot(fig)
        
        # ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ
        buf = io.BytesIO()
        # Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ð¼Ð¾ Ð¾ÑÑ‚Ð°Ð½Ð½Ñ–Ð¹ Ð·Ð³ÐµÐ½ÐµÑ€Ð¾Ð²Ð°Ð½Ð¸Ð¹ fig
        fig.savefig(buf, format="png", facecolor='black', dpi=300) 
        st.download_button(label="ðŸ“¥ Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ Ð¼Ð°Ð½Ð´Ð°Ð»Ñƒ (PNG)", data=buf.getvalue(), 
                           file_name=f"mandala.png", mime="image/png")
