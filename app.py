import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import io
import time

# 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–¢–û–†–Ü–ù–ö–ò
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ", layout="wide")

st.title("üé® –¶–∏—Ñ—Ä–æ–≤–∞ –º–∞–Ω–¥–∞–ª–∞ –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ")
st.write("### –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ-–º–∏—Å—Ç–µ—Ü—å–∫–∏–π –ø—Ä–æ—î–∫—Ç")
st.markdown("---")

# 2. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞–Ω–¥–∞–ª–∏", "üìú –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab2:
    st.header("üìê –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –º–æ–¥–µ–ª—å –º–∞–Ω–¥–∞–ª–∏")
    st.write("""
    –ü—Ä–æ—î–∫—Ç –±—É–¥—É—î—Ç—å—Å—è –≤ **–ø–æ–ª—è—Ä–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç** $(r, \\theta)$.
    –ö–æ–∂–Ω–∞ —Ç–æ—á–∫–∞ –º–∞–Ω–¥–∞–ª–∏ –º–∞—î:
    * **–†–∞–¥—ñ—É—Å $r$** (–≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É).
    * **–ö—É—Ç $\\theta$** (–Ω–∞–ø—Ä—è–º–æ–∫ –ø–æ–≤–æ—Ä–æ—Ç—É –≤—ñ–¥ $0$ –¥–æ $2\pi$).
    """)
    
    st.info("–£—Å—ñ —Ñ–æ—Ä–º—É–ª–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ —Ç–∞–∫, —â–æ–± –º–∞–ª—é–Ω–æ–∫ –∑–∞–≤–∂–¥–∏ –±—É–≤ –≥–∞—Ä–º–æ–Ω—ñ–π–Ω–∏–º, –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –≤–≤–µ–¥–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö.")
    st.markdown("---")

    # --- 1. –ú–ê–°–®–¢–ê–ë–£–í–ê–ù–ù–Ø ---
    st.subheader("1. –ú–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è")
    st.write("–©–æ–± –º–∞–Ω–¥–∞–ª–∞ –ø–æ–º—ñ—Å—Ç–∏–ª–∞—Å—è –Ω–∞ –µ–∫—Ä–∞–Ω—ñ, –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–æ–ª–æ–≤–Ω—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –º–∞—Å—à—Ç–∞–±—É.")
    st.latex(r"SCALE = 0.12")
    st.write("""
    –¶–µ "–æ–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É" –Ω–∞—à–æ–≥–æ —Å–≤—ñ—Ç—É. –í—Å—ñ —ñ–Ω—à—ñ —Ä–æ–∑–º—ñ—Ä–∏ —Ä–∞—Ö—É—é—Ç—å—Å—è –≤—ñ–¥ –Ω–µ—ó:
    * –Ø–∫—â–æ –º–∏ –ø–∏—à–µ–º–æ —É —Ñ–æ—Ä–º—É–ª—ñ $2.0$, —Ü–µ –æ–∑–Ω–∞—á–∞—î $2.0 * SCALE$.
    * –¶–µ –¥–æ–∑–≤–æ–ª—è—î –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä —É—Å—ñ—î—ó –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∑–º—ñ–Ω–∏–≤—à–∏ –ª–∏—à–µ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É –≤ –∫–æ–¥—ñ.
    """)

    # --- 2. –Ø–î–†–û ---
    st.subheader("2. –Ø–¥—Ä–æ")
    st.write("–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ –∫–æ–ª–æ (–∞–±–æ –∫—ñ–ª—å—Ü–µ) –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–æ–≥–æ, —Å–∫—ñ–ª—å–∫–∏ –ª—é–¥–∏–Ω–∞ —Å–ø–∏—Ç—å.")
    st.latex(r"r = R_{base} \cdot \left( 1 - \frac{S}{12} \right)")
    st.write("""
    * **$S$** ‚Äî –≥–æ–¥–∏–Ω–∏ —Å–Ω—É (–∑–º—ñ–Ω–Ω–∞).
    * **$12$** ‚Äî –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –Ω–æ—Ä–º–∞ —Å–Ω—É).
    * **$R_{base} = 2.0$** ‚Äî –±–∞–∑–æ–≤–∏–π —Ä–∞–¥—ñ—É—Å —è–¥—Ä–∞.
    """)

    # --- 3. –ó–Ü–†–ö–ê ---
    st.subheader("3. –ó—ñ—Ä–∫–∞")
    st.write("–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫–ª–∞—Å–∏—á–Ω–∞ **–¢—Ä–æ—è–Ω–¥–∞ –ì–≤—ñ–¥–æ –ì—Ä–∞–Ω–¥—ñ**.")
    st.latex(r"r(\theta) = a \cdot \cos(d \cdot \theta)")
    st.write("""
    * **$d$ (–î–µ–Ω—å)** ‚Äî —Ü–µ —á–∞—Å—Ç–æ—Ç–∞. –î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –≤–∏–∑–Ω–∞—á–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ–º–µ–Ω—ñ–≤.
    * **$a = 0.25$** ‚Äî —Ü–µ –∞–º–ø–ª—ñ—Ç—É–¥–∞ (–≤–∏—Å–æ—Ç–∞) —Ö–≤–∏–ª—ñ. –ú–∏ –∑–∞—Ñ—ñ–∫—Å—É–≤–∞–ª–∏ —Ü–µ —á–∏—Å–ª–æ, —â–æ–± –∑—ñ—Ä–∫–∞ –Ω–µ –±—É–ª–∞ –∑–∞–Ω–∞–¥—Ç–æ –≥–æ—Å—Ç—Ä–æ—é.
    """)

    # --- 4. –ü–ï–õ–Æ–°–¢–ö–ò ---
    st.subheader("4. –ö–≤—ñ—Ç–∫–∞")
    st.write("–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –º–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω–µ —Ä—ñ–≤–Ω—è–Ω–Ω—è **–¢—Ä–æ—è–Ω–¥–∏ –ì–≤—ñ–¥–æ –ì—Ä–∞–Ω–¥—ñ**.")
    st.latex(r"r(\theta) = |\cos(k \cdot \theta)|^p")
    st.write("""
    * **$k = n/2$** ‚Äî –º—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –¥—ñ–ª–∏–º–æ –Ω–∞–≤–ø—ñ–ª, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–µ–ª—é—Å—Ç–æ–∫.
    * **$p$ (–°—Ç–µ–ø—ñ–Ω—å)** ‚Äî –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –í–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ ($E$).
        * –§–æ—Ä–º—É–ª–∞: $p = (11 - E) / 2$.
        * –ß–∏–º –±—ñ–ª—å—à–µ $E$, —Ç–∏–º –º–µ–Ω—à–∏–π —Å—Ç–µ–ø—ñ–Ω—å $p$, —ñ —Ç–∏–º "—à–∏—Ä—à—ñ" –ø–µ–ª—é—Å—Ç–∫–∏.
    """)

    # --- 5. –°–ü–Ü–†–ê–õ–¨ ---
    st.subheader("5. –°–ø—ñ—Ä–∞–ª—å")
    st.write("–¶–µ **–°–ø—ñ—Ä–∞–ª—å –§–µ—Ä–º–∞** (–º–æ–¥–µ–ª—å —Å–æ–Ω—è—à–Ω–∏–∫–∞). –ö–æ–∂–Ω–∏–π –∫—Ä—É–≥ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –æ–¥–∏–Ω —Ä—ñ–∫ –∂–∏—Ç—Ç—è.")
    st.latex(r"r = c \cdot \sqrt{n}, \quad \theta = n \cdot 137.5^\circ")
    st.write("""
    * **$n$** ‚Äî –Ω–æ–º–µ—Ä —Ä–æ–∫—É (–≤—ñ–¥ 1 –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤—ñ–∫—É $A$).
    * **$137.5^\circ$** ‚Äî **–ó–æ–ª–æ—Ç–∏–π –∫—É—Ç**. –¶–µ –∫—É—Ç, —è–∫–∏–π –∑–∞–±–µ–∑–ø–µ—á—É—î –Ω–∞–π–±—ñ–ª—å—à –µ—Ñ–µ–∫—Ç–∏–≤–Ω–µ —É–ø–∞–∫—É–≤–∞–Ω–Ω—è –Ω–∞—Å—ñ–Ω–Ω—è –≤ —Å–æ–Ω—è—à–Ω–∏–∫—É.
    """)
    st.write("**–†–æ–∑–º—ñ—Ä –∫—Ä—É–≥—ñ–≤:**")
    st.latex(r"Size \approx Base + (8 \cdot T)")
    st.write("""
    * **$T$ (–ï–Ω–µ—Ä–≥—ñ—è)** ‚Äî –≤–∏–∑–Ω–∞—á–∞—î –¥—ñ–∞–º–µ—Ç—Ä –∫–æ–∂–Ω–æ—ó —Ç–æ—á–∫–∏.
    * –ß–∏–º –≤–∏—â–∏–π —Ä—ñ–≤–µ–Ω—å –µ–Ω–µ—Ä–≥—ñ—ó, —Ç–∏–º "–ø–æ–º—ñ—Ç–Ω—ñ—à—ñ" —Ç–∞ –∑–Ω–∞—á—É—â—ñ—à—ñ —Ä–æ–∫–∏ –Ω–∞ –º–∞–ª—é–Ω–∫—É (–∫—Ä—É–≥–∏ —Å—Ç–∞—é—Ç—å –±—ñ–ª—å—à–∏–º–∏).
    """)
   
    # --- 6. –†–ê–î–ê–† ---
    st.subheader("6. –°—ñ—Ç–∫–∞")
    st.write("–ù–∞–≤–∫–æ–ª–æ –∫–≤—ñ—Ç–∫–∏ —Ä–æ–∑–≥–æ—Ä—Ç–∞—î—Ç—å—Å—è –ø–æ–ª—è—Ä–Ω–∞ —Å—ñ—Ç–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, —Å—Ö–æ–∂–∞ –Ω–∞ –∫–∞—Ä—Ç—É —Å–≤—ñ—Ç—É.")
    st.write("**–ê. –ü—Ä–æ–º–µ–Ω—ñ:**")
    st.write("–¶–µ –ª—ñ–Ω—ñ—ó –Ω–∞–ø—Ä—è–º—É –¥—ñ—ó. –á—Ö –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ **–ï–Ω–µ—Ä–≥—ñ—ó ($T$)**.")
    st.latex(r"N_{rays} \approx 4 \cdot T + 4")
    st.write("–ß–∏–º –±—ñ–ª—å—à–µ –µ–Ω–µ—Ä–≥—ñ—ó –º–∞—î –ª—é–¥–∏–Ω–∞, —Ç–∏–º –≥—É—Å—Ç—ñ—à–∞ —Å—ñ—Ç–∫–∞, —â–æ —Å–∏–º–≤–æ–ª—ñ–∑—É—î –±—ñ–ª—å—à—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞–Ω–∞–ª—ñ–≤ –¥–ª—è –≤–∑–∞—î–º–æ–¥—ñ—ó –∑—ñ —Å–≤—ñ—Ç–æ–º.")
    st.write("**–ë. –ö—ñ–ª—å—Ü—è:**")
    st.write("–¶–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—á–Ω—ñ –∫–æ–ª–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è ($r = const$).")
    st.write("–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–∞–∫–∏—Ö –∫—ñ–ª –∑–∞–≤–∂–¥–∏ 7 —ñ –≤–æ–Ω–∏ —Ä–æ–±–ª—è—Ç—å –º–∞–Ω–¥–∞–ª—É –±—ñ–ª—å—à –≥–∞—Ä–º–æ–Ω—ñ–π–Ω–æ—é.")
    
   # --- 7. –ú–ï–ñ–ê ---
    st.subheader("7. –ú–µ–∂–∞ (–ï–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∞)")
    st.write("–ó–æ–≤–Ω—ñ—à–Ω—ñ–π –∫–æ–Ω—Ç—É—Ä ‚Äî —Ü–µ **–ï–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∞**. –¶–µ –∫—Ä–∏–≤–∞, —è–∫—É –æ–ø–∏—Å—É—î —Ç–æ—á–∫–∞, –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–∞ –Ω–∞ –∫–æ–ª—ñ, —â–æ –∫–æ—Ç–∏—Ç—å—Å—è –ø–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π —Å—Ç–æ—Ä–æ–Ω—ñ —ñ–Ω—à–æ–≥–æ –Ω–µ—Ä—É—Ö–æ–º–æ–≥–æ –∫–æ–ª–∞.")
    
    st.latex(r"x(\theta) = (R + r) \cos \theta - d \cos \left( \frac{R+r}{r} \theta \right)")
    st.latex(r"y(\theta) = (R + r) \sin \theta - d \sin \left( \frac{R+r}{r} \theta \right)")
    
    st.write("""
    –¶–µ –º–µ—Ç–∞—Ñ–æ—Ä–∞ –≤–∑–∞—î–º–æ–¥—ñ—ó "–Ø" (–º–∞–ª–µ –∫–æ–ª–æ) —ñ "–°–≤—ñ—Ç" (–≤–µ–ª–∏–∫–µ –∫–æ–ª–æ).
    
    * **$R$ (–°–≤—ñ—Ç):** –í–µ–ª–∏–∫–µ –∫–æ–ª–æ, —Ä–∞–¥—ñ—É—Å —è–∫–æ–≥–æ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ä–æ–∑–º—ñ—Ä—É –≤–∞—à–æ—ó –º–∞–Ω–¥–∞–ª–∏.
    * **$r$ (–Ø):** –ú–∞–ª–µ –∫–æ–ª–æ. –°–ø—ñ–≤–≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—è $R/r$ –≤–∏–∑–Ω–∞—á–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–µ–ª—é—Å—Ç–æ–∫ (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ **–ó—Ä–æ—Å—Ç—É**).
    * **$d$ (–•–∞—Ä–∞–∫—Ç–µ—Ä –¥–æ—Ç–∏–∫—É):** –í—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É –º–∞–ª–æ–≥–æ –∫–æ–ª–∞ –¥–æ –ø–µ—Ä–∞.
        * **–î–ª—è —á–æ–ª–æ–≤—ñ–∫—ñ–≤ ($d \approx r$):** –£—Ç–≤–æ—Ä—é—î—Ç—å—Å—è **–ï–ø—ñ—Ü–∏–∫–ª–æ—ó–¥–∞** –∑ –≥–æ—Å—Ç—Ä–∏–º–∏ –≤–µ—Ä—à–∏–Ω–∞–º–∏ (–∞–∫—Ç–∏–≤–Ω–∏–π, —Ä—ñ–∑–∫–∏–π –∫–æ–Ω—Ç–∞–∫—Ç).
        * **–î–ª—è –∂—ñ–Ω–æ–∫ ($d < r$):** –£—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –ø–ª–∞–≤–Ω–∞ —Ö–≤–∏–ª—è (–º'—è–∫–∏–π, –∞–¥–∞–ø—Ç–∏–≤–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç).
    """)

    # --- 8. –¢–ï–ú–ü–ï–†–ê–ú–ï–ù–¢ ---
    st.subheader("8. –ì—Ä–∞—Ñ—ñ—á–Ω–∞ —Ñ—ñ–∑–∏–∫–∞")
    st.write("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç –≤–∏–∑–Ω–∞—á–∞—î '–≤–∞–≥—É' —Ç–∞ '–ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å' –ª—ñ–Ω—ñ–π:")
    st.write("""
    * **–•–æ–ª–µ—Ä–∏–∫:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —Ç–æ–≤—â–∏–Ω–∞, –ø–æ–≤–Ω–∞ –Ω–µ–ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å.
    * **–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫:** –°–µ—Ä–µ–¥–Ω—è —Ç–æ–≤—â–∏–Ω–∞, –≤–∏—Å–æ–∫–∞ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å.
    * **–§–ª–µ–≥–º–∞—Ç–∏–∫:** –ú–∞—Å–∏–≤–Ω—ñ –ª—ñ–Ω—ñ—ó, –∞–ª–µ –∑–Ω–∞—á–Ω–∞ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å.
    * **–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫:** –¢–æ–Ω–∫—ñ, –¥–µ–ª—ñ–∫–∞—Ç–Ω—ñ –ª—ñ–Ω—ñ—ó.
    """)

with tab1:
    # –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø
    st.sidebar.header("üìã –¢–≤–æ—ó –¥–∞–Ω—ñ")
    with st.sidebar:
        # –ì—Ä—É–ø–∞ 1: –ë–∞–∑–æ–≤—ñ –¥–∞–Ω—ñ
        n = st.number_input("–ú—ñ—Å—è—Ü—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 12, 6)
        d = st.number_input("–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è", 1, 31, 15)
        
        H = st.slider("–ó—Ä—ñ—Å—Ç (—Å–º)", 100, 220, 170)
        A = st.slider("–í—ñ–∫", 10, 100, 45)
        S = st.slider("–ì–æ–¥–∏–Ω —Å–Ω—É", 0, 12, 8)
        
        st.markdown("---")
        # –ì—Ä—É–ø–∞ 2: –ü—Å–∏—Ö–æ–ª–æ–≥—ñ—è
        E = st.slider("–í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å", 0, 10, 5)
        T = st.slider("–ï–Ω–µ—Ä–≥—ñ—è", 1, 10, 5)
        
        st.markdown("---")
        # –ì—Ä—É–ø–∞ 3: –°—Ç–∏–ª—å
        G = st.radio("–°—Ç–∞—Ç—å", options=[1, -1], format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞" if x == 1 else "–ñ—ñ–Ω–æ—á–∞")
        temp = st.selectbox("–¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç", options=["–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫", "–•–æ–ª–µ—Ä–∏–∫", "–§–ª–µ–≥–º–∞—Ç–∏–∫", "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫"])
        eye_choice = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", options=[1, 2, 3, 4], 
                                  format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])

    # –ì–ï–ù–ï–†–ê–¶–Ü–Ø
    def generate_mandala(phase=0):
        # –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤
        style_map = {
            "–°–∞–Ω–≥–≤—ñ–Ω—ñ–∫": {"lw": 2.0, "alpha": 0.8},
            "–•–æ–ª–µ—Ä–∏–∫":   {"lw": 4.5, "alpha": 1.0}, 
            "–§–ª–µ–≥–º–∞—Ç–∏–∫": {"lw": 5.0, "alpha": 0.3}, 
            "–ú–µ–ª–∞–Ω—Ö–æ–ª—ñ–∫": {"lw": 1.0, "alpha": 0.7} 
        }
        s = style_map[temp]
        selected_cmap = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}.get(eye_choice, cm.plasma)
        
        t = np.linspace(0, 2 * np.pi, 5000)
        fig = plt.figure(figsize=(10, 10), facecolor='black') # <--- –ó–ë–Ü–õ–¨–®–ò–õ–ò –†–û–ó–ú–Ü–† –ü–û–õ–û–¢–ù–ê (8->10)
        ax = plt.subplot(111, projection='polar')
        ax.set_facecolor('black')
        
        SCALE = 0.12 
        
        # === –î–ò–ù–ê–ú–Ü–ö–ê ===
        # breath –∑–º—ñ–Ω—é—î—Ç—å—Å—è –≤—ñ–¥ 0.95 –¥–æ 1.05 (–µ—Ñ–µ–∫—Ç –ø—É–ª—å—Å–∞—Ü—ñ—ó)
        breath = 1.0 + 0.05 * np.sin(phase)
        
        # === 1. –Ø–î–†–û (–°–û–ù S) ===
        R_core = 2.0 * SCALE * breath
        r_hole = R_core * max(0.0, 1 - (S / 12.0))
        
        ax.fill_between(t, r_hole, R_core, color=selected_cmap(0.9), alpha=s["alpha"])
        ax.plot(t, np.full_like(t, r_hole), color='white', linewidth=s["lw"]*0.3, alpha=0.5)

        # === 2. –ó–Ü–†–ö–ê (–î–ï–ù–¨ –ù–ê–†–û–î–ñ–ï–ù–ù–Ø d) ===
        R_layer2 = R_core + 0.3 * SCALE
        # –ó—ñ—Ä–∫–∞ –ø–æ–≤—ñ–ª—å–Ω–æ –æ–±–µ—Ä—Ç–∞—î—Ç—å—Å—è (+ phase/20)
        r_star = R_layer2 + 0.25 * SCALE * np.cos(d * (t + phase/20))
        ax.plot(t, r_star, color=selected_cmap(0.7), linewidth=s["lw"], alpha=s["alpha"])

        # === 3. –ü–ï–õ–Æ–°–¢–ö–ò (–ú–Ü–°–Ø–¶–¨ n) ===
        R_rose_base = R_layer2 + 0.5 * SCALE
        e_val = (11 - E) / 2
        r_rose = R_rose_base + (np.abs(np.cos(n/2 * t)))**e_val * 2.5 * SCALE
        
        ax.fill(t, r_rose, color=selected_cmap(0.3), alpha=0.3)
        ax.plot(t, r_rose, color=selected_cmap(0.4), linewidth=s["lw"], alpha=s["alpha"])

       # === 4. –ù–ê–°–ò–ß–ï–ù–ê –°–Ü–¢–ö–ê (–ï–ù–ï–†–ì–Ü–Ø T) ===
        max_r_rose = r_rose.max()
        
        # –§—ñ–∫—Å–æ–≤–∞–Ω–∞ —à–∏—Ä–∏–Ω–∞ —Å—ñ—Ç–∫–∏ (4.0 –æ–¥–∏–Ω–∏—Ü—ñ –º–∞—Å—à—Ç–∞–±—É)
        r_grid_end = max_r_rose + 4.0 * SCALE 
        
        # –†–∞–¥—ñ–∞–ª—å–Ω—ñ –ø—Ä–æ–º–µ–Ω—ñ (–∑–∞–ª–µ–∂–∞—Ç—å –≤—ñ–¥ T)
        num_rays = int(T * 4) + 4
        for i in range(num_rays):
            angle = (2 * np.pi / num_rays) * i + (phase / 50) 
            ax.plot([angle, angle], [max_r_rose, r_grid_end], 
                    color=selected_cmap(0.6), 
                    linewidth=s["lw"] * 0.6, 
                    alpha=s["alpha"] * 0.7,  
                    linestyle="-")

        # –ü–æ–ø–µ—Ä–µ—á–Ω—ñ –∫—ñ–ª—å—Ü—è (–°–¢–ê–ù–î–ê–†–¢–ù–ò–ô –ö–†–û–ö 0.6)
        r_ticks = np.arange(max_r_rose, r_grid_end, 0.6 * SCALE)
        for r_tick in r_ticks:
            ax.plot(t, np.full_like(t, r_tick), 
                    color=selected_cmap(0.5), 
                    linewidth=s["lw"] * 0.4, 
                    alpha=s["alpha"] * 0.5)

        # === 5. –°–ü–Ü–†–ê–õ–Ü –§–ï–†–ú–ê (–í–Ü–ö A) ===
        golden_angle = 2.39996323 
        spacing = 0.08 * SCALE 
        
        points_theta = []
        points_r = []
        colors = []
        sizes = []

        for i in range(1, A + 1):
            theta = i * golden_angle * G + (phase / 100)
            r = max_r_rose + spacing * np.sqrt(i) * 1.5
            
            points_theta.append(theta)
            points_r.append(r)
            colors.append(selected_cmap(i / A))
            
            base_size = 30 + (T * 8) 
            sizes.append(base_size * (s["lw"] * 0.8)) 

        ax.scatter(points_theta, points_r, c=colors, s=sizes, 
                   alpha=s["alpha"], cmap=selected_cmap, edgecolors='none')

       # === 6. –ú–ï–ñ–ê (–ï–ü–Ü–¢–†–û–•–û–á–î–ê) ===
        # –í–∏–∑–Ω–∞—á–∞—î–º–æ, –¥–µ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –º–µ–∂–∞ (–±–∞–∑–æ–≤–∏–π —Ä–∞–¥—ñ—É—Å)
        max_dist = max(points_r) if points_r else r_grid_end
        base_radius = max(r_grid_end, max_dist + 0.5 * SCALE)

        # –ü–ê–†–ê–ú–ï–¢–†–ò –ï–ü–Ü–¢–†–û–•–û–á–î–ò
        # N - –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–µ–ª—é—Å—Ç–æ–∫ (–∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∑—Ä–æ—Å—Ç—É H). 
        # –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∑—Ä—ñ—Å—Ç 170 -> 17 –ø–µ–ª—é—Å—Ç–æ–∫.
        N_lobes = int(H / 10)
        
        # –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:
        # –ï–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∞ —É—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∫–æ—á–µ–Ω–Ω—è–º –∫–æ–ª–∞ —Ä–∞–¥—ñ—É—Å–æ–º r_roll –ø–æ –∫–æ–ª—É R_fix.
        # –í—ñ–¥–Ω–æ—à–µ–Ω–Ω—è R_fix / r_roll = N_lobes –≤–∏–∑–Ω–∞—á–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–µ–ª—é—Å—Ç–æ–∫.
        # R_sum = R_fix + r_roll ‚Äî —Ü–µ –≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É –¥–æ —Ü–µ–Ω—Ç—Ä—É –º–∞–ª–æ–≥–æ –∫–æ–ª–∞.
        
        r_roll = base_radius / (N_lobes + 1)  # –†–∞–¥—ñ—É—Å –º–∞–ª–æ–≥–æ (—Ä—É—Ö–æ–º–æ–≥–æ) –∫–æ–ª–∞
        R_fix = r_roll * N_lobes              # –†–∞–¥—ñ—É—Å –≤–µ–ª–∏–∫–æ–≥–æ (–Ω–µ—Ä—É—Ö–æ–º–æ–≥–æ) –∫–æ–ª–∞
        
        # d_param - –≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ —Ü–µ–Ω—Ç—Ä—É –º–∞–ª–æ–≥–æ –∫–æ–ª–∞ –¥–æ —Ç–æ—á–∫–∏ –º–∞–ª—é–≤–∞–Ω–Ω—è (–ø–µ—Ä–æ).
        # –¶–µ –≤–∏–∑–Ω–∞—á–∞—î —Ñ–æ—Ä–º—É "–∑—É–±—Ü—ñ–≤":
        if G == 1: 
            # –ß–æ–ª–æ–≤—ñ—á–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç (–ï–ø—ñ—Ü–∏–∫–ª–æ—ó–¥–∞): —Ç–æ—á–∫–∞ –Ω–∞ –æ–±–æ–¥—ñ –∫–æ–ª–∞.
            # –î–∞—î –≥–æ—Å—Ç—Ä—ñ –≤–µ—Ä—à–∏–Ω–∏ (cusps).
            d_param = r_roll * 1.0 
        else:      
            # –ñ—ñ–Ω–æ—á–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç (–ü–æ–¥–æ–≤–∂–µ–Ω–∞ –µ–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∞): —Ç–æ—á–∫–∞ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–ª–∞.
            # –î–∞—î –ø–ª–∞–≤–Ω—ñ, —Ö–≤–∏–ª—è—Å—Ç—ñ –ª—ñ–Ω—ñ—ó.
            d_param = r_roll * 0.6 

        # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–æ—á–æ–∫ (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–Ω–µ —Ä—ñ–≤–Ω—è–Ω–Ω—è)
        # –ë–µ—Ä–µ–º–æ –±—ñ–ª—å—à–µ —Ç–æ—á–æ–∫ (2000) –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ
        t_epi = np.linspace(0, 2 * np.pi, 2000) 
        
        # –§–æ—Ä–º—É–ª–∏ –µ–ø—ñ—Ç—Ä–æ—Ö–æ—ó–¥–∏ (—É –¥–µ–∫–∞—Ä—Ç–æ–≤–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö)
        # –î–æ–¥–∞—î–º–æ phase –¥–æ t_epi –¥–ª—è –æ–±–µ—Ä—Ç–∞–Ω–Ω—è –≤—Å—ñ—î—ó —Ñ—ñ–≥—É—Ä–∏
        x = (R_fix + r_roll) * np.cos(t_epi + phase/30) - d_param * np.cos(((R_fix + r_roll) / r_roll) * (t_epi + phase/30))
        y = (R_fix + r_roll) * np.sin(t_epi + phase/30) - d_param * np.sin(((R_fix + r_roll) / r_roll) * (t_epi + phase/30))
        
        # –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞–∑–∞–¥ —É –ø–æ–ª—è—Ä–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è Matplotlib
        r_epi = np.sqrt(x**2 + y**2)
        theta_epi = np.arctan2(y, x)
        
        # –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∫—É—Ç—ñ–≤, —â–æ–± –≥—Ä–∞—Ñ—ñ–∫ –º–∞–ª—é–≤–∞–≤—Å—è –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ (—É–Ω–∏–∫–Ω–µ–Ω–Ω—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤)
        sort_idx = np.argsort(theta_epi)
        
        # –ú–∞–ª—é—î–º–æ
        # –î–æ–¥–∞—î–º–æ breath –¥–æ —Ä–∞–¥—ñ—É—Å–∞ –¥–ª—è –ø—É–ª—å—Å–∞—Ü—ñ—ó
        ax.plot(theta_epi[sort_idx], r_epi[sort_idx] * breath, 
                color=selected_cmap(0.9), 
                linewidth=s["lw"] * 1.5,
                alpha=s["alpha"])

    # –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.write("### –ö–µ—Ä—É–≤–∞–Ω–Ω—è")
        run_anim = st.checkbox("üåÄ –£–≤—ñ–º–∫–Ω—É—Ç–∏ '–î–∏—Ö–∞–Ω–Ω—è'", value=False)
        
        if not run_anim:
            st.info("–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –≥–∞–ª–æ—á–∫—É, —â–æ–± –æ–∂–∏–≤–∏—Ç–∏ –º–∞–Ω–¥–∞–ª—É.")
            # –ö–Ω–æ–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ –≤ —Å—Ç–∞—Ç–∏—á–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ
            fig_static = generate_mandala(phase=0)
            buf = io.BytesIO()
            fig_static.savefig(buf, format="png", facecolor='black', dpi=300)
            st.download_button("üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG", buf.getvalue(), "mandala.png", "image/png")
            plt.close(fig_static)

    with col2:
        placeholder = st.empty()
        
        if run_anim:
            # –¶–∏–∫–ª –∞–Ω—ñ–º–∞—Ü—ñ—ó
            for i in range(200):
                fig = generate_mandala(phase=i * 0.8)
                placeholder.pyplot(fig)
                plt.close(fig) 
                time.sleep(0.05)
        else:
            # –°—Ç–∞—Ç–∏—á–Ω–∏–π —Ä–µ–∂–∏–º
            fig = generate_mandala(phase=0)
            placeholder.pyplot(fig)
            plt.close(fig)
