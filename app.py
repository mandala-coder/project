import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from matplotlib import cm
import time

# 1. –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø –°–¢–û–†–Ü–ù–ö–ò
st.set_page_config(page_title="–ú–∞–Ω–¥–∞–ª–∞ –£-–°–Ü–ù", layout="wide")

# 2. –ü–û–°–õ–Ü–î–û–í–ù–Ü–°–¢–¨ –¢–ê –õ–û–ì–Ü–ö–ê –£-–°–Ü–ù
# –¶–∏–∫–ª –¢–≤–æ—Ä–µ–Ω–Ω—è: –î–µ—Ä–µ–≤–æ -> –í–æ–≥–æ–Ω—å -> –ó–µ–º–ª—è -> –ú–µ—Ç–∞–ª -> –í–æ–¥–∞
ELEMENTS = ["–î–µ—Ä–µ–≤–æ", "–í–æ–≥–æ–Ω—å", "–ó–µ–º–ª—è", "–ú–µ—Ç–∞–ª", "–í–æ–¥–∞"]
DESCRIPTIONS = [
    "–†—ñ—Å—Ç, –≥–Ω—É—á–∫—ñ—Å—Ç—å, –ø–µ—á—ñ–Ω–∫–∞",
    "–ï–Ω–µ—Ä–≥—ñ—è, —Å–µ—Ä—Ü–µ, –µ–º–æ—Ü—ñ—ó",
    "–ë–∞–ª–∞–Ω—Å, —Ç—Ä–∞–≤–ª–µ–Ω–Ω—è, —Ü–µ–Ω—Ç—Ä",
    "–°—Ç—Ä—É–∫—Ç—É—Ä–∞, –ª–µ–≥–µ–Ω—ñ, –¥–æ—Å–≤—ñ–¥",
    "–†–µ—Å—É—Ä—Å, –Ω–∏—Ä–∫–∏, –≤–æ–ª—è"
]

def get_wuxing_values(day, month):
    # –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª —Å–∏–ª –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞—Ç–∏
    base_idx = (day + month) % 5
    values = [1.2] * 5
    values[base_idx] = 2.0  # –ê–∫—Ü–µ–Ω—Ç
    values[(base_idx + 1) % 5] = 1.6  # –ü—ñ–¥—Ç—Ä–∏–º–∫–∞
    return values

# 3. –Ü–ù–¢–ï–†–§–ï–ô–°
st.sidebar.header("üì• –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏")
with st.sidebar:
    eye_color = st.selectbox("–ö–æ–ª—ñ—Ä –æ—á–µ–π", [1, 2, 3, 4], 
                             format_func=lambda x: {1:"–ë–ª–∞–∫–∏—Ç–Ω—ñ", 2:"–ó–µ–ª–µ–Ω—ñ", 3:"–ö–∞—Ä—ñ", 4:"–Ø–Ω—Ç–∞—Ä–Ω—ñ"}[x])
    G = st.radio("–°—Ç–∞—Ç—å (–§–æ—Ä–º–∞ –º–µ–∂—ñ)", [1, -1], format_func=lambda x: "–ß–æ–ª–æ–≤—ñ—á–∞ (–ì–æ—Å—Ç—Ä–∞)" if x == 1 else "–ñ—ñ–Ω–æ—á–∞ (–ú'—è–∫–∞)")
    st.markdown("---")
    d = st.number_input("–î–µ–Ω—å", 1, 31, 12)
    m = st.number_input("–ú—ñ—Å—è—Ü—å", 1, 12, 5)
    age = st.slider("–í—ñ–∫ (–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–¥—ñ–π)", 1, 100, 30)
    st.markdown("---")
    run_anim = st.checkbox("üåÄ –ñ–∏–≤–∞ –º–∞–Ω–¥–∞–ª–∞", value=True)

# 4. –§–£–ù–ö–¶–Ü–Ø –ì–ï–ù–ï–†–ê–¶–Ü–á
def generate_mandala(phase=0):
    w_values = get_wuxing_values(d, m)
    LW = 2.0  # –û–¥–Ω–∞–∫–æ–≤–∞ —Ç–æ–≤—â–∏–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –ª—ñ–Ω—ñ–π
    cmap = {1: cm.winter, 2: cm.summer, 3: cm.autumn, 4: cm.spring}[eye_color]
    
    fig = plt.figure(figsize=(10, 10), facecolor='black')
    ax = plt.subplot(111, projection='polar')
    ax.set_facecolor('black')
    
    t = np.linspace(0, 2 * np.pi, 500)

    # --- 1. –ü–õ–ê–í–ù–ï –Ø–î–†–û –£-–°–Ü–ù (–ó–≥–ª–∞–¥–∂–µ–Ω–∏–π –ø'—è—Ç–∏–∫—É—Ç–Ω–∏–∫) ---
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—É–º—É –≥–∞—Ä–º–æ–Ω—ñ–∫ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–ª–∞–≤–Ω–æ—ó –∑–∞–º–∫–Ω–µ–Ω–æ—ó —Ñ–æ—Ä–º–∏
    r_wuxing = np.zeros_like(t)
    for i, val in enumerate(w_values):
        # –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è: –∫–æ–∂–Ω–∞ –≤–µ—Ä—à–∏–Ω–∞ ‚Äî —Ü–µ "—Ö–≤–∏–ª—è"
        r_wuxing += val * np.exp(-((t - i * 2 * np.pi / 5)**2) / 0.5)
    
    # –ó–∞–º–∏–∫–∞—î–º–æ –∫—Ä–∞—ó –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ
    r_wuxing = 0.5 + 1.2 * (r_wuxing / np.max(r_wuxing))
    ax.plot(t, r_wuxing, color='white', lw=LW, alpha=0.9)
    ax.fill(t, r_wuxing, color=cmap(0.5), alpha=0.2)

    # --- 2. –ë–Ü–û–†–ò–¢–ú–ò (–°–∏–Ω—É—Å–æ—ó–¥–∏ —Å—Ç–∏—Ö—ñ–π) ---
    for i, val in enumerate(w_values):
        omega = (i + 1) * 0.5
        phi = phase + (i * np.pi / 2.5)
        # –ê–º–ø–ª—ñ—Ç—É–¥–∞ –æ–¥–Ω–∞–∫–æ–≤–∞, —á–∞—Å—Ç–æ—Ç–∞ —Ä—ñ–∑–Ω–∞
        r_wave = 2.5 + 0.3 * np.sin(omega * t + phi)
        ax.plot(t, r_wave, color=cmap(i/5), lw=LW, alpha=0.6)

    # --- 3. –î–û–°–í–Ü–î (–°–ø—ñ—Ä–∞–ª—å –§–µ—Ä–º–∞) ---
    indices = np.arange(1, age + 1)
    phi_gold = 2.39996 
    theta_f = indices * phi_gold + phase * 0.05
    r_f = 0.18 * np.sqrt(indices)
    ax.scatter(theta_f, r_f, s=40, color='white', edgecolors=cmap(0.3), alpha=0.8, lw=0.5)

    # --- 4. –ú–ï–ñ–ê (–ï–ø—ñ—Ü–∏–∫–ª–æ—ó–¥–∞) ---
    p = 0.6 if G == 1 else 1.4
    N = 10
    r_border = 4.2 + 0.3 * (np.abs(np.sin(N * t)))**p
    ax.plot(t, r_border, color=cmap(0.95), lw=LW)

    ax.set_ylim(0, 5.2)
    ax.set_axis_off()
    return fig

# 5. –í–ö–õ–ê–î–ö–ò
tab1, tab2 = st.tabs(["‚ú® –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ú–∞–Ω–¥–∞–ª–∏", "üìê –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è"])

with tab1:
    placeholder = st.empty()
    if run_anim:
        for i in range(100):
            fig = generate_mandala(phase=i*0.1)
            placeholder.pyplot(fig)
            plt.close(fig)
            time.sleep(0.05)
    else:
        st.pyplot(generate_mandala())

with tab2:
    st.header("–ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ")
    
    st.subheader("1. –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –¢–≤–æ—Ä–µ–Ω–Ω—è (–£-–°–Ü–ù)")
    st.write("–ö–æ–∂–Ω–∞ —Å—Ç–∏—Ö—ñ—è ‚Äî —Ü–µ –µ—Ç–∞–ø –µ–Ω–µ—Ä–≥–µ—Ç–∏—á–Ω–æ–≥–æ —Ü–∏–∫–ª—É, —â–æ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —É –≤–∞—à—ñ–π –ø—Å–∏—Ö–æ–º–∞—Ç—Ä–∏—Ü—ñ.")
    cols = st.columns(5)
    for i, name in enumerate(ELEMENTS):
        cols[i].metric(name, f"–Ü–Ω–¥–µ–∫—Å {i}")
        cols[i].caption(DESCRIPTIONS[i])

    st.markdown("---")
    
    st.subheader("2. –û–ø–∏—Å –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∏—Ö –∫—Ä–∏–≤–∏—Ö")
    
    st.write("**–ê. –Ø–¥—Ä–æ (–ó–≥–ª–∞–¥–∂–µ–Ω–∏–π –ø'—è—Ç–∏–∫—É—Ç–Ω–∏–∫):**")
    st.latex(r"r(\theta) = \sum_{i=0}^{4} V_i \cdot e^{-\frac{(\theta - \theta_i)^2}{2\sigma^2}}")
    st.write("–î–ª—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ –º–∞–Ω–¥–∞–ª–∏ –∑–∞–º—ñ—Å—Ç—å –ª–∞–º–∞–Ω–∏—Ö –ª—ñ–Ω—ñ–π –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –ì–∞—É—Å—Å–æ–≤–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è –≤–µ—Ä—à–∏–Ω –ø'—è—Ç–∏–∫—É—Ç–Ω–∏–∫–∞.")
    

    st.write("**–ë. –ë—ñ–æ—Ä–∏—Ç–º–∏ (–ì–∞—Ä–º–æ–Ω—ñ—á–Ω—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è):**")
    st.latex(r"r_{wave} = R_{offset} + A \cdot \sin(\omega_i t + \phi)")
    st.write("–ö–æ–∂–Ω–∞ —Å—Ç–∏—Ö—ñ—è –º–∞—î –≤–ª–∞—Å–Ω—É —á–∞—Å—Ç–æ—Ç—É $\omega$, —â–æ —Å—Ç–≤–æ—Ä—é—î —ñ–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü—ñ–π–Ω—É –∫–∞—Ä—Ç–∏–Ω—É –≤–∞—à–æ–≥–æ —Å—Ç–∞–Ω—É.")
    

    st.write("**–í. –ü–æ–ª–µ –¥–æ—Å–≤—ñ–¥—É (–°–ø—ñ—Ä–∞–ª—å –§–µ—Ä–º–∞):**")
    st.latex(r"r = c\sqrt{k}, \quad \theta = k \cdot \psi")
    st.write("–¢–æ—á–∫–∏ (–ø–æ–¥—ñ—ó) —Ä–æ–∑–º—ñ—â–µ–Ω—ñ –∑–∞ –ø—Ä–∞–≤–∏–ª–æ–º –ó–æ–ª–æ—Ç–æ–≥–æ –∫—É—Ç–∞ $\psi \approx 137.5^\circ$, —â–æ –∑–∞–±–µ–∑–ø–µ—á—É—î —ñ–¥–µ–∞–ª—å–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ—Ä—É.")

    st.write("**–ì. –ó–∞—Ö–∏—Å–Ω–∞ –º–µ–∂–∞ (–ï–ø—ñ—Ü–∏–∫–ª–æ—ó–¥–∞):**")
    st.latex(r"r = R_{base} + A \cdot |\sin(N\theta)|^p")
    st.write(f"–ü–∞—Ä–∞–º–µ—Ç—Ä **–°—Ç–∞—Ç—ñ (G)** –≤–∏–∑–Ω–∞—á–∞—î –ø–æ–∫–∞–∑–Ω–∏–∫ $p$: –ø—Ä–∏ $p={0.6 if G==1 else 1.4}$ –º–µ–∂–∞ –Ω–∞–±—É–≤–∞—î {'–≥–æ—Å—Ç—Ä–æ—ó' if G==1 else '–º‚Äô—è–∫–æ—ó'} —Ñ–æ—Ä–º–∏.")
